!function(t,e,i,s){var n=i.Application.extend({model:{},view:{},controller:{},service:{},template:{},config:function(t){this.config=t},onBeforeStart:function(){var t=this.template,i=e('[type="text/template"]');i.each(function(e){t[this.id]=this.innerHTML}),i.remove(),i=e('[type="text/x-handlebars-template"]'),i.each(function(e){t[this.id]=s.compile(this.innerHTML)}),i.remove()}});t.Application=new n}(window,jQuery,Marionette,Handlebars),function(t,e,i){t.SoundPlayer=function(){this.play=function(t){};var t=[];this.addSounds=function(e){t.push(e)};var s=this;e.setup({url:i.rootPath+"swf/",onready:function(){if(s.play=function(t){e.play(t)},s.addSounds=function(t){for(var s in t)e.createSound({id:s,url:i.rootPath+t[s],autoLoad:!0,autoPlay:!1,volume:100})},s.addSounds({message:i.ui.messageSound}),s.addSounds({systemMessage:i.ui.systemMessageSound}),t.length>0)for(var n=0;n<t.length;n++)s.addSounds(t[n]);window.addEventListener("touchstart",function o(){window.removeEventListener("touchstart",o,!0),e.play("message"),e.stopAll()},!0)}})}}(window.Application,soundManager,chatConfig),function(t,e,i){function s(t){return{countryCode:t.country_code,countryName:t.country_name,regionCode:t.region_code,regionName:t.region_name,city:t.city,zipCode:t.zip_code,timeZone:t.time_zone,timeZone:t.time_zone,latitude:t.latitude,longitude:t.longitude,metroCode:t.metro_code,utcOffset:(new Date).getTimezoneOffset()}}function n(){return{countryCode:"",countryName:"",regionCode:"",regionName:"",city:"",zipCode:"",timeZone:"",timeZone:"",latitude:"",longitude:"",metroCode:"",utcOffset:(new Date).getTimezoneOffset()}}t.Geolocation=function(){this.info=n(),this.empty=!0;var t=this;this.requestInfo=function(n,o){o=o||"",i.get(e.geolocConfig.url+o,function(e){t.info=s(e),t.empty=!1}).always(function(){n&&n(t.info)})}}}(window.Application,window.chatConfig,window.jQuery),function(t,e){function i(){}i.prototype={constructor:i,send:function(t,e,i){e._t=Date.now();var s=t.indexOf("?")!==-1?"&":"?";if(e)for(var n in e)t+=s+n+"="+encodeURIComponent(e[n]),"?"===s&&(s="&");var o=new Image;o.onload=o.onerror=function(){i&&i(o.width),o.onload=o.onerror=null},o.src=t}},t.Beacon=i}(window.Application,window.chatConfig),function(t,e){t.service.i18n={trans:function(t,i){var s=e.trans[t];if("undefined"==typeof s)return"* "+t+" *";if(i)for(var n in i)s=s.split(n).join(i[n]);return s}}}(window.Application,window.chatConfig),function(t,e){t.GuestSettingsModel=Backbone.Model.extend({defaults:{sound:!0,scroll:!0,emots:!0,media:!0,show:!0,autoShow:!0},initialize:function(){this.fetch(),this.on("change",this.save,this)},save:function(){try{localStorage.setItem("customer-chat-settings",JSON.stringify(this.attributes))}catch(t){}},fetch:function(){var t=localStorage.getItem("customer-chat-settings");t&&this.set(JSON.parse(t))}})}(window.Application,jQuery),function(t,e,i){var s=t.UserModel=Backbone.Model.extend({initialize:function(t){if(t.info&&"string"==typeof t.info)try{t.info=JSON.parse(t.info)}catch(e){}},getAge:function(){this.chat=t.model.chat;var e=(new Date).getTime()/1e3,i=this.get("time").getTime()/1e3;return Math.ceil(e-i)},getReadableName:function(){var t=this.get("name");return this.hasRole("OPERATOR")?t:t.lastIndexOf("-")!==-1?t.slice(0,t.lastIndexOf("-")):t},hasRole:function(t){return this.has("roles")&&this.get("roles").indexOf(t)!==-1},isOnline:function(){var t=new Date(this.get("last_activity").replace(/-/g,"/"))/1e3-e.serverTimeDifference,i=(new Date).getTime()/1e3;return i-t<=s.ONLINE_TIME}},{ONLINE_TIME:30,usersCache:{},cacheUsers:function(e){for(var i=0;i<e.length;i++){var s=e[i];this.usersCache[s.id]=new t.UserModel(s)}},updateUsersCache:function(t){for(var e=0;e<t.length;e++){var i=t[e],s=i.get("id"),n=this.usersCache[s];n?n.set(i.attributes):this.usersCache[s]=i}},getUser:function(s,n){if(this.usersCache[s])return void n(this.usersCache[s]);var o=this;return i.get(e.getUsersPath,{ids:[s]},function(e){e.success&&(o.usersCache[s]=new t.UserModel(e.users[s]),n(o.usersCache[s]))}),!1},getUsers:function(s,n,o){for(var a={},r=[],l=0;l<s.length;l++){var h=s[l];this.usersCache[h]?a[h]=this.usersCache[h]:r.push(h)}if(0===r.length)return n(a),!0;var c=this;return i.get(e.getUsersPath,{ids:r},function(e){if(e.success){for(var i in e.users)c.usersCache[i]=a[i]=new t.UserModel(e.users[i]);n(a)}else o&&o(e)}),!1},getUserSync:function(t){return this.usersCache[t]},addShortUrl:function(t){var e=t.info&&t.info.referer;if(e){var i=e.split("/");i.splice(0,2),i.length>2?t.shortUrl=i[0]+"/../"+i.pop():t.shortUrl=i[0]+"/"+i.pop()}else t.shortUrl=""},extendUserData:function(t,e){this.addShortUrl(t);var i=t.info;if(i){t.url=i.referer,t.ip=i.ip;var s=i.geoloc;s?(t.countryCode=s.countryCode,t.countryName=s.countryName,t.city=s.city):(t.countryCode=null,t.countryName=null,t.city=null)}}});t.UserModel.usersCache[-1]=new t.UserModel({id:-1,name:"all"}),t.UserModel.usersCache[-2]=new t.UserModel({id:-2,type:"system",name:"SYSTEM"})}(window.Application,window.chatConfig,jQuery),function(t,e){var i=t.MessageModel=Backbone.Model.extend({defaults:{author:"",body:"",toAuthor:"all",toAuthorMail:""},initialize:function(e,s){if(this.options=s||{},e){if("string"==typeof e.datetime?this.set("time",new Date(e.datetime.replace(/-/g,"/"))):"object"==typeof e.datetime&&this.set("time",e.datetime),"string"==typeof e.from_user_info&&"all"!==e.from_user_info)try{e.from_user_info=JSON.parse(e.from_user_info)}catch(n){}if("object"==typeof e.from_user_info){var o=e.from_user_info;this.fromUser=o,0===this.get("author").length&&this.set("author",o.name),this.has("authorMail")||this.set("authorMail",o.mail)}if("string"==typeof e.to_user_info&&"all"!==e.to_user_info)try{e.to_user_info=JSON.parse(e.to_user_info)}catch(n){}if("object"==typeof e.to_user_info){var a=e.to_user_info;this.toUser=a,this.set("toAuthor",a.name),this.set("toAuthorMail",a.mail)}if(e.extra&&"string"==typeof e.extra)try{e.extra=JSON.parse(e.extra)}catch(n){}if(e.from_id==i.USER_ID_SYSTEM){this.set("authorType","system"),this.set("author","SYSTEM"),this.fromUser={name:"SYSTEM"};var r=this.getSystemMessageBody(e.extra);r&&(e.body=r)}if(e.extra&&e.extra.type===i.EXTRA_FILES)if(e.upload){var l=t.model.watchedUploads.get(e.upload.id);l?this.upload=l:this.upload=new t.UploadModel(e.upload),t.model.watchedUploads.add(this.upload)}else this.upload=new t.UploadModel({files_info:e.extra.files}),t.model.watchedUploads.add(this.upload);this.set(e)}},getAge:function(){var t=Math.floor((new Date).getTime()/1e3),i=Math.floor(this.get("time").getTime()/1e3-(this.options.localMessage?0:e.serverTimeDifference));return Math.ceil(t-i)},getTime:function(){return new Date(this.get("time").getTime()-(this.options.localMessage?0:1e3*e.serverTimeDifference))},getReadableName:function(){var t=this.get("author");return t.lastIndexOf("-")!==-1?t.slice(0,t.lastIndexOf("-")):t},getToUserReadableName:function(){var t=this.get("toAuthor");return t.lastIndexOf("-")!==-1?t.slice(0,t.lastIndexOf("-")):t},getTalkName:function(){var t=this.get("toAuthor");return this.getReadableName()+(t?"/"+(t.lastIndexOf("-")!==-1?t.slice(0,t.lastIndexOf("-")):t):"")},isSystemMessage:function(){return this.get("from_id")==i.USER_ID_SYSTEM},getSystemMessageBody:function(e){var s=t.service.i18n;switch(e.type){case i.EXTRA_TALK_CLOSE:return e.user?s.trans("sm.closed.talk",{"%user%":e.user}):s.trans("sm.user.closed.chat");case i.EXTRA_TALK_OWNER:return s.trans("sm.now.talk.owner",{"%user%":e.user});case i.EXTRA_USER_INVITE:return s.trans("sm.user.invited",{"%name%":e.name,"%mail%":e.mail});case i.EXTRA_USER_LEAVE:return s.trans("sm.user.left",{"%name%":e.name,"%mail%":e.mail})}return null}},{TO_ID_ALL:-1,USER_ID_SYSTEM:-2,EXTRA_USER_INVITE:"user_invite",EXTRA_USER_LEAVE:"user_leave",EXTRA_TALK_START:"talk_start",EXTRA_TALK_CLOSE:"talk_close",EXTRA_TALK_OWNER:"talk_owner",EXTRA_FILES:"files"})}(window.Application,window.chatConfig),function(t,e,i){t.SharedFileModel=Backbone.Model.extend({})}(window.Application,window.chatConfig,jQuery),function(t,e){var i=Backbone.Model.extend({defaults:{message_id:null,state:null,files_info:null,size:null,progress:0},url:function(){var t=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?t:t+"&id="+encodeURIComponent(this.id)},initialize:function(t,e){var i=this.get("size"),s=this.get("files_info");if("string"==typeof s)try{s=JSON.parse(s),this.set("files_info",s,{silent:!0})}catch(n){}if(!i&&s){i=0;for(var o=0;o<s.length;o++)i+=s[o].size;this.set("size",i,{silent:!0})}},deny:function(t){this._requestAndUpdate(e.denyUploadPath,{id:this.get("id")},t)},confirm:function(t){this._requestAndUpdate(e.confirmUploadPath,{id:this.get("id")},t)},abort:function(t){this._requestAndUpdate(e.abortUploadPath,{id:this.get("id")},t)},_requestAndUpdate:function(t,e,i){var s=this;$.post(t,e,function(t){t.success&&s.set(t.upload),i&&i(t)})},isSettled:function(){return[i.STATE_PENDING,i.STATE_UPLOADING,null].indexOf(this.get("state"))===-1},isUnused:function(){for(var t in this._events){if("all"!==t)return!1;if(this._events[t].length>1)return!1}return!0}},{STATE_PENDING:"pending",STATE_ABORTED:"aborted",STATE_DENIED:"denied",STATE_ERROR:"error",STATE_UPLOADING:"uploading",STATE_UPLOADED:"uploaded"});t.UploadModel=i}(Application,chatConfig),function(t,e,i,s){var n=t.GuestChatModel=Backbone.Model.extend({defaults:{name:"anonymous",mail:""},guestModel:!0,lastMessages:[],lastMessageIdAtLogin:0,lastMessageId:0,lastTypingUpdate:0,initialize:function(){this.on("login:success",this.startConnection,this),this.on("login:success",this.stopTracking,this),this.on("login:success",this.confirmLogin,this),this.on("login:login",this.startTracking,this),this.on("logout:init",this.startTracking,this)},autoLogin:function(){var s=this;e.post(i.isLoggedInPath,{info:JSON.stringify(i.info)},function(e){e.success?(s.set({id:e.id,name:s._getVisibleName(e.name),mail:e.mail,image:e.image}),t.UserModel.cacheUsers([{id:e.id,name:s._getVisibleName(e.name),mail:e.mail,image:e.image}]),e.lastMessageId&&(s.lastMessageIdAtLogin=e.lastMessageId),s.trigger("login:success")):s.trigger("login:login")})},login:function(s,n){var o=this;t.service.geoloc.requestInfo(),s.info=JSON.stringify(i.info),e.post(i.loginPath,s,function(e){e.success?(s.auto?(o.set({id:e.id,name:o._getVisibleName(e.name),mail:e.mail,image:e.image}),t.UserModel.cacheUsers([{id:e.id,name:o._getVisibleName(e.name),mail:e.mail,image:e.image}])):o.set({id:e.id,name:o._getVisibleName(s.name),mail:s.mail,image:s.image,department:s.department}),n&&n(e),o.trigger("login:success",!0,s)):o.trigger("login:error")})},logout:function(t){t=!!t,this.stopConnection();var s=this;e.post(i.logoutPath,{silent:t},function(t){t&&t.success?(s.set({id:null,name:null,mail:null,image:null}),s.trigger("logout:success")):s.trigger("logout:error")}),this.lastMessages=[],this.lastMessageId=this.lastMessageIdAtLogin=0,this.trigger("logout:init")},checkOperators:function(){var t=this;e.get(i.isOperatorOnlinePath,function(e){e.success?t.trigger("operators:online"):t.trigger("operators:offline")}),this.loadDepartments()},loadDepartments:function(t){var n=this;e.get(i.onlineDepartmentsPath,function(t){!t.departments||0!==t.departments.length&&s.pluck(t.departments,"status").indexOf("online")===-1||(n.departments=t.departments,n.trigger("departments:change"))})},onOperatorStatus:function(t){"online"===t?this.trigger("operators:online"):this.trigger("operators:offline")},updateTypingStatus:function(){var t=(new Date).getTime();this.lastTypingUpdate+n.POLLING_INTERVAL<t&&(this.lastTypingUpdate=t,e.post(i.updateTypingStatusPath,{status:!0}))},getTypingStatus:function(t){var s=this,n=e.post(i.getTypingStatusPath,function(t){t.success&&t.result&&s.trigger("operator:typing")});t&&n.always(t)},onUser:function(e){var i=t.UserModel.getUserSync(this.get("id"));i&&(i.set(e),i.set("name",this._getVisibleName(e.name)))},onMessages:function(e){var i=this;e.length>0&&(this.removeReadMessages(e),this.storeMessages(e),this.loadOperatorsData(e,function(){for(var s=0;s<e.length;s++){var n=e[s];n.from_id>0&&t.UserModel.getUser(n.from_id,function(t){n.from_user_info=t.attributes})}i.trigger("messages:new",e)}))},removeReadMessages:function(t){for(var e=t.length-1;e>=0;e--){var i=t[e];i.id&&i.id<=this.lastMessageId&&t.splice(e,1)}},onUploads:function(e){e=s.values(e),e.length>0&&t.model.watchedUploads.set(e,{remove:!1})},storeMessages:function(t){s.each(t,function(t){!t.datetime&&t.time&&(t.datetime=t.time.getTime()),t.id&&t.id>this.lastMessageId&&(this.lastMessageId=t.id)},this),this.lastMessages=this.lastMessages.concat(t)},loadOperatorsData:function(e,i){for(var s=[],n=0;n<e.length;n++){var o=parseInt(e[n].from_id);s.indexOf(o)===-1&&s.push(o)}return 0===s.length?void i():void t.UserModel.getUsers(s,function(t){i()})},getOperatorName:function(e){var i=t.UserModel.getUserSync(e);return i&&i.getReadableName()},sendMessage:function(t,s){var n={body:t.get("body"),extra:JSON.stringify(t.get("extra"))},o=this;e.post(i.sendMessagePath,n,function(e){e.success?(t.set("id",parseInt(e.id)),o.storeMessages([t.attributes]),o.trigger("messages:sent")):o.trigger("messages:sendError"),s&&s(e)})},isChatting:function(){return!!this.connectionTimer},mailTalkTranscript:function(t){return e.post(i.mailTalkTranscriptPath,t)},startConnection:function(){this.stopConnection(),this.initRequestsStatus(),this.connectionTimer=setInterval(e.proxy(this.manageConnection,this),n.POLLING_INTERVAL),this.manageConnection()},stopConnection:function(){this.connectionTimer&&(clearInterval(this.connectionTimer),this.connectionTimer=null)},manageConnection:function(){if(this.prevRequestsComplete()){this.resetRequestsStatus();var t=this;this._manageConnection(function(){t.requestsStatus._manageConnection=!0}),this.getTypingStatus(function(){t.requestsStatus.getTypingStatus=!0})}},_manageConnection:function(s){var n=this,o={lastMessageId:this.lastMessageId};this.currentUrl!=this.prevUrl&&(o.url=this.prevUrl=this.currentUrl),t.service.geoloc.empty||(i.info.geoloc=t.service.geoloc.info,o.info=JSON.stringify(i.info),t.service.geoloc.empty=!0),t.model.watchedUploads.length>0&&(o.watchedUploads=t.model.watchedUploads.pluck("id").join(","));var a=e.post(i.manageConnectionPath,o,function(t){n.onUser(t.user),t.lastMessageId&&t.lastMessageId>this.lastMessageId&&(this.lastMessageId=t.lastMessageId),n.onMessages(t.messages),n.onUploads(t.uploads)});s&&a.always(s)},prevRequestsComplete:function(){if(Date.now()-this.requestInitTime>n.REQUEST_STATUS_RESET_TIMEOUT)return this.initRequestsStatus(),!0;for(var t in this.requestsStatus)if(!this.requestsStatus[t])return!1;return this.requestInitTime=Date.now(),!0},initRequestsStatus:function(){this.requestInitTime=Date.now(),this.requestsStatus={_manageConnection:!0,getTypingStatus:!0}},resetRequestsStatus:function(){for(var t in this.requestsStatus)this.requestsStatus[t]=!1},startTracking:function(){"true"===i.ui.operatorInitChat&&(this.stopTracking(),this.trackingTimer=setInterval(e.proxy(this.manageTracking,this),Math.max(2e3,1e3*parseInt(i.ui.onlineTrackInterval))),this.manageTracking())},manageTracking:function(){var s={};s.url=this.currentUrl||i.info.referer,t.service.beacon.send(i.trackKeepAlivePath,s,e.proxy(this.onTrackingResponse,this))},stopTracking:function(){this.trackingTimer&&clearInterval(this.trackingTimer)},onTrackingResponse:function(t){t===n.TRACK_MESSAGE_LOGIN&&(this.stopTracking(),this.login({auto:!0},e.proxy(this.confirmLogin,this)))},confirmLogin:function(){e.post(i.trackConfirmLoginPath)},_getVisibleName:function(e){return t.service.i18n.trans("you")}},{POLLING_INTERVAL:1e3*parseInt(i.ui.pollingInterval),REQUEST_STATUS_RESET_TIMEOUT:2e4,TRACK_MESSAGE_LOGIN:2})}(window.Application,jQuery,window.chatConfig,_),function(t,e){var i=Backbone.Collection.extend({url:e.uploadCrudPath,model:t.UploadModel,parse:function(t){if(t.success)return t.uploads},initialize:function(){this.on("add",this.onAdd,this),this.on("remove",this.onRemove,this),_.bindAll(this,"removeUnused")},set:function(){Backbone.Collection.prototype.set.apply(this,arguments),setTimeout(this.removeUnused,0)},removeUnused:function(){for(var t=this.models.length-1;t>=0;t--){var e=this.models[t];(e.isSettled()||e.isUnused())&&this.remove(e)}}});t.WatchedUploadsCollection=i}(Application,chatConfig),function(t,e,i){t.LoginFormView=Backbone.View.extend({events:{"click .select-department":"showDepartments"},mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),nameValid:!1,mailValid:!1,initialize:function(){this.model=t.model.chat,this.selectDepartment=this.createSelectDepartmentView(),this.$form=this.$(".form"),this.$name=this.$("#customer-chat-login-name"),this.$mail=this.$("#customer-chat-login-mail"),this.$departmentsBtn=this.$(".select-department"),this.listenTo(this.selectDepartment,"updateSelection",this.onSelectDepartment),this.$name.on("input change keydown blur",e.proxy(this.validateName,this)),this.$mail.on("input change keydown blur",e.proxy(this.validateMail,this)),this.reset()},reset:function(){var e=this.model.departments;e&&0!==e.length?this.$departmentsBtn.parent().show():this.$departmentsBtn.parent().hide(),this.$name.val(""),this.$mail.val(""),this.$name.removeClass("customer-chat-input-error"),this.$mail.removeClass("customer-chat-input-error"),"true"!==i.ui.askForMail&&this.$mail.hide().val(t.service.i18n.trans("empty.mail.placeholder"))},validateDepartment:function(){var e=!1,i=this.model.departments;if(!i||0===i.length)return void(this.departmentValid=!0);if(this.selectDepartment.selected.length>0&&(e=!0),e){var s=_.findWhere(t.model.chat.departments,{id:this.selectDepartment.selected[0]});this.$departmentsBtn.removeClass("customer-chat-input-error").addClass("selected").find(".empty-content").hide().end().find(".content").html(s.name).show(),this.departmentValid=!0}else this.$departmentsBtn.addClass("customer-chat-input-error").find(".empty-content").show().end().find(".content").hide(),this.departmentValid=!1},validateName:function(){0==this.$name.val().length?(this.$name.addClass("customer-chat-input-error"),this.nameValid=!1):(this.$name.removeClass("customer-chat-input-error"),this.nameValid=!0)},validateMail:function(){0!=this.$mail.val().length&&this.mailExp.test(this.$mail.val())?(this.$mail.removeClass("customer-chat-input-error"),this.mailValid=!0):(this.$mail.addClass("customer-chat-input-error"),this.mailValid=!1)},isValid:function(){return this.validateDepartment(),this.validateName(),this.validateMail(),this.departmentValid&&this.nameValid&&this.mailValid},showDepartments:function(){this.$el.addClass("departments-view")},hideDepartments:function(){this.$el.removeClass("departments-view")},onSelectDepartment:function(){this.validateDepartment(),this.hideDepartments()},createSelectDepartmentView:function(){return new t.SelectListView({el:this.$(".departments .list"),model:this.model,single:!0,iconActive:"check",iconInactive:"circle",renderEvent:"departments:change",dataProvider:function(){var e=t.model.chat.departments;if(e){e=_.groupBy(e,"status");var i=e.online||[],s=e.offline||[];return i.concat(s)}return[]},getLabel:function(t){return"<div><span>"+t.name+"</span>"+(t.description?"<em>"+t.description+"</em></div>":"")},styleItem:function(t,e,i){"offline"===t.data("entry").status?t.removeClass("online").addClass("offline disabled"):t.removeClass("offline disabled").addClass("online")}})},getHeight:function(){return this.$form.height()}})}(window.Application,jQuery,window.chatConfig),function(t,e){t.ContactFormView=Backbone.View.extend({mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),nameValid:!1,mailValid:!1,messageValid:!1,initialize:function(){this.$form=this.$(".form"),this.$name=this.$("#customer-chat-contact-name"),this.$mail=this.$("#customer-chat-contact-mail"),this.$message=this.$("#customer-chat-contact-message"),this.$name.on("input change keydown blur",e.proxy(this.validateName,this)),this.$mail.on("input change keydown blur",e.proxy(this.validateMail,this)),this.$message.on("input change keydown blur",e.proxy(this.validateMessage,this))},reset:function(){this.$name.val(""),this.$mail.val(""),this.$message.val(""),this.$name.removeClass("customer-chat-input-error"),this.$mail.removeClass("customer-chat-input-error"),this.$message.removeClass("customer-chat-input-error")},validateName:function(){0==this.$name.val().length?(this.$name.addClass("customer-chat-input-error"),this.nameValid=!1):(this.$name.removeClass("customer-chat-input-error"),this.nameValid=!0)},validateMail:function(){0!=this.$mail.val().length&&this.mailExp.test(this.$mail.val())?(this.$mail.removeClass("customer-chat-input-error"),this.mailValid=!0):(this.$mail.addClass("customer-chat-input-error"),this.mailValid=!1)},validateMessage:function(){this.$message.val().length<6?(this.$message.addClass("customer-chat-input-error"),this.messageValid=!1):(this.$message.removeClass("customer-chat-input-error"),this.messageValid=!0)},isValid:function(){return this.validateName(),this.validateMail(),this.validateMessage(),this.nameValid&&this.mailValid&&this.messageValid},getHeight:function(){return this.$form.height()}})}(window.Application,jQuery),function(t,e){t.MailTranscriptView=Marionette.ItemView.extend({getTemplate:function(){return t.template.mailTalkTranscript},mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),mailValid:!1,ui:{form:".form",mail:"#customer-chat-transcript-mail"},events:{"input   @ui.mail":"validateMail","change  @ui.mail":"validateMail","keydown @ui.mail":"validateMail","blur    @ui.mail":"validateMail"},initialize:function(){this.bindUIElements()},getData:function(){return{mail:this.ui.mail.val()}},reset:function(t){this.ui.mail.val(t||""),this.ui.mail.removeClass("customer-chat-input-error")},focus:function(){this.ui.mail.focus()},validateMail:function(){0!=this.ui.mail.val().length&&this.mailExp.test(this.ui.mail.val())?(this.ui.mail.removeClass("customer-chat-input-error"),this.mailValid=!0):(this.ui.mail.addClass("customer-chat-input-error"),this.mailValid=!1)},isValid:function(){return this.validateMail(),this.mailValid},getHeight:function(){return this.ui.form.height()}})}(window.Application,jQuery),function(t,e,i){var s=t.AvatarView=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change",this.render),this.render()},render:function(){if(this.$el.html(""),this.model.isSystemMessage()){var e=s.INFO,n=this.model.get("extra");if(n)switch(n.type){case t.MessageModel.EXTRA_TALK_OWNER:e=s.OWNER;break;case t.MessageModel.EXTRA_USER_INVITE:e=s.INVITE;break;case t.MessageModel.EXTRA_USER_LEAVE:e=s.LEAVE;break;case t.MessageModel.EXTRA_TALK_CLOSE:e=s.CLOSE}var o=i("<i>").addClass("fa fa-"+e.icon).addClass(e.className);this.$el.append(o),this.$el.css("background-image","none")}else this.$el.removeClass("customer-chat-content-message-avatar").addClass("customer-chat-content-message-avatar-operator"),this.model.fromUser&&this.model.fromUser.image&&this.$el.css("background-image",'url("'+this.model.fromUser.image+'")')}},{INFO:{icon:"info",className:"avatar-info"},OWNER:{icon:"user",className:"avatar-owner"},INVITE:{icon:"sign-in",className:"avatar-invite"},LEAVE:{icon:"sign-out",className:"avatar-leave"},CLOSE:{icon:"power-off",className:"avatar-close"}})}(window.Application,window.chatConfig,jQuery),function(t,e,i){var s=/(((http(s)?:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_*\[\]]*)?\??(?:[\-\+=&;%@\.\w_\[\]]*)#?(?:[\.\!\/\\\w=]*))?)/,n=/(png|gif|jpg|jpeg)$/i,o=/youtube.com\/(?:watch\?v=|v\/)([^&\/?]+)|youtu.be\/([^&\/?]+)/i,a=/vimeo.com\/(?:[\w\/]+\/)*([\d]+)/i,r=t.MessageView=Backbone.View.extend({initialize:function(){this.subviews=[],this.options.prevMessage&&(this.prevMessage=this.options.prevMessage,this.model.get("from_id")==this.prevMessage.get("from_id")&&(this["short"]=!0)),this.settings=t.model.settings,this.listenTo(this.model,"change",this.render),this.render(),this.$el.hide(),this.$el.fadeIn("fast")},render:function(){this.$el.html(t.template.message({author:this.model.getReadableName()||this.model.get("author"),isSystem:this.model.isSystemMessage(),isOperator:"operator"==this.model.get("authorType")})),this.$time=this.$(".customer-chat-content-message-time"),this.buildBody(this.$(".customer-chat-content-message-body")),this.updateTime(!0),this["short"]&&!this.model.isSystemMessage()?(this.$el.addClass("short"),this.prevMessage.getAge()-this.model.getAge()<r.VISIBLE_AGE_LIMIT&&this.$time.hide()):new t.AvatarView({el:this.$(".avatar")[0],model:this.model})},buildBody:function(i){var n=this.model.get("extra");if(n&&n.type===t.MessageModel.EXTRA_FILES)return void i.append(this.storeSubview(r.createFileView(this.model)));for(var o,a=this.settings.get("emots"),l=this.model.get("body").split("<").join("&lt;").split(">").join("&gt;"),h="off"!==e.ui.chatBoxMedia;o=s.exec(l);){var c=l.slice(0,o.index),d=o.index,u=o[0],m=u,g=!0;if(u.indexOf("@")>-1?u="mailto:"+u:u.indexOf("://")===-1&&(u="http://"+u),l=l.slice(d+u.length),c.length>0&&i.append(a?r.addEmoticons(c):c),h)if(r.isImageLink(u))i.append(this.storeSubview(r.createImageView(u))),g=!1;else{var f;(f=r.isYouTubeLink(u))?(i.append(this.storeSubview(r.createVideoView("youtube",u,f))),g=!1):(f=r.isVimeoLink(u))&&(i.append(this.storeSubview(r.createVideoView("vimeo",u,f))),g=!1)}g&&i.append(r.createLinkElement(m,u))}i.append(a?r.addEmoticons(l):l)},storeSubview:function(t){return this.subviews.push(t),t.el},updateTime:function(e){var i=this.model.getAge(),s=Math.floor(i/60),n=Math.floor(s/60),o=Math.floor(n/24),a=Math.floor(o/7),r=this.model.get("time"),l=(r.getDate()<10?"0":"")+r.getDate()+"."+(r.getMonth()+1<10?"0":"")+(r.getMonth()+1)+"."+r.getFullYear(),h=(r.getHours()<10?"0":"")+r.getHours()+":"+(r.getMinutes()<10?"0":"")+r.getMinutes()+":"+(r.getSeconds()<10?"0":"")+r.getSeconds(),c=l+" "+h;if(this.options.fullDate)return void this.$time.html(c);var d=a>0?c:o>0?o+" "+t.service.i18n.trans("timeDaysAgo"):n>0?n+" "+t.service.i18n.trans("timeHoursAgo"):s>0?s+" "+t.service.i18n.trans("timeMinutesAgo"):Math.max(i-i%5,1)+" "+t.service.i18n.trans("timeSecondsAgo");if(this.$time.html(d),e){var u=o>0?-1:n>0?60*(60-s%60)*60:s>5?60*(5-s%5):s>0?60:10-i%10;if(u==-1)return;var m=this;this.timerId=setTimeout(function(){m.updateTime(!0)},1e3*u)}},clean:function(){this.timerId&&clearTimeout(this.timerId);for(var t=0;t<this.subviews.length;t++)this.subviews[t].remove();return this}},{VISIBLE_AGE_LIMIT:300,EMOTICONS:{"&gt;:|":"emot emot-9","&gt;:D":"emot emot-10",":)":"emot emot-1",";)":"emot emot-2",":(":"emot emot-3",":D":"emot emot-4",":P":"emot emot-5","=)":"emot emot-6",":|":"emot emot-7","=|":"emot emot-8",o_O:"emot emot-11","=O":"emot emot-12","&lt;3":"emot emot-13",":S":"emot emot-14",":*":"emot emot-15",":$":"emot emot-16","=B":"emot emot-17",":-D":"emot emot-18",";-D":"emot emot-19","*-D":"emot emot-20"},addEmoticons:function(t){for(var e in r.EMOTICONS)t=t.split(e).join(r.createEmotElement(r.EMOTICONS[e]));return t},createEmotElement:function(t){return'<i class="'+t+'"></i>'},createLinkElement:function(t,e){return'<a href="'+e+'" target="_blank">'+t+"</a>"},createImageView:function(e){return new t.MessageImageView({url:e})},createVideoView:function(e,i,s){return new t.MessageVideoView({type:e,url:i,videoId:s})},createFileView:function(e){return new t.MessageFileView({message:e})},isYouTubeLink:function(t){var e=o.exec(t);return e?e[1]||e[2]:null},isVimeoLink:function(t){var e=a.exec(t);return e?e[1]:null},isImageLink:function(t){return n.test(t)}})}(window.Application,window.chatConfig,jQuery),function(t,e,i){t.MessageImageView=Backbone.View.extend({events:{"click .chat-inline-view":"showContent"},initialize:function(){this.settings=t.model.settings,this.render()},render:function(){var i=this.options.url;return this.$el.html(t.template.messageImage({url:i})),this.$imgLink=this.$(".chat-inline-view").attr("href","#"),this.$img=this.$imgLink.find(".image"),this.settings.get("media")?"auto"===e.ui.chatBoxMedia?this.showContent():(this.manualShow=!0,this.$el.addClass("manual-show")):this.$el.addClass("chat-inline-disabled"),this},showContent:function(t){this.contentShown||(this.manualShow&&(this.manualShow=!1,t&&t.preventDefault()),this.$imgLink.attr("href",this.options.url),this.$img.attr("src",this.options.url).bind("load",i.proxy(this.onLoad,this)),this.$el.removeClass("manual-show").addClass("loading"),this.contentShow=!0)},onLoad:function(){this.$el.removeClass("loading").trigger("contentUpdate")}})}(window.Application,window.chatConfig,jQuery),function(t,e,i){var s=t.MessageVideoView=Backbone.View.extend({events:{"click .chat-inline-view":"showContent"},initialize:function(){this.settings=t.model.settings,this.type=s.TYPES[this.options.type],this.render()},render:function(){var i=this.options.url,s=this.options.videoId;return this.$el.html(t.template.messageVideo({type:this.options.type,url:i,id:s,icon:this.type.icon})),this.$iframe=this.$("iframe"),this.settings.get("media")?"auto"===e.ui.chatBoxMedia?this.showContent():(this.manualShow=!0,this.$el.addClass("manual-show")):this.$el.addClass("chat-inline-disabled"),this},showContent:function(t){this.contentShown||(this.manualShow&&(this.manualShow=!1,t&&t.preventDefault()),this.$iframe.attr("src",this.type.url.replace("%id%",this.options.videoId)).bind("load",i.proxy(this.onLoad,this)),this.$el.removeClass("manual-show").addClass("loading"),this.contentShown=!0)},onLoad:function(){this.$el.removeClass("loading").trigger("contentUpdate")}},{TYPES:{youtube:{icon:"youtube-play",url:"//www.youtube.com/embed/%id%"},vimeo:{icon:"vimeo",url:"//player.vimeo.com/video/%id%"}}})}(window.Application,window.chatConfig,jQuery),function(t,e,i){var s=t.MessageFileView=Marionette.ItemView.extend({getTemplate:function(){return t.template.messageFile},templateHelpers:{fileSize:function(){return this.size?this.size<1024?this.size+" B":this.size<1048576?(this.size/1024).toFixed(2)+" kB":(this.size/1048576).toFixed(2)+" MB":""},fileIcon:function(){if(this.type)for(var t in s.mimeToIcon)if(this.type.indexOf(t)>-1)return s.mimeToIcon[t];return"file-o"},state:function(){var t=Array.prototype.slice.call(arguments,0,arguments.length-1),e=arguments[arguments.length-1];return t.indexOf(this.state)>-1?e.fn(this):e.inverse(this)},showConfirmDeny:function(t){return!this.isAuthor&&this.isOperator&&["pending","uploading",null].indexOf(this.state)>-1?t.fn(this):t.inverse(this)}},className:"file-message",ui:{progress:".progress-bar",abort:".abort",deny:".deny",confirm:".confirm",links:".download"},events:{"click @ui.abort":"abortUpload","click @ui.deny":"denyUpload","click @ui.confirm":"confirmUpload"},initialize:function(e){this.user=t.model.user||t.model.chat,this.message=e.message,this.upload=this.message.upload,this.message.uploader&&(this.uploader=this.message.uploader,_.bindAll(this,"onError","onAbort","onLoad","onProgress"),this.uploader.on("error",this.onError),this.uploader.on("abort",this.onAbort),this.uploader.on("load",this.onLoad)),this.listenTo(this.message.upload,"change:state",this.render),this.listenTo(this.message.upload,"change:progress",this.onProgress),this.template=this.getTemplate(),this.render()},render:function(){var e=this.upload&&this.upload.get("state");if(e===t.UploadModel.STATE_ERROR||e===t.UploadModel.STATE_UPLOADED||this.upload.previous("state")!==t.UploadModel.STATE_UPLOADED){var i=this.getFiles(),s=t.model.user&&t.model.user.hasRole("OPERATOR"),n=!!this.uploader;return this.$el.html(this.template({files:i,isAuthor:this.user.get("id")==this.message.get("from_id"),isUploading:n,isGuest:!t.model.user,isOperator:s,state:e,error:this.upload.get("error")},{helpers:this.templateHelpers})),this.$el.attr("class","file-message").addClass(e?e:"initial"),s?this.$el.addClass("operator"):n||this.$el.addClass("no-actions"),this.bindUIElements(),e===t.UploadModel.STATE_UPLOADED&&i&&this.setDownloadLinks(_.pluck(i,"id")),
this.onProgress(this.upload,this.upload.get("progress")),this}},getFiles:function(){return this.upload.has("files")?this.upload.get("files"):this.message.get("extra").files},onError:function(){this.upload.set("state",t.UploadModel.STATE_ERROR)},onAbort:function(){this.uploader=null,this.upload.set("state",t.UploadModel.STATE_ABORTED)},onLoad:function(e){this.upload.set("state",t.UploadModel.STATE_UPLOADED),this.ui.progress.width("100%"),e=JSON.parse(e),e.success?this.setDownloadLinks(e.files):this.onError()},onProgress:function(t,e){var i=Math.floor(e/this.upload.get("size")*100);this.prevPercentage>i||(this.ui.progress.width(i+"%"),this.prevPercentage=i)},abortUpload:function(){this.upload.abort(),this.uploader.uploading?this.uploader.abort():this.onAbort()},denyUpload:function(){this.upload.deny()},confirmUpload:function(){this.upload.confirm()},setDownloadLinks:function(t){this.ui.links.each(function(s){i(this).attr("href",e.downloadFilePath+"&id="+t[s]).attr("target","_blank")})}},{mimeToIcon:{text:"file-text-o",pdf:"file-pdf-o",image:"file-image-o",audio:"file-audio-o",video:"file-video-o",word:"file-word-o",excel:"file-excel-o",spreadsheetml:"file-excel-o",powerpoint:"file-powerpoint-o",zip:"cube",tar:"cube"}})}(window.Application,window.chatConfig,window.jQuery),function(t,e){t.ChatBoxView=Backbone.View.extend({initialize:function(){this.settings=t.model.settings,this.$wrapper=this.$(".customer-chat-content-messages-wrapper"),this.$el.mCustomScrollbar(),this.messageViews=[],this.$el.bind("contentUpdate",e.proxy(this.updateScroller,this))},addMessage:function(e,i,s){var n;this.messageViews.length&&(n=this.messageViews[this.messageViews.length-1].model);var o=new t.MessageView({model:e,fullDate:this.options.fullDate,prevMessage:n});this.messageViews.push(o),this.$wrapper.append(o.el);var a=this;return setTimeout(function(){a.updateScroller(),s?i&&a.$el.mCustomScrollbar("scrollTo","bottom"):(a.settings.get("scroll")||i)&&a.$el.mCustomScrollbar("scrollTo","bottom")},200),o},clear:function(){for(var t=0;t<this.messageViews.length;t++)this.messageViews[t].remove().clean();this.$wrapper.html(""),this.messageViews=[]},updateScroller:function(){this.$el.mCustomScrollbar("update")},scrollToBottom:function(){this.$el.mCustomScrollbar("scrollTo","bottom")},storeScrollPos:function(){this.lastScrollPos=Math.abs(this.$(".mCSB_container").position().top)},scrollToLastPos:function(){this.$el.mCustomScrollbar("scrollTo",this.lastScrollPos)}})}(window.Application,jQuery),function(t,e,i){var s=Marionette.Object.extend({initialize:function(t){this.user=t.user,this.chat=t.chat,this.chatBox=t.chatBox,this.talkId=t.talkId,this.toId=t.toId,this.files=t.files,this.input=t.input},run:function(){var s,n=this.input,o=this.files,a=this._getFilesInfo(o=o||n.files||n.value),r=this.uploader=new AjaxUploader({url:e.uploadFilesPath,files:o,input:n,filesField:"files[]",onProgress:i.bind(this.onProgress,this)});this.user.hasRole&&this.user.hasRole("OPERATOR")?(s=new t.MessageModel({author:this.user.get("name"),mail:this.user.get("mail"),authorType:"operator",body:this._getMessageBody(o),time:new Date,talk_id:this.talkId,from_id:this.user.get("id"),to_id:this.toId,extra:{type:t.MessageModel.EXTRA_FILES,files:a.files},from_user_info:{image:this.user.get("image")}},{localMessage:!0}),s.fromUser=this.user.attributes):s=new t.MessageModel({author:this.user.get("name"),authorType:"guest",body:this._getMessageBody(o),time:new Date,from_id:this.user.get("id"),extra:{type:t.MessageModel.EXTRA_FILES,files:a.files},from_user_info:{image:this.user.get("image")}},{localMessage:!0}),this.message=s,s.uploader=r,this.listenTo(s.upload,"change:state",this.onStateChange);var l=this._validateFiles(a);return"undefined"!=typeof l?(s.upload.set("error",l),s.upload.set("state",t.UploadModel.STATE_ERROR)):this.chat.sendMessage(s,function(t){s.upload.set(t.upload)}),this.chatBox.addMessage(s,!0),s.upload},onStateChange:function(e,i){if(i!==t.UploadModel.STATE_PENDING){var s=e.previous("state");null!==s&&s!==t.UploadModel.STATE_PENDING||i!==t.UploadModel.STATE_UPLOADING?this.trigger("unlock"):(this.uploader.data={id:this.message.upload.get("id")},this.uploader.upload())}},onProgress:function(t){this.message.upload.save("progress",Math.floor(t*this.message.upload.get("size")))},_getFilesInfo:function(t){var e=[],i=0;if("string"==typeof t){var s=t.split("\\").pop();e.push({name:s,size:null,type:null}),i=null}else for(var n=0;n<t.length;n++){var o=t[n];e.push({name:o.name,size:o.size,type:o.type}),i+=o.size}return{totalSize:i,files:e}},_validateFiles:function(i){if(i.totalSize){var s=Math.floor(1024*parseFloat(e.ui.sharedFileMaxSize)*1024);return i.totalSize>s?t.service.i18n.trans("file.too.big",{"%max%":e.ui.sharedFileMaxSize}):void 0}},_getMessageBody:function(t){for(var e="",i=0;i<t.length;i++){var s=t[i];e+=s.name}return e}});t.UploadController=s}(window.Application,window.chatConfig,_),function(t,e,i){t.FileDropZoneView=Marionette.ItemView.extend({events:{drop:"handleDrop"},initialize:function(){_.bindAll(this,"enableEffect","disableEffect")},delegateEvents:function(){window.File&&window.FileList&&window.FileReader&&(Marionette.ItemView.prototype.delegateEvents.apply(this,arguments),this.el.addEventListener("dragover",this.enableEffect,!1),this.el.addEventListener("dragleave",this.disableEffect,!1))},undelegateEvents:function(){window.File&&window.FileList&&window.FileReader&&(this.el.removeEventListener("dragover",this.enableEffect,!1),this.el.removeEventListener("dragleave",this.disableEffect,!1),Marionette.ItemView.prototype.undelegateEvents.apply(this,arguments))},enableEffect:function(t){t.preventDefault(),t.stopPropagation(),this._isFileTransfer(t)&&(this.disableTimer&&clearTimeout(this.disableTimer),this.$el.addClass("active"))},disableEffect:function(t){this.disableTimer&&clearTimeout(this.disableTimer);var e=this;this.disableTimer=setTimeout(function(){e.$el.removeClass("active")},100)},handleDrop:function(t){t.preventDefault(),t.stopPropagation(),this.disableEffect();var e=t.originalEvent.dataTransfer.files||t.originalEvent.target.files;e&&e.length>0&&this.trigger("drop",e)},_isFileTransfer:function(t){if(t.dataTransfer.types){for(var e=0;e<t.dataTransfer.types.length;e++)if("Files"===t.dataTransfer.types[e])return!0;return!1}return!0}})}(window.Application,window.chatConfig,jQuery),function(t,e,i){var s=t.WidgetView=Backbone.View.extend({events:{"click #customer-chat-login-start":"login","keydown #customer-chat-content-login-form input":"loginOnEnter","click #customer-chat-button-toggle":"toggle","click #customer-chat-button-toggle i":"toggle","click .customer-chat-header":"toggle","click .customer-chat-header-title":"toggle","click .customer-chat-header-indicator":"toggle","click #customer-chat-button-close":"close","click #customer-chat-button-settings":"toggleSettings","click .customer-chat-content-message-emots-button":"toggleEmoticons","click .customer-chat-toggle-sound":"toggleSetting","click .customer-chat-toggle-scroll":"toggleSetting","click .customer-chat-toggle-emots":"toggleSetting","click .customer-chat-toggle-media":"toggleSetting","click .customer-chat-toggle-show":"toggleSetting","click #customer-chat-toggle-fs":"toggleFullscreen","click #customer-chat-action-end-chat":"endChat","click #customer-chat-action-end-chat-confirm":"endChatConfirm","click #customer-chat-action-end-chat-cancel":"endChatCancel","click #customer-chat-action-mail-transcript":"showMailTranscript","click #customer-chat-action-transcript-send":"mailTranscriptSend","keydown #customer-chat-content-mail-transcript":"mailTranscriptSendOnEnter","click #customer-chat-action-transcript-cancel":"mailTranscriptCancel","click #customer-chat-action-silent-logout":"silentLogout","click .customer-chat-emoticon":"addEmoticon","keydown #customer-chat-message-input":"messageTyping","change .file-button input":"onFilesSelect","click  .file-button input":"onFileInputClick","click #chat-send-button":"sendMessage","click #customer-chat-contact-send":"sendContactMessage","click #customer-chat-info-back":"showPrevState"},initialized:!1,talkInProgress:!1,visible:!1,state:"",prevState:"",titleBlinking:!1,typingInfoBlinking:!1,emotsVisible:!1,messageNamespace:"mcs_",initialize:function(){this.settings=t.model.settings,this.loginForm=new t.LoginFormView({el:this.$("#customer-chat-content-login-form")}),this.chatBox=new t.ChatBoxView({el:this.$(".customer-chat-content-messages")}),this.contactForm=new t.ContactFormView({el:this.$("#customer-chat-content-contact-form")}),this.mailTranscript=new t.MailTranscriptView({el:this.$("#customer-chat-content-mail-transcript")}),this.selectAvatar=new t.SelectAvatarInlineView({el:this.$("#customer-chat-select-avatar"),model:i.defaultAvatars}),this.$window=e(window),this.$html=e("html"),this.$header=this.$(".customer-chat-header"),this.$title=this.$(".customer-chat-header-title"),this.$mobileTitle=e("#mobile-widget i"),this.$toggleBtn=this.$("#customer-chat-button-toggle"),this.$settingsBtn=this.$("#customer-chat-button-settings"),this.$settings=this.$(".customer-chat-header-menu"),this.$typingInfo=this.$(".typing-indicator"),this.$emoticons=this.$(".customer-chat-emots-menu"),this.$input=this.$("#customer-chat-message-input"),this.$fileInput=this.$('[type="file"]'),this.$fileBtn=this.$(".file-button"),this.$contactName=this.$("#customer-chat-contact-name"),this.$contactMail=this.$("#customer-chat-contact-mail"),this.$contactMessage=this.$("#customer-chat-contact-message"),this.$loginName=this.$("#customer-chat-login-name"),this.$loginMail=this.$("#customer-chat-login-mail"),this.$info=this.$("#customer-chat-info-text"),this.$toggleSound=this.$(".customer-chat-toggle-sound"),this.$toggleScroll=this.$(".customer-chat-toggle-scroll"),this.$toggleEmots=this.$(".customer-chat-toggle-emots"),this.$toggleMedia=this.$(".customer-chat-toggle-media"),this.$toggleShow=this.$(".customer-chat-toggle-show"),this.$endChat=this.$("#customer-chat-action-end-chat"),this.$endChatConfirmation=this.$("#customer-chat-action-end-chat-confirmation"),this.$endChatConfirm=this.$("#customer-chat-action-end-chat-confirm"),"true"==i.ui.fileSharing?(this.fileDropZone=new t.FileDropZoneView({el:this.$(".file-drop-zone")}),this.fileDropZone.on("drop",this.onFilesDrop,this)):this.$fileBtn.hide(),this.showLoading(),this.model.once("operators:online",function(){this.postMessage("show"),this.initialized=!0},this),this.model.once("operators:offline",function(){this.initialized||"true"!==i.ui.hideWhenOffline?this.postMessage("show"):this.postMessage("hide")},this),this.model.once("operators:online",this.autoLogin,this),this.model.once("operators:offline",this.showContact,this),this.$('a[href="#"]').click(function(t){t.preventDefault()}),this.model.on("login:success",this.showChat,this),this.model.on("login:login",this.showLogin,this),this.model.on("login:error",this.showLoginError,this),this.model.on("logout:init",this.onLogout,this),this.model.on("logout:success",this.onLogoutSuccess,this),this.model.on("logout:error",this.onLogoutError,this),this.model.on("messages:new",this.handleMessages,this),this.model.on("operator:typing",this.handleOperatorTyping,this),this.settings.on("change",this.renderSettings,this),this.renderSettings(),this.initFramesCommunication(),this.model.checkOperators(),this.storeProperties(),(i.mobile||i.inline)&&this.show(),("true"===i.ui.autoShowWidget||"off"!==i.ui.autoShowWidget&&this.settings.get("autoShow"))&&(this.autoShowTimer=setTimeout(e.proxy(this.show,this),1e3*i.ui.autoShowWidgetAfter)),setInterval(e.proxy(this.chatBox.updateScroller,this.chatBox),1500)},setState:function(e){if(this.state!=e){switch(this.state=e,this.$settings.hide(),this.$emoticons.hide(),this.$el.removeClass("login-form chat-box contact-form loading-screen info-screen end-talk mail-transcript"),e){case"loading":this.$el.addClass("loading-screen"),this.$title.html(t.service.i18n.trans("loadingLabel"));break;case"chat":if(this.$el.addClass("chat-box"),this.$title.html(t.service.i18n.trans("chatHeader")),this.msgsInitialized){this.msgsInitialized=!0;for(var i=0;i<this.model.lastMessages.length;i++){var s=this.model.lastMessages[i],n=new t.MessageModel({authorType:s.authorType,author:"guest"===s.authorType?s.author:this.model.getOperatorName(s.from_id),body:s.body,time:new Date(s.datetime)});this.chatBox.addMessage(n,!0)}}this.prevState=e;break;case"mailTranscript":this.$el.addClass("mail-transcript"),this.$title.html(t.service.i18n.trans("mailTranscriptHeader"));var o=this.model.get("mail");o&&o!==t.service.i18n.trans("empty.mail.placeholder")?this.mailTranscript.reset(o):this.mailTranscript.reset(),this.mailTranscript.focus();break;case"endTalk":this.$el.addClass("chat-box end-talk"),this.$title.html(t.service.i18n.trans("chatHeader")),this.prevState=e;break;case"login":this.$el.addClass("login-form"),this.$title.html(t.service.i18n.trans("chatHeader")),this.fullscreenOff(),this.loginForm.reset(),this.prevState=e;break;case"contact":this.$el.addClass("contact-form"),this.$title.html(t.service.i18n.trans("contactHeader")),this.fullscreenOff(),this.prevState=e;break;case"info":this.$el.addClass("info-screen")}this.updateSize()}},show:function(){this.visible=!0,"once"===i.ui.autoShowWidget&&this.settings.set("autoShow",!1),this.autoShowTimer&&(clearTimeout(this.autoShowTimer),delete this.autoShowTimer),this.$el.addClass("customer-chat-visible"),this.stopTitleBlink(),this.prevFullscreen&&this.fullscreenOn(),this.postMessage("animate|bottom=0")},hide:function(t){var s=t?"css":"animate";this.visible=!1,this.prevFullscreen=this.fullscreen,"untilAction"===i.ui.autoShowWidget&&this.settings.set("autoShow",!1),this.fullscreen?(this.postMessage(s+"|bottom="+(this.headerHeight-(this.contentHeight||this.frameHeight))+"px"),this.fullscreenOff()):this.storeProperties(e.proxy(function(){this.postMessage(s+"|bottom="+(this.headerHeight-(this.contentHeight||this.frameHeight))+"px")},this)),this.$el.removeClass("customer-chat-visible"),this.$settings.hide(),this.$emoticons.hide()},toggle:function(t){i.mobile||i.inline||t&&t.target!==t.currentTarget||(this.visible?this.hide():this.show())},toggleFullscreen:function(){this.fullscreen?this.fullscreenOff():this.fullscreenOn()},fullscreenOn:function(){i.mobile||i.inline||(this.storeProperties(),this.$html.addClass("fs"),this.postMessage("animate|width=100%,height=100%,"+i.ui.widgetSide+"=0"),this.fullscreen=!0)},fullscreenOff:function(){i.mobile||i.inline||(this.$html.removeClass("fs"),this.frameWidth&&this.frameHeight&&this.frameOffset&&this.postMessage("animate|width="+this.frameWidth+"px,height="+this.frameHeight+"px,"+i.ui.widgetSide+"="+this.frameOffset,"px"),this.fullscreen=!1)},close:function(){history.length>1?history.back():(window.open("","_self"),window.close())},autoLogin:function(){this.showLoading(),this.model.autoLogin()},login:function(){this.manualLogin=!0;var t={department:this.loginForm.selectDepartment.selected[0],name:this.$loginName.val(),mail:this.$loginMail.val(),image:this.selectAvatar.selected};this.loginForm.isValid()&&(this.showLoading(),this.model.login(t))},loginOnEnter:function(t){13===t.which&&this.login()},toggleSettings:function(){this.visible&&(this.$settings.is(":visible")?(this.$settings.fadeOut("fast"),this.$endChatConfirmation.hide(),this.$endChat.show()):this.$settings.fadeIn("fast"))},toggleEmoticons:function(){this.emotsVisible?this.hideEmoticons():this.showEmoticons()},showEmoticons:function(){this.$settings.fadeOut("fast"),this.emotsVisible=!0,this.$emoticons.fadeIn("fast");var t=this;setTimeout(function(){e("html, body").bind("click.hideemots",e.proxy(t.hideEmoticons,t))},10)},hideEmoticons:function(){this.emotsVisible=!1,e("html, body").unbind(".hideemots"),this.$emoticons.fadeOut("fast")},toggleSetting:function(t){var i=e(t.currentTarget),s=i.attr("id").split("customer-chat-setting-toggle-")[1];this.settings.set(s,!this.settings.get(s))},endChat:function(){this.$endChat.hide(),this.$endChatConfirmation.show()},endChatCancel:function(){this.$endChatConfirmation.hide(),this.$endChat.show()},endChatConfirm:function(){this.$endChatConfirmation.hide(),this.$endChat.show(),this.$settings.hide(),this.chatBox.clear(),this.loginForm.reset(),this.model.logout()},mailTranscriptCancel:function(){this.showPrevState()},mailTranscriptSend:function(){this.mailTranscript.isValid()&&(this.showLoading(),this.model.mailTalkTranscript(this.mailTranscript.getData()).success(function(t){t.success?this._mailTranscriptOnSuccess():this._mailTranscriptOnError()}.bind(this)).fail(this._mailTranscriptOnError.bind(this)))},_mailTranscriptOnSuccess:function(){this.showInfo(t.service.i18n.trans("mailTranscriptSuccess"),t.service.i18n.trans("contactSuccessHeader"))},_mailTranscriptOnError:function(){this.showInfo(t.service.i18n.trans("mailTranscriptError"),t.service.i18n.trans("contactErrorHeader"))},mailTranscriptSendOnEnter:function(t){13===t.which&&this.mailTranscriptSend()},silentLogout:function(){this.chatBox.clear(),this.loginForm.reset(),this.showLogin()},renderSettings:function(){this.settings.get("sound")?this.$toggleSound.removeClass("customer-chat-disabled"):this.$toggleSound.addClass("customer-chat-disabled"),this.settings.get("scroll")?this.$toggleScroll.removeClass("customer-chat-disabled"):this.$toggleScroll.addClass("customer-chat-disabled"),this.settings.get("emots")?this.$toggleEmots.removeClass("customer-chat-disabled"):this.$toggleEmots.addClass("customer-chat-disabled"),this.settings.get("media")?this.$toggleMedia.removeClass("customer-chat-disabled"):this.$toggleMedia.addClass("customer-chat-disabled"),this.settings.get("show")?this.$toggleShow.removeClass("customer-chat-disabled"):this.$toggleShow.addClass("customer-chat-disabled")},addEmoticon:function(t){var s=e(t.currentTarget);this.$input.val(this.$input.val()+" "+s.data("emot")+" "),i.mobile||this.$input.focus(),this.$emoticons.fadeOut("fast")},handleMessages:function(i){for(var n=!1,o=!0,a=0;a<i.length;a++){var r=i[a];if(!this.talkInProgress||r.from_id!=this.model.get("id")){r.authorType="operator",r.author=this.model.getOperatorName(r.from_id);var l=new t.MessageModel(r);o=o&&l.isSystemMessage();var h=l.get("extra"),c=!l.isSystemMessage();if(h)switch(c=c||s.VISIBLE_EXTRA_MESSAGES.indexOf(h.type)!==-1,h.type){case t.MessageModel.EXTRA_TALK_CLOSE:this.showEndTalk(),this.model.logout();break;case t.MessageModel.EXTRA_TALK_START:c=!1}c&&(this.chatBox.addMessage(l),n=!0)}}this.talkInProgress=!0,n&&this.shouldNotifyAbout(i)&&(this.settings.get("sound")&&t.service.soundPlayer.play(o?"systemMessage":"message"),this.visible||(this.settings.get("show")?this.toggle():this.startTitleBlink()),this.$mobileTitle.is(":visible")&&(this.stopTitleBlink(),this.startTitleBlink()),setTimeout(e.proxy(this.stopTypingInfoBlink,this),1))},shouldNotifyAbout:function(t){return this.model.lastMessageId>this.model.lastMessageIdAtLogin&&t[0].from_id!=this.model.get("id")},messageTyping:function(t){this.handleTyping(),13!==t.keyCode||t.shiftKey||this.sendMessage()},sendMessage:function(){var t=e.trim(this.$input.val());0!=t.length&&(this._sendMessage(t),this.$input.val(""))},_sendMessage:function(e){if(0!=e.length){var i=new t.MessageModel({author:this.model.get("name"),authorType:"guest",body:e,time:new Date,from_id:this.model.get("id"),from_user_info:{image:this.model.get("image")}},{localMessage:!0});this.model.sendMessage(i),this.chatBox.addMessage(i,!0)}},inputFocus:function(){this.$el.addClass("input-focused"),this.chatBox.updateScroller()},inputBlur:function(){var t=this;setTimeout(function(){t.$el.removeClass("input-focused"),t.chatBox.updateScroller()},100)},handleTyping:function(){this.model.updateTypingStatus()},handleOperatorTyping:function(){this.startTypingInfoBlink(),this.stopTypingBlinkTimer&&clearTimeout(this.stopTypingBlinkTimer),this.stopTypingBlinkTimer=setTimeout(e.proxy(this.stopTypingInfoBlink,this),s.TYPING_STATUS_TIME)},sendContactMessage:function(){if(this.contactForm.isValid()){var s={name:this.$contactName.val(),mail:this.$contactMail.val(),question:this.$contactMessage.val(),userInfo:JSON.stringify(i.info)},n=this;e.post(i.contactPath,s,function(e){e.success?(n.contactForm.reset(),n.showInfo(t.service.i18n.trans("contactSuccessMessage"),t.service.i18n.trans("contactSuccessHeader"))):n.showInfo(t.service.i18n.trans("contactErrorMessage"),t.service.i18n.trans("contactErrorHeader"))}),this.showLoading()}},startTitleBlink:function(){this.titleBlinking=!0,this.blinkTitle()},blinkTitle:function(){if(this.titleBlinking){var t=this;this.$mobileTitle.fadeOut("slow"),this.$title.fadeOut("slow",function(){t.$mobileTitle.fadeIn("slow"),t.$title.fadeIn("slow",function(){t.blinkTitle()})})}},stopTitleBlink:function(){this.titleBlinking=!1},startTypingInfoBlink:function(){this.typingInfoBlinking||(this.typingInfoBlinking=!0,this.blinkTypingInfo())},blinkTypingInfo:function(){if(this.typingInfoBlinking){var t=this;this.$typingInfo.fadeIn("slow",function(){t.$typingInfo.fadeOut("slow",function(){t.blinkTypingInfo()})})}},stopTypingInfoBlink:function(){this.typingInfoBlinking=!1},showLogin:function(){this.setState("login"),this.model.once("login:success",this.showWelcomeMessage,this)},showLoginError:function(){this.showInfo(t.service.i18n.trans("loginError"))},onLogout:function(){this.showLoading()},onLogoutSuccess:function(){"endTalk"!==this.state&&"endTalk"!==this.prevState?(this.showLogin(),this.model.checkOperators()):this.showEndTalk()},onLogoutError:function(){this.showLogin(),this.model.checkOperators()},showWelcomeMessage:function(e,i){if(!i||!i.auto){this.chatBox.clear();var s=new t.MessageModel({authorType:"operator",author:t.service.i18n.trans("initMessageAuthor"),body:t.service.i18n.trans("initMessageBody"),time:new Date},{localMessage:!0});this.chatBox.addMessage(s)}},showChat:function(){this.setState("chat")},showMailTranscript:function(){this.setState("mailTranscript")},showEndTalk:function(){this.setState("endTalk")},showContact:function(){this.setState("contact")},showLoading:function(){this.setState("loading")},showInfo:function(t,e){this.$info.html(t),this.$title.html(e),this.setState("info")},showPrevState:function(){this.setState(this.prevState)},storeProperties:function(t){if(!i.mobile&&!i.inline&&!this.fullscreen){this.headerHeight=this.$header.height();var e=this;this.postMessage("get.properties",function(i){var s=i.split(",");e.frameWidth=parseInt(s[0]),e.frameHeight=parseInt(s[1]),e.frameOffset=parseInt(s[2]),t&&t()})}},postMessage:function(t,e){if(!i.mobile&&!i.inline&&(window.parent.postMessage(this.messageNamespace+t,"*"),e)){var s=this.$window,n=Math.floor((new Date).getTime()*Math.random()),o=this;this.$window.bind("message."+n,function(i){var a=o.postMessageData(i.originalEvent.data);if(a){var r=a.split(":");r[0]===t&&(e(r[1]),s.unbind("message."+n))}})}},initFramesCommunication:function(){this.messageNamespace=window.name;var t=this;this.$window.bind("message",function(e){var i=t.postMessageData(e.originalEvent.data);if(i){var s=i.split(":");"state.mobile"===s[0]?t.$html.addClass("mobile-widget"):"state.desktop"===s[0]?t.$html.removeClass("mobile-widget"):"url"===s[0]&&(t.model.currentUrl=decodeURIComponent(s[1]))}})},postMessageData:function(t){if(t&&"string"==typeof t&&0===t.indexOf(this.messageNamespace))return t.slice(this.messageNamespace.length)},updateSize:function(){setTimeout(e.proxy(function(){var t;"login"===this.state?t=this.loginForm.getHeight()+this.$header.height():"contact"===this.state?t=this.contactForm.getHeight()+this.$header.height():"chat"===this.state&&(t=this.frameHeight),t&&(this.contentHeight=Math.max(this.frameHeight,t),this.storeProperties(e.proxy(function(){this.visible||this.postMessage("css|bottom="+(this.headerHeight-(this.contentHeight||this.frameHeight))+"px"),this.postMessage("css|minHeight="+t+"px")},this)))},this),0)},onFileInputClick:function(t){this.isUploadLocked()&&t.preventDefault()},onFilesSelect:function(t){this.isUploadLocked()||this.sendFiles(null,t.target)},onFilesDrop:function(t){this.isUploadLocked()||this.sendFiles(t)},isUploadLocked:function(){return this.currUpload&&this.currUpload.get("state")===t.UploadModel.STATE_PENDING},sendFiles:function(e,i){var e=e||i&&i.files;if(!(i&&!i.value||e&&0===e.length)){this.lockUpload();var s=new t.UploadController({user:this.model,chat:this.model,chatBox:this.chatBox,files:e,input:i});s.on("unlock",this.unlockUpload,this),this.currUpload=s.run()}},lockUpload:function(){this.$fileBtn.addClass("disabled").removeAttr("for")},unlockUpload:function(){this.$fileBtn.removeClass("disabled").attr("for",this.$fileBtn.data("for")),this.$fileInput.val(null)}},{TYPING_STATUS_TIME:2e3,ANIMATION_TIME:400,VISIBLE_EXTRA_MESSAGES:[t.MessageModel.EXTRA_TALK_CLOSE]})}(window.Application,jQuery,window.chatConfig),function(t,e,i){t.SelectListView=Backbone.View.extend({events:{"click .entry-item":"toggleEntry","click .select-all":"selectAll","click .select-none":"selectNone"},initialize:function(){if(this.selected=[],this.dataProvider=this.options.dataProvider,this.getLabel=this.options.getLabel,this.options.iconActive=this.options.iconActive||"check-square-o",this.options.iconInactive=this.options.iconInactive||"square-o",this.options.styleItem){var t=i.proxy(this.styleItem,this),e=i.proxy(this.options.styleItem,this);this.styleItem=function(i,s,n){t(i,s,n),e(i,s,n)}}this.listenTo(this.model,this.options.renderEvent,this.render),this.options.readOnly&&(this.$el.addClass("read-only"),setTimeout(i.proxy(this.undelegateEvents,this),0));var s=this;this.options.noScroll||setInterval(function(){s.$el.find(".entries").mCustomScrollbar("update")},500),this.render()},render:function(){var e=this.dataProvider();this.$el.html(t.template.selectListContent({actions:!(this.options.readOnly||this.options.single)})),0===e.length?this.$el.addClass("empty"):this.$el.removeClass("empty"),this.$entries=this.$(".entries");for(var s=0;s<e.length;s++){var n=e[s],o=parseInt(n.id),a=i('<a class="entry-item"></a>'),r=(n.name,n.mail,i("<i>").addClass("fa"));this.options.readOnly||a.append(r),a.append(this.getLabel(n)).data("entryId",o).data("entry",n),this.styleItem(a,r,this.isSelected(o)),this.$entries.append(a)}return this.options.noScroll||this.$el.find(".entries").mCustomScrollbar(),this},toggleEntry:function(t){var e=i(t.currentTarget);if(!e.hasClass("disabled")){var s=e.data("entryId"),n=this.selected.indexOf(s),o=e.find(".fa");this.options.single?(this.selectNone(!0),this.selected=[s],this.styleItem(e,o,!0)):n!==-1?(this.selected.splice(n,1),this.styleItem(e,o,!1)):(this.selected.push(s),this.styleItem(e,o,!0)),this.trigger("updateSelection")}},select:function(t){0===t.length&&this.options.selectedOnly&&this.$el.addClass("empty"),this.selected=[];var e=this;this.$entries.find("a").each(function(){var s=i(this),n=s.data("entryId"),o=s.find(".fa");t.indexOf(n)!==-1?(e.selected.push(n),e.styleItem(s,o,!0),e.options.selectedOnly&&s.show()):(e.styleItem(s,o,!1),e.options.selectedOnly&&s.hide())}),this.trigger("updateSelection")},selectAll:function(t){this.selected=[];var e=this;this.$entries.find("a").each(function(){var t=i(this),s=t.data("entryId"),n=t.find(".fa");e.selected.push(s),e.styleItem(t,n,!0)}),t||this.trigger("updateSelection")},selectNone:function(t){this.selected=[];var e=this;this.$entries.find("a").each(function(){var t=i(this),s=t.find(".fa");e.styleItem(t,s,!1)}),t||this.trigger("updateSelection")},isSelected:function(t){return this.selected.indexOf(t)!==-1},styleItem:function(t,e,i){i?(t.addClass("active"),e.removeClass("fa-"+this.options.iconInactive).addClass("fa-"+this.options.iconActive)):(t.removeClass("active"),e.removeClass("fa-"+this.options.iconActive).addClass("fa-"+this.options.iconInactive))},clearItemStyle:function(t,e){e.removeClass("fa-"+this.options.iconActive).removeClass("fa-"+this.options.iconInactive)}})}(window.Application,chatConfig,jQuery),function(t,e,i){t.SelectAvatarInlineView=Backbone.View.extend({events:{"mousedown .prev-avatar":"prev","mousedown .next-avatar":"next"},selectedIndex:0,initialize:function(){this.$selected=this.$(".selected-avatar"),this.updateAvatar()},prev:function(){this.selectedIndex--,this.selectedIndex<0&&(this.selectedIndex=this.model.length-1),this.updateAvatar()},next:function(){this.selectedIndex++,this.selectedIndex>=this.model.length&&(this.selectedIndex=0),this.updateAvatar()},updateAvatar:function(){this.selected=this.model[this.selectedIndex],this.$selected.css("background-image",'url("'+this.selected+'")')}})}(window.Application,chatConfig,jQuery),function(t,e,i){t.WidgetFacade=function(){i.extend(this,e.Events);var s=t.view.widget,n=t.model.chat;i.extend(this,{show:function(){s.show()},hide:function(){s.hide()},fullscreenOn:function(){s.fullscreenOn()},fullscreenOff:function(){s.fullscreenOff()},endChat:function(){s.endChatConfirm()},sendMessage:function(t){s._sendMessage(t)}}),n.once("operators:online",function(){this.trigger("operators:online")},this).once("operators:offline",function(){this.trigger("operators:offline")},this).on("messages:new",function(){this.trigger("messages:new")},this).on("login:success",function(){this.trigger("login:success")},this).on("logout:success",function(){this.trigger("logout:success")},this).on("operator:typing",function(){this.trigger("operator:typing")},this)}}(window.Application,Backbone,_),function(t,e){t.PostMessageApiAdapter=function(t){var i=e(window),s=window.name;i.bind("message",function(e){var i=e.originalEvent.data;if(i&&0===i.indexOf(s)){i=i.slice(s.length);var n=i.split(":"),o=n[0],a=o.split("."),r=a[0];if("api"===r){var l=a[1];if("function"==typeof t[l]){var h=n.slice(1).join(":");t[l](h)}}}}),t.on("all",function(t){var e;switch(t){case"operators:online":e="operatorsonline";break;case"operators:offline":e="operatorsoffline";break;case"messages:new":e="message";break;case"login:success":e="loginsuccess";break;case"logout:success":e="logoutsuccess";break;case"operator:typing":e="operatortyping"}window.parent.postMessage(s+"api."+e,"*")})}}(window.Application,jQuery),jQuery(function(t){var e=window.Application;e.config(window.chatConfig),e.on("start",function(){this.service.soundPlayer=new this.SoundPlayer,this.service.geoloc=new this.Geolocation,this.service.beacon=new this.Beacon,this.model.watchedUploads=new this.WatchedUploadsCollection,this.model.settings=new this.GuestSettingsModel,this.model.chat=new this.GuestChatModel,this.view.widget=new this.WidgetView({el:"#customer-chat-widget",model:this.model.chat}),window.phpLiveChat=new this.WidgetFacade,new this.PostMessageApiAdapter(window.phpLiveChat)}),e.start()});