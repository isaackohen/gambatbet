!function(e,t,i,s){var a=i.Application.extend({model:{},view:{},controller:{},service:{},template:{},config:function(e){this.config=e},onBeforeStart:function(){var e=this.template,i=t('[type="text/template"]');i.each(function(t){e[this.id]=this.innerHTML}),i.remove(),i=t('[type="text/x-handlebars-template"]'),i.each(function(t){e[this.id]=s.compile(this.innerHTML)}),i.remove()}});e.Application=new a}(window,jQuery,Marionette,Handlebars),function(e,t,i){e.SoundPlayer=function(){this.play=function(e){};var e=[];this.addSounds=function(t){e.push(t)};var s=this;t.setup({url:i.rootPath+"swf/",onready:function(){if(s.play=function(e){t.play(e)},s.addSounds=function(e){for(var s in e)t.createSound({id:s,url:i.rootPath+e[s],autoLoad:!0,autoPlay:!1,volume:100})},s.addSounds({message:i.ui.messageSound}),s.addSounds({systemMessage:i.ui.systemMessageSound}),e.length>0)for(var a=0;a<e.length;a++)s.addSounds(e[a]);window.addEventListener("touchstart",function n(){window.removeEventListener("touchstart",n,!0),t.play("message"),t.stopAll()},!0)}})}}(window.Application,soundManager,chatConfig),function(e,t,i){e.Notify=function(){function e(e){for(var t=s.length-1;t>=0;t--){var i=s[t];i.close(),s.splice(t,1)}}if(!i.isSupported)return void(this.requestPermission=this.create=this.closeAll=function(){});var s=[];this.requestPermission=function(e){switch(i.permissionLevel()){case i.PERMISSION_DENIED:break;case i.PERMISSION_GRANTED:break;case i.PERMISSION_DEFAULT:default:i.requestPermission()}},this.create=function(a,n){if(i.permissionLevel()===i.PERMISSION_GRANTED){n.icon=n.icon||t.rootPath+"img/fav.ico",n.tag=n.tag||"global",e(n.tag),a=""+a,n.body=""+n.body;var r=i.createNotification(a,n);s.push(r);var o=r.notification;return o.onclose=function(){var e=s.indexOf(r);e!==-1&&s.splice(e,1)},o.onclick=function(){o.onclose(),n.onClick&&n.onClick()},r}},this.closeAll=function(){for(var e=s.length-1;e>=0;e--)s[e].close();s=[]};var a=this;window.onunload=window.onbeforeunload=function(){a.closeAll()}}}(window.Application,window.chatConfig,window.notify),function(e,t){e.service.i18n={trans:function(e,i){var s=t.trans[e];if("undefined"==typeof s)return"* "+e+" *";if(i)for(var a in i)s=s.split(a).join(i[a]);return s}}}(window.Application,window.chatConfig),function(e,t,i){function s(){}s.prototype={constructor:s,display:function(e,t){i.defaults(t||{},{width:256,height:256}),e.innerHTML="",new QRCode(e,{text:t.data,width:t.width,height:t.height,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}},e.QR=s}(window.Application,window.chatConfig,window._),function(e,t,i,s){var a=s.map(i.messageSounds,function(e,t){return{value:e,label:t}}),n=s.map(i.languages,function(e,t){return{value:e,label:e}}),r=e.UISettingsModel=Backbone.Collection.extend({initialize:function(){this.set({settings:i.ui},{parse:!0}),this.prevJSON=this.toJSON()},fetch:function(){var e=this;t.get(i.getSettingsPath,function(t){t.success&&e.set(e.parse(t),{remove:!1})})},save:function(){arguments.length>0&&this.set.apply(this,arguments),this.trigger("request");var e=this;t.post(i.updateSettingsPath,this.changedJSON(),function(){e.prevJSON=e.toJSON(),e.trigger("sync")})},reset:function(e){var s=this,a={};e&&(a.keys=e.join(",")),t.post(i.resetSettingsPath,a,function(e){e.success&&(s.set(s.parse(e),{remove:!1}).trigger("change"),s.prevJSON=s.toJSON())})},validate:function(e,t){var i={},s=!1;if(this.forEach(function(e){var t=e.get("meta");if(t){var a=t.validators,n=t.errorMessage;if(a)for(var o=0;o<a.length;o++){var l=r.validators[a[o]];l(e.get("value"))||(i[e.get("name")]=n,s=!0)}}}),s)return i},parse:function(e){return e.settings=s.map(e.settings,function(e,t){return{id:t,name:t,value:e,meta:r.schema[t]}}),e.settings=s.filter(e.settings,function(e,t){return e}),e.settings},toJSON:function(){var e={};return this.forEach(function(t){e[t.get("name")]=t.get("value")}),e},changedJSON:function(){var e={};return this.forEach(function(t){var i=t.get("name"),s=t.get("value");this.prevJSON[i]!==s&&(e[i]=s)},this),e}},{schema:{defaultLanguage:{type:"select",label:e.service.i18n.trans("default.language"),options:n,tags:["general"]},contactMail:{type:"text",label:e.service.i18n.trans("contact.mail"),validators:["notEmpty","mail"],tags:["general"]},chatBoxMedia:{type:"select",label:e.service.i18n.trans("media.in.chat"),tags:["general"],options:[{value:"auto",label:e.service.i18n.trans("display.auto")},{value:"manual",label:e.service.i18n.trans("display.clicked")},{value:"off",label:e.service.i18n.trans("turn.off")}]},maxConnections:{type:"text",label:e.service.i18n.trans("max.conn"),validators:["notEmpty","number"],tags:["general"]},pollingInterval:{type:"text",label:e.service.i18n.trans("poll.interval"),validators:["notEmpty","number"],tags:["general"]},operatorInitChat:{type:"checkbox",label:e.service.i18n.trans("operator.init.chat"),tags:["general"]},onlineTrackInterval:{type:"text",label:e.service.i18n.trans("online.track.int"),validators:["notEmpty","number"],tags:["general"]},messageSound:{type:"sound",label:e.service.i18n.trans("msg.sound"),options:a,tags:["general"]},systemMessageSound:{type:"sound",label:e.service.i18n.trans("sys.msg.sound"),options:a,tags:["general"]},fileSharing:{type:"select",label:e.service.i18n.trans("file.sharing"),tags:["general"],options:[{value:"true",label:e.service.i18n.trans("allow")},{value:"false",label:e.service.i18n.trans("turn.off")}]},sharedFileMaxSize:{type:"text",label:e.service.i18n.trans("shared.max.size"),validators:["notEmpty","decimal"],tags:["general"]},gMapsKey:{type:"text",label:e.service.i18n.trans("gmaps.key"),tags:["general"]},widgetTheme:{type:"widgetTheme",label:e.service.i18n.trans("widget.theme"),options:i.widgetThemes,tags:["widget"]},widgetSide:{type:"select",label:e.service.i18n.trans("widget.side"),tags:["widget"],options:[{value:"left",label:e.service.i18n.trans("left")},{value:"right",label:e.service.i18n.trans("right")}]},widgetOffset:{type:"text",label:e.service.i18n.trans("widget.offset"),validators:["notEmpty","number"],tags:["widget"]},primaryColor:{type:"color",label:e.service.i18n.trans("primary.color"),validators:["notEmpty","color"],tags:["widget"]},secondaryColor:{type:"color",label:e.service.i18n.trans("secondary.color"),validators:["notEmpty","color"],tags:["widget"]},labelColor:{type:"color",label:e.service.i18n.trans("label.color"),validators:["notEmpty","color"],tags:["widget"]},widgetWidth:{type:"text",label:e.service.i18n.trans("widget.width"),validators:["notEmpty","number"],tags:["widget"]},widgetHeight:{type:"text",label:e.service.i18n.trans("widget.height"),validators:["notEmpty","number"],tags:["widget"]},askForMail:{type:"checkbox",label:e.service.i18n.trans("ask.mail"),tags:["widget"]},mobileBreakpoint:{type:"text",label:e.service.i18n.trans("mobile.bp"),validators:["notEmpty","number"],tags:["widget"]},hideWhenOffline:{type:"checkbox",label:e.service.i18n.trans("hide.offline"),tags:["widget"]},autoShowWidget:{type:"select",label:e.service.i18n.trans("show.widget.auto"),tags:["widget"],options:[{value:"true",label:e.service.i18n.trans("every.refresh")},{value:"once",label:e.service.i18n.trans("first.visit")},{value:"untilAction",label:e.service.i18n.trans("until.hide")},{value:"off",label:e.service.i18n.trans("turn.off")}]},autoShowWidgetAfter:{type:"text",label:e.service.i18n.trans("show.widget.after"),validators:["notEmpty","number"],tags:["widget"]}},validators:{mailExp:/^[-+\.0-9=a-z_]+@([-0-9a-z]+\.)+([0-9a-z]){2,}$/i,colorExp:/^#(([0-9a-fA-F]{3})|([0-9a-fA-F]{6}))$/,numberExp:/^\d+$/,decimalExp:/^\d+(\.\d+)?$/,notEmpty:function(e){return e&&(e+"").length>0},mail:function(e){return r.validators.mailExp.test(""+e)},number:function(e){return r.validators.numberExp.test(""+e)},decimal:function(e){return r.validators.decimalExp.test(""+e)},color:function(e){return r.validators.colorExp.test(""+e)}}})}(window.Application,jQuery,window.chatConfig,_),function(e,t,i){e.LogsModel=Backbone.Model.extend({fetch:function(){this.trigger("request");var e=this;t.get(i.getLogsPath,function(t){e.set("content",t),e.trigger("sync")})},set:function(e,t){var i="string"==typeof this.attributes[e]?this.attributes[e].length:0;this.attributes[e]=t;var s="string"==typeof this.attributes[e]?this.attributes[e].length:0;s!==i&&(this.trigger("change:"+e,this,this.attributes[e]),this.trigger("change",this))},clear:function(e,s){this.trigger("request");var a=this;t.get(i.clearLogsPath,function(t){t.success?(a.set("content",""),a.trigger("sync"),e&&e()):s&&s()})}})}(window.Application,jQuery,window.chatConfig),function(e,t,i,s){e.DepartmentsModel=Backbone.Model.extend({defaults:{departments:[]},initialize:function(){this.user=e.model.user,this.fetch()},fetch:function(){var e=this;t.get(i.listDepartmentsPath,function(t){if(t.success){for(var i=t.results.length-1;i>=0;i--){var s=t.results[i];s.operators||(s.operators=[])}e.set("departments",t.results)}})},saveDepartment:function(e){this.trigger("request");var s=this;t.post(i.updateDepartmentPath,e,function(t){t.success?(t.id&&(e.id=t.id,s.getById(t.id)||s.get("departments").push(e)),s.trigger("sync department:saved change:departments change",e)):s.trigger("department:saveError",t.errors)})},getById:function(e){for(var t=this.get("departments"),i=0;i<t.length;i++)if(t[i].id===e)return t[i];return null},deleteDepartment:function(e){for(var s=this.get("departments"),a=0;a<s.length;a++)if(s[a].id===e){s.splice(a,1);break}var n=this;t.post(i.deleteDepartmentPath,{id:e},function(e){e.success?n.trigger("change:departments department:deleted"):n.trigger("department:deleteError")})}})}(window.Application,jQuery,window.chatConfig,_),function(e,t,i,s){e.CannedMessagesModel=Backbone.Model.extend({defaults:{messages:[]},initialize:function(){this.user=e.model.user,this.fetch()},fetch:function(){var e=this;t.get(i.listCannedMessagesPath,function(t){t.success&&e.set("messages",t.messages)})},saveMessage:function(e){this.trigger("request");var s=this;t.post(i.updateCannedMessagePath,e,function(t){t.success?(t.id&&(e.id=t.id,s.getById(t.id)||s.get("messages").push(e)),s.trigger("sync message:saved change:messages change",e)):s.trigger("message:saveError",t.errors)})},getById:function(e){for(var t=this.get("messages"),i=0;i<t.length;i++)if(t[i].id==e)return t[i];return null},deleteMessage:function(e){for(var s=this.get("messages"),a=0;a<s.length;a++)if(s[a].id===e){s.splice(a,1);break}var n=this;t.post(i.deleteCannedMessagePath,{id:e},function(e){e.success?n.trigger("change:messages message:deleted"):n.trigger("message:deleteError")})},getParametrizedMessage:function(e){var t=s.template(e,void 0,{safeUndefines:!0,interpolate:/\{(.+?)\}/g});return t(this.user.attributes)}})}(window.Application,jQuery,window.chatConfig,_),function(e,t){e.AdminSettingsModel=Backbone.Model.extend({defaults:{sound:!0,scroll:!0,emots:!0,media:!0},initialize:function(){this.fetch(),this.on("change",this.save,this)},save:function(){try{localStorage.setItem("customer-chat-admin-settings",JSON.stringify(this.attributes))}catch(e){}},fetch:function(){var e=localStorage.getItem("customer-chat-admin-settings");e&&this.set(JSON.parse(e))}})}(window.Application,jQuery),function(e,t){var i=e.MessageModel=Backbone.Model.extend({defaults:{author:"",body:"",toAuthor:"all",toAuthorMail:""},initialize:function(t,s){if(this.options=s||{},t){if("string"==typeof t.datetime?this.set("time",new Date(t.datetime.replace(/-/g,"/"))):"object"==typeof t.datetime&&this.set("time",t.datetime),"string"==typeof t.from_user_info&&"all"!==t.from_user_info)try{t.from_user_info=JSON.parse(t.from_user_info)}catch(a){}if("object"==typeof t.from_user_info){var n=t.from_user_info;this.fromUser=n,0===this.get("author").length&&this.set("author",n.name),this.has("authorMail")||this.set("authorMail",n.mail)}if("string"==typeof t.to_user_info&&"all"!==t.to_user_info)try{t.to_user_info=JSON.parse(t.to_user_info)}catch(a){}if("object"==typeof t.to_user_info){var r=t.to_user_info;this.toUser=r,this.set("toAuthor",r.name),this.set("toAuthorMail",r.mail)}if(t.extra&&"string"==typeof t.extra)try{t.extra=JSON.parse(t.extra)}catch(a){}if(t.from_id==i.USER_ID_SYSTEM){this.set("authorType","system"),this.set("author","SYSTEM"),this.fromUser={name:"SYSTEM"};var o=this.getSystemMessageBody(t.extra);o&&(t.body=o)}if(t.extra&&t.extra.type===i.EXTRA_FILES)if(t.upload){var l=e.model.watchedUploads.get(t.upload.id);l?this.upload=l:this.upload=new e.UploadModel(t.upload),e.model.watchedUploads.add(this.upload)}else this.upload=new e.UploadModel({files_info:t.extra.files}),e.model.watchedUploads.add(this.upload);this.set(t)}},getAge:function(){var e=Math.floor((new Date).getTime()/1e3),i=Math.floor(this.get("time").getTime()/1e3-(this.options.localMessage?0:t.serverTimeDifference));return Math.ceil(e-i)},getTime:function(){return new Date(this.get("time").getTime()-(this.options.localMessage?0:1e3*t.serverTimeDifference))},getReadableName:function(){var e=this.get("author");return e.lastIndexOf("-")!==-1?e.slice(0,e.lastIndexOf("-")):e},getToUserReadableName:function(){var e=this.get("toAuthor");return e.lastIndexOf("-")!==-1?e.slice(0,e.lastIndexOf("-")):e},getTalkName:function(){var e=this.get("toAuthor");return this.getReadableName()+(e?"/"+(e.lastIndexOf("-")!==-1?e.slice(0,e.lastIndexOf("-")):e):"")},isSystemMessage:function(){return this.get("from_id")==i.USER_ID_SYSTEM},getSystemMessageBody:function(t){var s=e.service.i18n;switch(t.type){case i.EXTRA_TALK_CLOSE:return t.user?s.trans("sm.closed.talk",{"%user%":t.user}):s.trans("sm.user.closed.chat");case i.EXTRA_TALK_OWNER:return s.trans("sm.now.talk.owner",{"%user%":t.user});case i.EXTRA_USER_INVITE:return s.trans("sm.user.invited",{"%name%":t.name,"%mail%":t.mail});case i.EXTRA_USER_LEAVE:return s.trans("sm.user.left",{"%name%":t.name,"%mail%":t.mail})}return null}},{TO_ID_ALL:-1,USER_ID_SYSTEM:-2,EXTRA_USER_INVITE:"user_invite",EXTRA_USER_LEAVE:"user_leave",EXTRA_TALK_START:"talk_start",EXTRA_TALK_CLOSE:"talk_close",EXTRA_TALK_OWNER:"talk_owner",EXTRA_FILES:"files"})}(window.Application,window.chatConfig),function(e,t,i){e.SharedFileModel=Backbone.Model.extend({})}(window.Application,window.chatConfig,jQuery),function(e,t){var i=Backbone.Model.extend({defaults:{message_id:null,state:null,files_info:null,size:null,progress:0},url:function(){var e=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?e:e+"&id="+encodeURIComponent(this.id)},initialize:function(e,t){var i=this.get("size"),s=this.get("files_info");if("string"==typeof s)try{s=JSON.parse(s),this.set("files_info",s,{silent:!0})}catch(a){}if(!i&&s){i=0;for(var n=0;n<s.length;n++)i+=s[n].size;this.set("size",i,{silent:!0})}},deny:function(e){this._requestAndUpdate(t.denyUploadPath,{id:this.get("id")},e)},confirm:function(e){this._requestAndUpdate(t.confirmUploadPath,{id:this.get("id")},e)},abort:function(e){this._requestAndUpdate(t.abortUploadPath,{id:this.get("id")},e)},_requestAndUpdate:function(e,t,i){var s=this;$.post(e,t,function(e){e.success&&s.set(e.upload),i&&i(e)})},isSettled:function(){return[i.STATE_PENDING,i.STATE_UPLOADING,null].indexOf(this.get("state"))===-1},isUnused:function(){for(var e in this._events){if("all"!==e)return!1;if(this._events[e].length>1)return!1}return!0}},{STATE_PENDING:"pending",STATE_ABORTED:"aborted",STATE_DENIED:"denied",STATE_ERROR:"error",STATE_UPLOADING:"uploading",STATE_UPLOADED:"uploaded"});e.UploadModel=i}(Application,chatConfig),function(e,t,i){var s=e.UserModel=Backbone.Model.extend({initialize:function(e){if(e.info&&"string"==typeof e.info)try{e.info=JSON.parse(e.info)}catch(t){}},getAge:function(){this.chat=e.model.chat;var t=(new Date).getTime()/1e3,i=this.get("time").getTime()/1e3;return Math.ceil(t-i)},getReadableName:function(){var e=this.get("name");return this.hasRole("OPERATOR")?e:e.lastIndexOf("-")!==-1?e.slice(0,e.lastIndexOf("-")):e},hasRole:function(e){return this.has("roles")&&this.get("roles").indexOf(e)!==-1},isOnline:function(){var e=new Date(this.get("last_activity").replace(/-/g,"/"))/1e3-t.serverTimeDifference,i=(new Date).getTime()/1e3;return i-e<=s.ONLINE_TIME}},{ONLINE_TIME:30,usersCache:{},cacheUsers:function(t){for(var i=0;i<t.length;i++){var s=t[i];this.usersCache[s.id]=new e.UserModel(s)}},updateUsersCache:function(e){for(var t=0;t<e.length;t++){var i=e[t],s=i.get("id"),a=this.usersCache[s];a?a.set(i.attributes):this.usersCache[s]=i}},getUser:function(s,a){if(this.usersCache[s])return void a(this.usersCache[s]);var n=this;return i.get(t.getUsersPath,{ids:[s]},function(t){t.success&&(n.usersCache[s]=new e.UserModel(t.users[s]),a(n.usersCache[s]))}),!1},getUsers:function(s,a,n){for(var r={},o=[],l=0;l<s.length;l++){var h=s[l];this.usersCache[h]?r[h]=this.usersCache[h]:o.push(h)}if(0===o.length)return a(r),!0;var d=this;return i.get(t.getUsersPath,{ids:o},function(t){if(t.success){for(var i in t.users)d.usersCache[i]=r[i]=new e.UserModel(t.users[i]);a(r)}else n&&n(t)}),!1},getUserSync:function(e){return this.usersCache[e]},addShortUrl:function(e){var t=e.info&&e.info.referer;if(t){var i=t.split("/");i.splice(0,2),i.length>2?e.shortUrl=i[0]+"/../"+i.pop():e.shortUrl=i[0]+"/"+i.pop()}else e.shortUrl=""},extendUserData:function(e,t){this.addShortUrl(e);var i=e.info;if(i){e.url=i.referer,e.ip=i.ip;var s=i.geoloc;s?(e.countryCode=s.countryCode,e.countryName=s.countryName,e.city=s.city):(e.countryCode=null,e.countryName=null,e.city=null)}}});e.UserModel.usersCache[-1]=new e.UserModel({id:-1,name:"all"}),e.UserModel.usersCache[-2]=new e.UserModel({id:-2,type:"system",name:"SYSTEM"})}(window.Application,window.chatConfig,jQuery),function(e,t,i,s){e.ChatViewModel=Backbone.Model.extend({defaults:{name:"anonymous",mail:""}})}(window.Application,jQuery,window.chatConfig,_),function(e,t,s,a){var n=e.AdminChatModel=Backbone.Model.extend({defaults:{name:"anonymous",mail:"",status:null},usersCache:{},guestsCache:{},onlineUsers:[],lastMessageId:0,operatorsReady:!1,lastTypingUpdate:0,talkingUsersIds:[],watchTalkIds:[],talks:{},userTalkMap:{},globalTalks:{},invitingVisitors:{},initialize:function(){this.user=e.model.user,this.set("status",n.STATUS_OFFLINE),this.once("change:operators",function(){this.operatorsReady=!0},this),this.on("user:store",this.handleTypingUser,this),this.startConnection()},getTalk:function(e){return this.talks[e]},getGlobalTalk:function(e){return this.globalTalks[e]},clearGlobalTalk:function(e){delete this.globalTalks[e]},moveGlobalTalk:function(e,t){var i=this.getGlobalTalk(e),s=this.getTalk(t);if(i){if(s)for(var a=0;a<i.length;a++)s.unshift(i[a]);else this.talks[t]=i;this.clearGlobalTalk(e)}},getTalkIdForGuest:function(e){return this.userTalkMap[e]},getTalkIdForUsers:function(e,t){return this.userTalkMap[e+"_"+t]},getTalkIdForUser:function(e){if(this.userTalkMap[e])return this.userTalkMap[e];var t=parseInt(this.user.get("id")),i=parseInt(e);return t>i&&(i=t,t=e),this.userTalkMap[t+"_"+i]},getUserIdForTalk:function(e){for(var t in this.userTalkMap)if(e==this.userTalkMap[t])return t;return null},getTalkParticipants:function(t,i){t||i([]);for(var s=[],a=0;a<t.length;a++)t[a].from_id!=-2&&s.indexOf(t[a].from_id)===-1&&s.push(t[a].from_id);var n=[];e.UserModel.getUsers(s,function(e){for(var t=0;t<s.length;t++)n.push(e[s[t]]);i(n)})},isParticipantInTalk:function(e,t){var i=this.getTalk(t);if(i)for(var s=i.length-1;s>=0;s--)if(i[s].from_id==e)return!0;return!1},getTalkOwner:function(t){var i=this.getTalk(t);if(i)for(var s=i.length-1;s>=0;s--){var a=i[s],n=a.extra;if(n&&n.type===e.MessageModel.EXTRA_TALK_OWNER)return n.id}return null},isTalkOwner:function(e,t){return this.getTalkOwner(e)==t},getTalkName:function(t,i){var s=this.getUserIdForTalk(t);if(s&&s.toString().indexOf("_")===-1)return void e.UserModel.getUser(s,function(e){i(e.getReadableName())});var a=this.user.get("id");if(talk=this.getTalk(t),name,talk){for(var n=0,r=talk.length;n<r;n++){var o=talk[n];if(o.from_id!=-2&&o.from_id!=a){name=new e.UserModel(o.from_user_info).getReadableName();break}}name?i(name):e.UserModel.getUser(talk[0].to_id,function(e){i(e.getReadableName())})}else this.on("messages:new",function l(e){e.indexOf(t.toString())!==-1&&(this.off("messages:new",l),this.getTalkName(t,i))},this)},inviteUserToTalk:function(e,i,a,n){t.post(s.inviteToTalkPath,{talkId:e,userId:i,guestId:a},n)},leaveTalk:function(e,i,a,n){"undefined"==typeof a&&(a=!1),e=parseInt(e),isNaN(e)?e=void 0:this.unwatchTalk(e);var r=t.post(s.leaveTalkPath,{talkId:e,guestId:i,silent:a});n&&r.then(n)},closeTalk:function(e,i,a){e=parseInt(e),isNaN(e)?e=void 0:this.unwatchTalk(e),t.post(s.closeTalkPath,{talkId:e,guestId:i},a)},transferTalk:function(e,i,a){t.post(s.transferTalkPath,{talkId:e,newOwnerId:i},a)},onUsers:function(t,i){var s=[];this.onlineUsers=[];for(var a=0,n=t.length;a<n;a++)s.push(t[a]),this.onlineUsers.push(new e.UserModel(t[a]));for(this.clearUnusedInvites(i),a=0,n=i.length;a<n;a++){var r=this.initVisitor(i[a]);s.push(r),this.onlineUsers.push(new e.UserModel(r))}this.trigger("users:online",this.onlineUsers)},handleTypingUser:function(e){this.talkingUsersIds.indexOf(e.id)===-1&&this.talkingUsersIds.push(e.id)},updateTypingStatus:function(e){var i=(new Date).getTime();this.lastTypingUpdate+n.POLLING_INTERVAL<i&&(this.lastTypingUpdate=i,t.post(s.updateTypingStatusPath,{talkId:e,status:!0}))},getTypingStatus:function(e){if(this.talkingUsersIds.length>0){var i=this,a=t.post(s.getTypingStatusPath,function(e){if(e.success){var t=i.filterTyping(e.results);t.length>0&&i.trigger("talks:typing",t)}});e&&a.always(e)}else e&&e()},filterTyping:function(e){var t=[];for(var i in e)e[i]&&t.push(parseInt(i));return t},onTalks:function(t){var i=[],s=[],a=[];for(var n in t){for(var r=this.talks[n],o=t[n],l=0;l<o.length;l++)s.indexOf(o[l].from_id)===-1&&s.push(o[l].from_id),a.push(o[l]);if(r){for(var l=0;l<o.length;l++)r.push(o[l]);this.updateLastMessageId(o[o.length-1].id),i.push(n)}else this.talks[n]=o,this.updateLastMessageId(o[o.length-1].id),i.push(n)}if(i.length>0){var h=this;e.UserModel.getUsers(s,function(){h.addUserInfoToMessages(a,function(){h.trigger("messages:new",i)},!1)})}},onUploads:function(t){t=a.values(t),t.length>0&&e.model.watchedUploads.set(t,{remove:!1})},addUserInfoToMessages:function(t,i,s){"undefined"==typeof s&&(s=!0);for(var a=[],n=0;n<t.length;n++)a.indexOf(t[n].from_id)===-1&&a.push(t[n].from_id),s&&a.indexOf(t[n].to_id)===-1&&a.push(t[n].to_id);e.UserModel.getUsers(a,function(e){for(var a=0;a<t.length;a++)t[a].from_user_info=e[t[a].from_id].attributes,s&&(t[a].to_user_info=e[t[a].to_id].attributes);i&&i()})},getLastMessages:function(e,i,a){t.post(s.lastMessagesPath,{lastMsgId:i,guestId:e}).success(function(e){a(e.messages)}).fail(function(){a([])})},storeUser:function(e){this.usersCache[e.id]=e,this.trigger("user:store",e)},storeGuest:function(e){this.guestsCache[e.id]=e},clearOperator:function(e){delete this.usersCache[e.id]},clearGuest:function(e){delete this.guestsCache[e.id]},loadOperators:function(){var e=this;t.get(s.listOperatorsPath,function(t){a.each(t.users,function(t){t.departments||(t.departments=[]),e.storeUser(t)}),e.trigger("change:operators")})},getOperators:function(){var e=[];for(var t in this.usersCache)e.push(this.usersCache[t]);return e},getOperator:function(e){return this.usersCache[e]},getGuest:function(e){return this.guestsCache[e]},initVisitor:function(e){var t={anonymous:!0,name:e.name,roles:["GUEST"],info:{referer:e.url}},i=this.invitingVisitors[t.name];return i&&(t.inviting="inviting"===i,t.invited="invited"===i,t.inviteError="error"===i),t},inviteVisitor:function(e){var i=e.get("name");if(!this.invitingVisitors[i]){this.invitingVisitors[i]="inviting",e.set("inviting",!0);var a=this;t.post(s.trackLoginPath,{name:i}).done(function(e){a.invitingVisitors[i]="invited"}).fail(function(){a.invitingVisitors[i]="error"})}},clearUnusedInvites:function(e){for(var t in this.invitingVisitors){var s=!1;for(i=0,l=e.length;i<l;i++)if(e[i].name==t){s=!0;break}s||delete this.invitingVisitors[t]}},saveOperator:function(e){var i=a.clone(e);i.roles=i.roles.join(",");var n=this;t.post(s.saveOperatorPath,i,function(t){t.success?(t.id&&(e.id=t.id),n.storeUser(e),n.trigger("change:operators operator:saved",e)):n.trigger("operator:saveError",t.errors)})},deleteOperator:function(e){this.clearOperator(e);var i=this;t.post(s.deleteOperatorPath,e,function(e){e.success?i.trigger("change:operators operator:deleted"):i.trigger("operator:deleteError")})},loadUsersData:function(e,i){for(var a=this,n=0,r=0;r<e.length;r++){var o=e[r];this.usersCache[o.from_id]||(n++,t.post(s.getUserPath,{id:o.from_id}).success(function(e){e.success&&a.storeUser(e.user)}).always(function(){n--,n<=0&&i()}))}n<=0&&i()},getOperatorName:function(e){return this.usersCache[e]&&this.usersCache[e].name},queryHistory:function(e,i,a){t.post(s.queryHistoryPath,{query:JSON.stringify(e)},function(e){i(e)}).fail(a)},clearHistory:function(e,i){t.post(s.clearHistoryPath,function(t){t.success?e(t):i(t)},"JSON").fail(i)},sendMessage:function(e,i){var a={talk_id:e.get("talk_id"),to:e.get("to"),body:e.get("body"),extra:JSON.stringify(e.get("extra"))},n=this;t.post(s.sendMessagePath,a,function(e){if(e.success){var t=n.getTalk(e.talk_id);t&&t.push(e.message),n.updateLastMessageId(e.message.id),n.watchTalk(e.talk_id,e.userTalkMapping),n.trigger("messages:sent",e.to,e.message),n.trigger("usertalkmap:update")}else n.trigger("messages:sendError");i&&i(e)})},mailTalkTranscript:function(e){return t.post(s.mailTalkTranscriptPath,e)},setStatus:function(e){switch(e){case n.STATUS_ONLINE:this.startConnection();break;case n.STATUS_OFFLINE:this.resetLastActivity(),this.stopConnection()}this.set("status",e)},resetLastActivity:function(e){return t.post(s.resetLastActivityPath)},startConnection:function(){this.initRequestsStatus(),this.stopConnection(),this.connectionTimer=setInterval(t.proxy(this.manageConnection,this),n.POLLING_INTERVAL),this.manageConnection(),this.set("status",n.STATUS_ONLINE)},stopConnection:function(){this.connectionTimer&&clearInterval(this.connectionTimer),this.set("status",n.STATUS_OFFLINE)},manageConnection:function(){if(this.prevRequestsComplete()){this.resetRequestsStatus();var e=this;this._manageConnection(function(){e.requestsStatus._manageConnection=!0}),this.user.hasRole("OPERATOR")?this.getTypingStatus(function(){e.requestsStatus.getTypingStatus=!0}):this.requestsStatus.getTypingStatus=!0}},_manageConnection:function(i){var a=this,n={lastMessageId:this.lastMessageId,watchedTalks:this.watchTalkIds.join(",")};e.model.watchedUploads.length>0&&(n.watchedUploads=e.model.watchedUploads.pluck("id").join(","));var r=t.post(s.manageConnectionPath,n,function(e){a.onUsers(e.users,e.visitors),a.user.hasRole("OPERATOR")&&(a.updateUserTalkMap(e.userTalkMap),a.trigger("usertalkmap:update"),a.onTalks(e.talks),a.onUploads(e.uploads))});i&&r.always(i)},watchTalk:function(e,t){e=parseInt(e),isNaN(e)||this.watchTalkIds.indexOf(e)!==-1||this.watchTalkIds.push(e);for(var i in t)this.userTalkMap[i]=t[i]},unwatchTalk:function(e){var t=this.watchTalkIds.indexOf(e);t!==-1&&this.watchTalkIds.splice(t,1)},updateUserTalkMap:function(e){e&&(this.userTalkMap=e);for(var t in e)this.moveGlobalTalk(t,e[t])},updateLastMessageId:function(e){e=parseInt(e),this.lastMessageId<e&&(this.lastMessageId=e)},prevRequestsComplete:function(){if(Date.now()-this.requestInitTime>n.REQUEST_STATUS_RESET_TIMEOUT)return this.initRequestsStatus(),!0;for(var e in this.requestsStatus)if(!this.requestsStatus[e])return!1;return this.requestInitTime=Date.now(),!0},initRequestsStatus:function(){this.requestInitTime=Date.now(),this.requestsStatus={_manageConnection:!0,getTypingStatus:!0}},resetRequestsStatus:function(){for(var e in this.requestsStatus)this.requestsStatus[e]=!1}},{STATUS_ONLINE:"online",STATUS_OFFLINE:"offline",POLLING_INTERVAL:1e3*parseInt(s.ui.pollingInterval),REQUEST_STATUS_RESET_TIMEOUT:2e4})}(window.Application,jQuery,window.chatConfig,_),function(e,t){var i=Backbone.Collection.extend({url:t.uploadCrudPath,model:e.UploadModel,parse:function(e){if(e.success)return e.uploads},initialize:function(){this.on("add",this.onAdd,this),this.on("remove",this.onRemove,this),_.bindAll(this,"removeUnused")},set:function(){Backbone.Collection.prototype.set.apply(this,arguments),setTimeout(this.removeUnused,0)},removeUnused:function(){for(var e=this.models.length-1;e>=0;e--){var t=this.models[e];(t.isSettled()||t.isUnused())&&this.remove(t)}}});e.WatchedUploadsCollection=i}(Application,chatConfig),function(e,t){var i=e.ActionController=function(){};t.extend(i.prototype,{run:function(e,t){this.actions[e]&&this.actions[e].apply(this,t)},actions:{showTalk:function(t){e.trigger("talk.show",t)},mailTalkTranscript:function(t,i){var s=new e.MailTranscriptView,a={},n=this;a[e.service.i18n.trans("send")]=function(){var i=$(this);if(s.isValid()){e.view.dialogs.message(e.service.i18n.trans("uploading"),e.service.i18n.trans("uploading"));var a=s.getData();a.talkId=t,e.model.chat.mailTalkTranscript(a).success(function(e){e.success?n._mailTranscriptOnSuccess():n._mailTranscriptOnError()}.bind(n)).fail(n._mailTranscriptOnError.bind(n)),i.dialog("close"),s.destroy()}},e.view.dialogs.confirm(e.service.i18n.trans("mailTranscriptHeader"),s,a,300),i&&i!==e.service.i18n.trans("empty.mail.placeholder")&&s.reset(i)}},_mailTranscriptOnSuccess:function(){e.view.dialogs.message(e.service.i18n.trans("contactSuccessHeader"),e.service.i18n.trans("mailTranscriptSuccess"))},_mailTranscriptOnError:function(){e.view.dialogs.message(e.service.i18n.trans("error"),e.service.i18n.trans("mailTranscriptError"))}})}(window.Application,_),function(e,t){e.MailTranscriptView=Marionette.ItemView.extend({getTemplate:function(){return e.template.mailTalkTranscript},mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),mailValid:!1,ui:{form:".form",mail:"#customer-chat-transcript-mail"},events:{"input   @ui.mail":"validateMail","change  @ui.mail":"validateMail","keydown @ui.mail":"validateMail","blur    @ui.mail":"validateMail"},initialize:function(){this.bindUIElements()},getData:function(){return{mail:this.ui.mail.val()}},reset:function(e){this.ui.mail.val(e||""),this.ui.mail.removeClass("customer-chat-input-error")},focus:function(){this.ui.mail.focus()},validateMail:function(){0!=this.ui.mail.val().length&&this.mailExp.test(this.ui.mail.val())?(this.ui.mail.removeClass("customer-chat-input-error"),this.mailValid=!0):(this.ui.mail.addClass("customer-chat-input-error"),this.mailValid=!1)},isValid:function(){return this.validateMail(),this.mailValid},getHeight:function(){return this.ui.form.height()}})}(window.Application,jQuery),function(e,t,i){var s=e.AvatarView=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change",this.render),this.render()},render:function(){if(this.$el.html(""),this.model.isSystemMessage()){var t=s.INFO,a=this.model.get("extra");if(a)switch(a.type){case e.MessageModel.EXTRA_TALK_OWNER:t=s.OWNER;break;case e.MessageModel.EXTRA_USER_INVITE:t=s.INVITE;break;case e.MessageModel.EXTRA_USER_LEAVE:t=s.LEAVE;break;case e.MessageModel.EXTRA_TALK_CLOSE:t=s.CLOSE}var n=i("<i>").addClass("fa fa-"+t.icon).addClass(t.className);this.$el.append(n),this.$el.css("background-image","none")}else this.$el.removeClass("customer-chat-content-message-avatar").addClass("customer-chat-content-message-avatar-operator"),this.model.fromUser&&this.model.fromUser.image&&this.$el.css("background-image",'url("'+this.model.fromUser.image+'")')}},{INFO:{icon:"info",className:"avatar-info"},OWNER:{icon:"user",className:"avatar-owner"},INVITE:{icon:"sign-in",className:"avatar-invite"},LEAVE:{icon:"sign-out",className:"avatar-leave"},CLOSE:{icon:"power-off",className:"avatar-close"}})}(window.Application,window.chatConfig,jQuery),function(e,t,i){var s=/(((http(s)?:(?:\/\/)?)(?:[\-;:&=\+\$,\w]+@)?[A-Za-z0-9\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[A-Za-z0-9\.\-]+)((?:\/[\+~%\/\.\w\-_*\[\]]*)?\??(?:[\-\+=&;%@\.\w_\[\]]*)#?(?:[\.\!\/\\\w=]*))?)/,a=/(png|gif|jpg|jpeg)$/i,n=/youtube.com\/(?:watch\?v=|v\/)([^&\/?]+)|youtu.be\/([^&\/?]+)/i,r=/vimeo.com\/(?:[\w\/]+\/)*([\d]+)/i,o=e.MessageView=Backbone.View.extend({
initialize:function(){this.subviews=[],this.options.prevMessage&&(this.prevMessage=this.options.prevMessage,this.model.get("from_id")==this.prevMessage.get("from_id")&&(this["short"]=!0)),this.settings=e.model.settings,this.listenTo(this.model,"change",this.render),this.render(),this.$el.hide(),this.$el.fadeIn("fast")},render:function(){this.$el.html(e.template.message({author:this.model.getReadableName()||this.model.get("author"),isSystem:this.model.isSystemMessage(),isOperator:"operator"==this.model.get("authorType")})),this.$time=this.$(".customer-chat-content-message-time"),this.buildBody(this.$(".customer-chat-content-message-body")),this.updateTime(!0),this["short"]&&!this.model.isSystemMessage()?(this.$el.addClass("short"),this.prevMessage.getAge()-this.model.getAge()<o.VISIBLE_AGE_LIMIT&&this.$time.hide()):new e.AvatarView({el:this.$(".avatar")[0],model:this.model})},buildBody:function(i){var a=this.model.get("extra");if(a&&a.type===e.MessageModel.EXTRA_FILES)return void i.append(this.storeSubview(o.createFileView(this.model)));for(var n,r=this.settings.get("emots"),l=this.model.get("body").split("<").join("&lt;").split(">").join("&gt;"),h="off"!==t.ui.chatBoxMedia;n=s.exec(l);){var d=l.slice(0,n.index),c=n.index,u=n[0],m=u,p=!0;if(u.indexOf("@")>-1?u="mailto:"+u:u.indexOf("://")===-1&&(u="http://"+u),l=l.slice(c+u.length),d.length>0&&i.append(r?o.addEmoticons(d):d),h)if(o.isImageLink(u))i.append(this.storeSubview(o.createImageView(u))),p=!1;else{var f;(f=o.isYouTubeLink(u))?(i.append(this.storeSubview(o.createVideoView("youtube",u,f))),p=!1):(f=o.isVimeoLink(u))&&(i.append(this.storeSubview(o.createVideoView("vimeo",u,f))),p=!1)}p&&i.append(o.createLinkElement(m,u))}i.append(r?o.addEmoticons(l):l)},storeSubview:function(e){return this.subviews.push(e),e.el},updateTime:function(t){var i=this.model.getAge(),s=Math.floor(i/60),a=Math.floor(s/60),n=Math.floor(a/24),r=Math.floor(n/7),o=this.model.get("time"),l=(o.getDate()<10?"0":"")+o.getDate()+"."+(o.getMonth()+1<10?"0":"")+(o.getMonth()+1)+"."+o.getFullYear(),h=(o.getHours()<10?"0":"")+o.getHours()+":"+(o.getMinutes()<10?"0":"")+o.getMinutes()+":"+(o.getSeconds()<10?"0":"")+o.getSeconds(),d=l+" "+h;if(this.options.fullDate)return void this.$time.html(d);var c=r>0?d:n>0?n+" "+e.service.i18n.trans("timeDaysAgo"):a>0?a+" "+e.service.i18n.trans("timeHoursAgo"):s>0?s+" "+e.service.i18n.trans("timeMinutesAgo"):Math.max(i-i%5,1)+" "+e.service.i18n.trans("timeSecondsAgo");if(this.$time.html(c),t){var u=n>0?-1:a>0?60*(60-s%60)*60:s>5?60*(5-s%5):s>0?60:10-i%10;if(u==-1)return;var m=this;this.timerId=setTimeout(function(){m.updateTime(!0)},1e3*u)}},clean:function(){this.timerId&&clearTimeout(this.timerId);for(var e=0;e<this.subviews.length;e++)this.subviews[e].remove();return this}},{VISIBLE_AGE_LIMIT:300,EMOTICONS:{"&gt;:|":"emot emot-9","&gt;:D":"emot emot-10",":)":"emot emot-1",";)":"emot emot-2",":(":"emot emot-3",":D":"emot emot-4",":P":"emot emot-5","=)":"emot emot-6",":|":"emot emot-7","=|":"emot emot-8",o_O:"emot emot-11","=O":"emot emot-12","&lt;3":"emot emot-13",":S":"emot emot-14",":*":"emot emot-15",":$":"emot emot-16","=B":"emot emot-17",":-D":"emot emot-18",";-D":"emot emot-19","*-D":"emot emot-20"},addEmoticons:function(e){for(var t in o.EMOTICONS)e=e.split(t).join(o.createEmotElement(o.EMOTICONS[t]));return e},createEmotElement:function(e){return'<i class="'+e+'"></i>'},createLinkElement:function(e,t){return'<a href="'+t+'" target="_blank">'+e+"</a>"},createImageView:function(t){return new e.MessageImageView({url:t})},createVideoView:function(t,i,s){return new e.MessageVideoView({type:t,url:i,videoId:s})},createFileView:function(t){return new e.MessageFileView({message:t})},isYouTubeLink:function(e){var t=n.exec(e);return t?t[1]||t[2]:null},isVimeoLink:function(e){var t=r.exec(e);return t?t[1]:null},isImageLink:function(e){return a.test(e)}})}(window.Application,window.chatConfig,jQuery),function(e,t,i){e.MessageImageView=Backbone.View.extend({events:{"click .chat-inline-view":"showContent"},initialize:function(){this.settings=e.model.settings,this.render()},render:function(){var i=this.options.url;return this.$el.html(e.template.messageImage({url:i})),this.$imgLink=this.$(".chat-inline-view").attr("href","#"),this.$img=this.$imgLink.find(".image"),this.settings.get("media")?"auto"===t.ui.chatBoxMedia?this.showContent():(this.manualShow=!0,this.$el.addClass("manual-show")):this.$el.addClass("chat-inline-disabled"),this},showContent:function(e){this.contentShown||(this.manualShow&&(this.manualShow=!1,e&&e.preventDefault()),this.$imgLink.attr("href",this.options.url),this.$img.attr("src",this.options.url).bind("load",i.proxy(this.onLoad,this)),this.$el.removeClass("manual-show").addClass("loading"),this.contentShow=!0)},onLoad:function(){this.$el.removeClass("loading").trigger("contentUpdate")}})}(window.Application,window.chatConfig,jQuery),function(e,t,i){var s=e.MessageVideoView=Backbone.View.extend({events:{"click .chat-inline-view":"showContent"},initialize:function(){this.settings=e.model.settings,this.type=s.TYPES[this.options.type],this.render()},render:function(){var i=this.options.url,s=this.options.videoId;return this.$el.html(e.template.messageVideo({type:this.options.type,url:i,id:s,icon:this.type.icon})),this.$iframe=this.$("iframe"),this.settings.get("media")?"auto"===t.ui.chatBoxMedia?this.showContent():(this.manualShow=!0,this.$el.addClass("manual-show")):this.$el.addClass("chat-inline-disabled"),this},showContent:function(e){this.contentShown||(this.manualShow&&(this.manualShow=!1,e&&e.preventDefault()),this.$iframe.attr("src",this.type.url.replace("%id%",this.options.videoId)).bind("load",i.proxy(this.onLoad,this)),this.$el.removeClass("manual-show").addClass("loading"),this.contentShown=!0)},onLoad:function(){this.$el.removeClass("loading").trigger("contentUpdate")}},{TYPES:{youtube:{icon:"youtube-play",url:"//www.youtube.com/embed/%id%"},vimeo:{icon:"vimeo",url:"//player.vimeo.com/video/%id%"}}})}(window.Application,window.chatConfig,jQuery),function(e,t,i){var s=e.MessageFileView=Marionette.ItemView.extend({getTemplate:function(){return e.template.messageFile},templateHelpers:{fileSize:function(){return this.size?this.size<1024?this.size+" B":this.size<1048576?(this.size/1024).toFixed(2)+" kB":(this.size/1048576).toFixed(2)+" MB":""},fileIcon:function(){if(this.type)for(var e in s.mimeToIcon)if(this.type.indexOf(e)>-1)return s.mimeToIcon[e];return"file-o"},state:function(){var e=Array.prototype.slice.call(arguments,0,arguments.length-1),t=arguments[arguments.length-1];return e.indexOf(this.state)>-1?t.fn(this):t.inverse(this)},showConfirmDeny:function(e){return!this.isAuthor&&this.isOperator&&["pending","uploading",null].indexOf(this.state)>-1?e.fn(this):e.inverse(this)}},className:"file-message",ui:{progress:".progress-bar",abort:".abort",deny:".deny",confirm:".confirm",links:".download"},events:{"click @ui.abort":"abortUpload","click @ui.deny":"denyUpload","click @ui.confirm":"confirmUpload"},initialize:function(t){this.user=e.model.user||e.model.chat,this.message=t.message,this.upload=this.message.upload,this.message.uploader&&(this.uploader=this.message.uploader,_.bindAll(this,"onError","onAbort","onLoad","onProgress"),this.uploader.on("error",this.onError),this.uploader.on("abort",this.onAbort),this.uploader.on("load",this.onLoad)),this.listenTo(this.message.upload,"change:state",this.render),this.listenTo(this.message.upload,"change:progress",this.onProgress),this.template=this.getTemplate(),this.render()},render:function(){var t=this.upload&&this.upload.get("state");if(t===e.UploadModel.STATE_ERROR||t===e.UploadModel.STATE_UPLOADED||this.upload.previous("state")!==e.UploadModel.STATE_UPLOADED){var i=this.getFiles(),s=e.model.user&&e.model.user.hasRole("OPERATOR"),a=!!this.uploader;return this.$el.html(this.template({files:i,isAuthor:this.user.get("id")==this.message.get("from_id"),isUploading:a,isGuest:!e.model.user,isOperator:s,state:t,error:this.upload.get("error")},{helpers:this.templateHelpers})),this.$el.attr("class","file-message").addClass(t?t:"initial"),s?this.$el.addClass("operator"):a||this.$el.addClass("no-actions"),this.bindUIElements(),t===e.UploadModel.STATE_UPLOADED&&i&&this.setDownloadLinks(_.pluck(i,"id")),this.onProgress(this.upload,this.upload.get("progress")),this}},getFiles:function(){return this.upload.has("files")?this.upload.get("files"):this.message.get("extra").files},onError:function(){this.upload.set("state",e.UploadModel.STATE_ERROR)},onAbort:function(){this.uploader=null,this.upload.set("state",e.UploadModel.STATE_ABORTED)},onLoad:function(t){this.upload.set("state",e.UploadModel.STATE_UPLOADED),this.ui.progress.width("100%"),t=JSON.parse(t),t.success?this.setDownloadLinks(t.files):this.onError()},onProgress:function(e,t){var i=Math.floor(t/this.upload.get("size")*100);this.prevPercentage>i||(this.ui.progress.width(i+"%"),this.prevPercentage=i)},abortUpload:function(){this.upload.abort(),this.uploader.uploading?this.uploader.abort():this.onAbort()},denyUpload:function(){this.upload.deny()},confirmUpload:function(){this.upload.confirm()},setDownloadLinks:function(e){this.ui.links.each(function(s){i(this).attr("href",t.downloadFilePath+"&id="+e[s]).attr("target","_blank")})}},{mimeToIcon:{text:"file-text-o",pdf:"file-pdf-o",image:"file-image-o",audio:"file-audio-o",video:"file-video-o",word:"file-word-o",excel:"file-excel-o",spreadsheetml:"file-excel-o",powerpoint:"file-powerpoint-o",zip:"cube",tar:"cube"}})}(window.Application,window.chatConfig,window.jQuery),function(e,t){e.ChatBoxView=Backbone.View.extend({initialize:function(){this.settings=e.model.settings,this.$wrapper=this.$(".customer-chat-content-messages-wrapper"),this.$el.mCustomScrollbar(),this.messageViews=[],this.$el.bind("contentUpdate",t.proxy(this.updateScroller,this))},addMessage:function(t,i,s){var a;this.messageViews.length&&(a=this.messageViews[this.messageViews.length-1].model);var n=new e.MessageView({model:t,fullDate:this.options.fullDate,prevMessage:a});this.messageViews.push(n),this.$wrapper.append(n.el);var r=this;return setTimeout(function(){r.updateScroller(),s?i&&r.$el.mCustomScrollbar("scrollTo","bottom"):(r.settings.get("scroll")||i)&&r.$el.mCustomScrollbar("scrollTo","bottom")},200),n},clear:function(){for(var e=0;e<this.messageViews.length;e++)this.messageViews[e].remove().clean();this.$wrapper.html(""),this.messageViews=[]},updateScroller:function(){this.$el.mCustomScrollbar("update")},scrollToBottom:function(){this.$el.mCustomScrollbar("scrollTo","bottom")},storeScrollPos:function(){this.lastScrollPos=Math.abs(this.$(".mCSB_container").position().top)},scrollToLastPos:function(){this.$el.mCustomScrollbar("scrollTo",this.lastScrollPos)}})}(window.Application,jQuery),function(e,t){var i=Marionette.ItemView.extend({modelEvents:{change:"render"},events:{click:"onClick"},onClick:function(){this.trigger("click",this.model)},render:function(){var t=this.model.toJSON();return t.displayName=this.model.getReadableName(),e.UserModel.extendUserData(t,this.model),this.$el.html(e.template.onlineUsersItem(t)),this}});e.OnlineUsersItemView=i}(window.Application,window.chatConfig),function(e){var t=e.ParticipantView=Backbone.View.extend({events:{"click .show-on-map":"showOnMap"},initialize:function(){this.listenTo(this.model,"change",this.render),this.$el.html(e.template.userInfo()),this.$avatar=this.$(".customer-chat-content-message-avatar-operator"),this.$name=this.$(".info-name"),this.$id=this.$(".info-id"),this.$email=this.$(".info-email"),this.$('[class^="row-"]').addClass("empty"),this.render()},render:function(){var e=this.model;e.get("image")&&this.$avatar.css("background-image",'url("'+e.get("image")+'")'),this.$name.html(e.getReadableName()),this.$id.html(e.get("id")),this.$email.html(e.get("mail")),this.$('[class^="row-"].empty').hide();var i=e.get("info");if(i){for(var s in i){var a=i[s];if("object"==typeof a)for(var n in a){var r=a[n];this._renderInfo(t.infoToHtml(s,n),r)}else this._renderInfo(t.infoToHtml(s),a)}this._renderTime();var o=i.geoloc;o&&o.latitude&&o.longitude&&this.$(".row-show-on-map").show()}return this},_renderInfo:function(e,i){if(e&&i){var s=this.$(".row-"+e),a=s.find(".info-"+e),n=i;"string"==typeof i&&(n=i.slice(0,1).toUpperCase()+i.slice(1)),a.is("a")&&(a.attr("href",i),n=i),s.removeClass("empty").show(),a.html(n);var r=t.valueToIcon(i);r&&$("<i>").addClass("fa fa-"+r).prependTo(a)}},_renderTime:function(){var e=this.model.get("info");e.geoloc&&"number"==typeof e.geoloc.utcOffset&&(this.timeOffsetMs=60*((new Date).getTimezoneOffset()-e.geoloc.utcOffset)*1e3,this._renderTime=function(){},this.localTimeInterval=setInterval($.proxy(this._renderTimeCached,this),1e3),this._renderTimeCached())},_renderTimeCached:function(){this._renderInfo("localtime",new Date(Date.now()+this.timeOffsetMs).toLocaleTimeString())},showOnMap:function(){e.trigger("show:map",this.model.get("id"))},remove:function(){Backbone.View.prototype.remove.call(this),this.localTimeInterval&&clearInterval(this.localTimeInterval)}},{INFO_TO_HTML:{ip:"ip",referer:"url",browserName:"browser",os:"os",language:"language",geoloc:{countryName:"country",regionName:"region",city:"city",zipCode:"zip",timeZone:"timezone",latitude:"latitude",longitude:"longitude"}},VALUE_TO_ICON:{windows:"windows",macintosh:"apple",linux:"linux",iphone:"mobile",msie:"internet-explorer",firefox:"firefox",safari:"safari",opera:"opera",chrome:"chrome",applewebkit:"apple",localtime:"clock-o"},infoToHtml:function(e,i){var s=t.INFO_TO_HTML[e];return i&&"object"==typeof s&&(s=s[i]),s},valueToIcon:function(e){return t.VALUE_TO_ICON[e]}})}(window.Application),function(e,t,i,s){e.TabsView=Backbone.View.extend({events:{"mousedown .customer-chat-tab":"switchTab","click .customer-chat-tab-prev":"prevButtons","click .customer-chat-tab-next":"nextButtons"},currentTab:0,prevWinSize:{width:0,height:0},initialize:function(){this.$window=t(window),this.$tabContentContainer=this.$el,this.$container=this.$(".customer-chat-tabs"),this.$buttonsContainer=this.$(".customer-chat-tabs-wrapper"),this.$buttons=this.$(".customer-chat-tab-button"),this.$tabs=this.$el.children(".customer-chat-tab-content"),this.$prev=this.$(".customer-chat-tab-prev"),this.$next=this.$(".customer-chat-tab-next"),this.$el.is(":visible")?this.render():(this.$el.show(),this.render(),this.$el.hide()),this.updateOnResize(),setTimeout(t.proxy(this.render,this),0)},addTab:function(e){var i=t(e.button);this.$buttonsContainer.append(i),this.$buttons=this.$buttons.add(i);var s=t(e.content);return this.$tabs=this.$tabs.add(s),this.$tabContentContainer.append(s),this.render(),s},removeTab:function(e){var t=this.$buttons.eq(e);t.remove(),this.$buttons=this.$buttons.not(t);var i=this.$tabs.eq(e);i.remove(),this.$tabs=this.$tabs.not(i),this.render()},removeTabByTag:function(e){var t=this.$buttons.parent().find('[data-tag="'+e+'"]');t.remove(),this.$buttons=this.$buttons.not(t);var i=this.$tabs.parent().find('[data-tag="'+e+'"]');i.remove(),this.$tabs=this.$tabs.not(i),this.render()},removeTabs:function(){for(var e=t(),i=t(),s=0;s<arguments.length;s++)e=e.add(this.$buttons.eq(arguments[s])),i=i.add(this.$tabs.eq(arguments[s]));e.remove(),i.remove(),this.$buttons=this.$buttons.not(e),this.$tabs=this.$tabs.not(i),this.render()},showTab:function(e){e>=this.$tabs.length||e<0||(this.currentTab=e,this.$tabs.hide().eq(e).show(),this.$buttons.removeClass("customer-chat-active").eq(e).addClass("customer-chat-active"),this.includeButtonInView(e),this.trigger("tab.show",e))},getButtonIndex:function(e){return this.$buttons.index(e)},getButton:function(e){return this.$buttons.eq(e)},includeButtonInView:function(e){this.$prev.hide(),this.$next.hide();var i=s.reduce(this.$buttons,function(e,i){return e+t(i).outerWidth(!0)},0),a=this.$container.width();if(i>a){var n=this.$buttons.eq(e),r=this.$buttonsContainer.position().left,o=n.position().left,l=n.outerWidth(),h=r;r+o<this.$prev.outerWidth()?(h=-o,h<0&&(h+=this.$prev.outerWidth()-1)):r+o+l>a-this.$next.outerWidth()&&(h=a-(o+l),h+i>a&&(h-=this.$next.outerWidth()-1)),0!==h&&this.$prev.show(),h+i>a&&this.$next.show(),this.$buttonsContainer.css("left",h)}else this.$buttonsContainer.css("left",0)},switchTab:function(e){var t=this.$buttons.index(e.currentTarget);this.showTab(t)},showTabForButton:function(e){this.switchTab({currentTarget:e})},prevButtons:function(){var e,t=this.$buttonsContainer.position().left;for(e=0;e<this.$buttons.length;e++){var i=this.$buttons.eq(e),s=i.position();if(s.left+=t,s.left<0&&0<s.left+i.outerWidth())break}this.includeButtonInView(e)},nextButtons:function(){var e,t=this.$buttonsContainer.position().left,i=this.$container.width();for(e=this.$buttons.length-1;e>=0;e--){var s=this.$buttons.eq(e),a=s.position();if(a.left+=t,a.left<i&&i<a.left+s.outerWidth())break}this.includeButtonInView(e)},render:function(){var e=Math.max(Math.min(this.currentTab,this.$tabs.length-1),0);this.showTab(e)},updateOnResize:function(){var e=null,i=t.proxy(this.render,this),s=this;this.$window.resize(function(){s.$window.width()===s.prevWinSize.width&&s.$window.height()===s.prevWinSize.height||(s.prevWinSize={width:s.$window.width(),height:s.$window.height()},e&&clearTimeout(e),e=setTimeout(i,500))})}})}(window.Application,jQuery,window.chatConfig,_),function(e,t,i){e.MenuView=Backbone.View.extend({events:{"click .status-switch":"switchStatus","mousedown #customer-chat-side-button-chat":"showChat","mousedown #customer-chat-side-button-map":"showMap","mousedown #customer-chat-side-button-settings":"showSettings","mousedown #customer-chat-side-button-qr":"showQRCode","mousedown #customer-chat-header-menu-qr":"showQRCode","mousedown #customer-chat-side-button-logs":"showLogs","mousedown #customer-chat-header-menu-widget-snippet":"showWidgetSnippet","mousedown #customer-chat-side-button-widget-snippet":"showWidgetSnippet","click #customer-chat-header-menu-edit":"editProfile","click #customer-chat-header-menu-logs":"showLogs"},msgBlinking:!1,initialize:function(s){this.settings=e.model.settings,this.user=e.model.user,this.chat=e.model.chat,this.operatorsView=s.windowView.operatorsView,this.tabsView=s.windowView.tabsView,this.$window=t(window),this.$statusSwitch=this.$(".status-switch"),this.$menu=this.$(".customer-chat-header-menu"),this.$button=this.$("#customer-chat-button-menu"),this.$avatar=this.$(".customer-chat-content-message-avatar-operator"),this.$editProfile=this.$("#customer-chat-header-menu-edit"),this.$install=this.$("#customer-chat-header-menu-install"),this.$uninstall=this.$("#customer-chat-header-menu-uninstall"),this.$editConfig=this.$("#customer-chat-header-menu-edit-config"),this.$menuLogs=this.$("#customer-chat-header-menu-logs"),this.$widgetSnippet1=this.$("#customer-chat-header-menu-widget-snippet"),this.$widgetSnippet2=this.$("#customer-chat-side-button-widget-snippet"),this.$sideMarker=this.$(".customer-chat-side-menu-triangle"),this.$msgIcon=this.$("#customer-chat-side-button-chat i"),this.$sideChat=this.$("#customer-chat-side-button-chat"),this.$sideMap=this.$("#customer-chat-side-button-map"),this.$sideQR=this.$("#customer-chat-side-button-qr"),this.$sideLogs=this.$("#customer-chat-side-button-logs"),this.$chat=this.$("#customer-chat-admin-chat"),this.$map=this.$("#customer-chat-admin-map"),this.$settings=this.$("#customer-chat-admin-settings"),this.$qrCode=this.$("#customer-chat-admin-qr"),this.$logs=this.$("#customer-chat-admin-logs"),this.user.hasRole("ADMIN")?(i.ui.installed?this.$install.hide():this.$uninstall.hide(),this.$editProfile.hide()):(this.$install.hide(),this.$uninstall.hide(),this.$editConfig.hide(),this.$menuLogs.hide(),this.$sideLogs.hide(),this.$widgetSnippet1.hide(),this.$widgetSnippet2.hide()),this.hide(),this.user.hasRole("OPERATOR")&&(this.listenTo(this.chat,"change:status",this.updateStatus),this.updateStatus(this.chat,this.chat.get("status")),this.listenTo(s.windowView.chatTabView,"talks.read",this.stopAnimateMsgIcon),this.listenTo(s.windowView.chatTabView,"talks.unread",this.animateMsgIcon)),this.listenTo(this.user,"change",this.updateUser),this.listenTo(e,"show:map",this.showMap),this.updateUser()},updateUser:function(){this.$button.find(".customer-chat-header-button-text").html(e.service.i18n.trans("welcome")+", "+this.user.getReadableName()),this.user.get("image")&&this.$avatar.css("background-image",'url("'+this.user.get("image")+'")')},blinkMsgIcon:function(){if(this.msgBlinking){var e=this;this.$msgIcon.fadeOut("slow",function(){e.$msgIcon.fadeIn("slow",function(){e.blinkMsgIcon()})})}},animateMsgIcon:function(){this.msgBlinking=!0,this.blinkMsgIcon()},stopAnimateMsgIcon:function(){this.msgBlinking=!1},show:function(e){this.$menu.fadeIn("fast"),e.stopImmediatePropagation(),t("html, body").one("mousedown",t.proxy(this.hide,this))},hide:function(){this.$menu.fadeOut("fast"),this.$button.one("mousedown",t.proxy(this.show,this))},switchStatus:function(){this.chat.get("status")===e.AdminChatModel.STATUS_ONLINE?this.chat.setStatus(e.AdminChatModel.STATUS_OFFLINE):this.chat.setStatus(e.AdminChatModel.STATUS_ONLINE)},updateStatus:function(t,i){switch(this.$statusSwitch.removeClass("offline online loading"),i){case e.AdminChatModel.STATUS_ONLINE:this.$statusSwitch.addClass("online");break;case e.AdminChatModel.STATUS_OFFLINE:this.$statusSwitch.addClass("offline")}},showChat:function(i){var s=18+this.$sideChat[0].offsetTop;this.$sideMarker.animate({top:s},"fast"),this.hideTabs(),this.$chat.show(),t(window).resize(),e.trigger("menu:show:chat")},showMap:function(i){var s=18+this.$sideMap[0].offsetTop;this.$sideMarker.animate({top:s},"fast"),this.hideTabs(),this.$map.show(),t(window).resize(),e.trigger("menu:show:map")},showSettings:function(i){var s=18+(i?i.currentTarget:this.$("#customer-chat-side-button-settings")[0]).offsetTop;this.$sideMarker.animate({top:s},"fast"),this.hideTabs(),this.$settings.show(),this.tabsView.render(),this.$("#customer-chat-admin-settings .customer-chat-content-messages").each(function(){t(this).mCustomScrollbar("update")}),e.trigger("menu:show:settings")},showQRCode:function(t){var i=18+this.$sideQR[0].offsetTop;this.$sideMarker.animate({top:i},"fast"),this.hideTabs(),this.$qrCode.show(),e.trigger("menu:show:qrcode")},showLogs:function(t){var i=18+this.$sideLogs[0].offsetTop;this.$sideMarker.animate({top:i},"fast"),this.hideTabs(),this.$logs.show(),this.$("#customer-chat-admin-logs .customer-chat-content-messages").mCustomScrollbar("update"),e.trigger("menu:show:logs")},editProfile:function(){var e=this.$("#customer-chat-side-button-settings")[0];this.showSettings({currentTarget:e}),this.chat.operatorsReady?this._editProfile():this.listenToOnce(this.chat,"change:operators",function(){this._editProfile()})},_editProfile:function(){this.operatorsView.showEdit(null,this.user.get("id")),this.tabsView.showTab(this.user.hasRole("OPERATOR")?0:1)},showWidgetSnippet:function(){e.view.dialogs.message(e.service.i18n.trans("widget.embd.code"),new e.WidgetCodeView,550,330)},hideTabs:function(){this.$chat.hide(),this.$map.hide(),this.$settings.hide(),this.$qrCode.hide(),this.$logs.hide()}})}(window.Application,jQuery,window.chatConfig),function(e,t,i){e.ChatTabView=Backbone.View.extend({events:{"click .customer-chat-tab-button .close":"closeTalk"},talkViews:{},tmpTalkViews:{},unreadTalks:0,onlineUserViews:[],prevOnlineUsers:[],initialize:function(){this.settings=e.model.settings,this.chat=e.model.chat,this.user=e.model.user,this.$el.html(e.template.chatTab()),this.actions=e.controller.actions,this.tabsView=new e.TabsView({el:this.$(".chat-wrapper")}),this.$emoticons=this.$(".customer-chat-emots-menu"),this.$input=this.$(".customer-chat-content-message-input-field"),this.$onlineList=this.$("#customer-chat-users-online .customer-chat-content-messages-wrapper.users"),this.$onlineListOperator=this.$("#customer-chat-users-online .customer-chat-content-messages-wrapper.operators"),this.$onlineList.parent().mCustomScrollbar(),this.$onlineListOperator.parent().mCustomScrollbar(),this.user.hasRole("OPERATOR")||(this.tabsView.remove(),this.$("#customer-chat-users-online").addClass("admin")),this.listenTo(this.chat,"change:status",function(t,i){i===e.AdminChatModel.STATUS_ONLINE?this.$el.removeClass("offline"):this.$el.addClass("offline")}),this.listenTo(this.chat,"users:online",this.renderOnlineUsers),this.listenTo(this.chat,"messages:new",this.handleNewMessages),this.listenTo(this.tabsView,"tab.show",function(){t(window).resize()}),this.listenTo(this.chat,"usertalkmap:update",this.handleUserTalkMapUpdate),this.listenTo(this.tabsView,"tab.show",this.handleTalkShown),this.listenTo(e,"menu:show:chat",this.handleChatShown),this.listenTo(e,"talk.show",this.showTalkById)},_isUserInList:function(e,t){for(var i=0;i<t.length;i++)if(e.get("id")==t[i].get("id"))return!0},renderOnlineUsers:function(i){for(var s=[],a=!1,n=0;n<i.length;n++){var r=i[n];r.has("id")&&r.get("roles").indexOf("OPERATOR")===-1&&(s.push(r),a||this._isUserInList(r,this.prevOnlineUsers)||(e.service.soundPlayer.play("systemMessage"),a=!0))}this.prevOnlineUsers=s,this.$onlineList.html(""),this.$onlineListOperator.html("");for(var n=0;n<this.onlineUserViews;n++)this.onlineUserViews[n].remove();for(var n=0;n<i.length;n++){var r=i[n];userView=new e.OnlineUsersItemView({model:r}),this.onlineUserViews.push(userView),userView.on("click",this.showTalk,this);var o=userView.render().$el;r.get("roles").indexOf("OPERATOR")!==-1?this.$onlineListOperator.append(o):this.$onlineList.append(o),new e.UserInfoPopoverView({model:r,button:o[0]})}t(window).trigger("resize")},addTalkView:function(i,s){var a=t(e.template.tabButtonChat()),n=a.find("span");n.html("Loading..."),s?e.UserModel.getUser(s,function(e){n.html(e.getReadableName())}):i&&this.chat.getTalkName(i,function(e){n.html(e)}),a.data("info",{talkId:i,userId:s});var r=a.find(".new-msg");r.hide(),function d(){r.animate({opacity:.01},{duration:"slow",complete:function(){r.animate({opacity:1},{duration:"slow",complete:d})}})}();var o=t(e.template.tabContentChat({id:Math.floor(Date.now()*Math.random())})),l=new e.ChatView({el:o,talkId:i,userId:s,parentView:this});this.tabsView.addTab({button:a,content:o});var h={chatView:l,$button:a};return"undefined"!=typeof i?this.talkViews[i]=h:"undefined"!=typeof s&&(this.tmpTalkViews[s]=h),l.on("message.sent",this.handleMessageSent,this),h},getTalkView:function(e,t){return this.talkViews[e]||this.tmpTalkViews[t]},removeTalkView:function(e,t){var i=this.getTalkView(e,t);this.tabsView.removeTab(this.tabsView.getButtonIndex(i.$button[0])),i.chatView.remove(),delete this.talkViews[e],delete this.tmpTalkViews[t]},showTalk:function(t,i){if(t){if(!this.user.hasRole("OPERATOR"))return void e.trigger("history.search",{name:t.get("name"),mail:t.get("mail"),fromDate:"",toDate:""});if(t.get("anonymous"))return void this.inviteVisitor(t);i=t.get("id")}if(this.user.get("id")==i)return void e.view.dialogs.message(e.service.i18n.trans("new.talk"),e.service.i18n.trans("cant.chat.w.self"));var s=this.chat.getTalkIdForUser(i),a=this.getTalkView(s,i);if(s&&(s=parseInt(s)),!a){a=this.addTalkView(s,i),a.chatView.silent=!0,this.chat.watchTalk(s),this.chat.manageConnection();var n=this.chat.getTalk(s);n&&a.chatView.handleNewMessages(n,!0)}this.tabsView.showTabForButton(a.$button[0])},showTalkById:function(e){var t=this.getTalkView(e);if(e=parseInt(e),!t){t=this.addTalkView(e),this.chat.watchTalk(e);var i=this.chat.getTalk(e);i&&t.chatView.handleNewMessages(i,!0)}this.tabsView.showTabForButton(t.$button[0])},closeTalk:function(e){var i=t(e.currentTarget).parent(".customer-chat-tab-button").data("info");this.removeTalkView(i.talkId,i.userId),e.stopImmediatePropagation()},inviteVisitor:function(i){var s=this,a={};a[e.service.i18n.trans("invite")]=function(){s.chat.inviteVisitor(i),t(this).dialog("close")},e.view.dialogs.confirm(e.service.i18n.trans("visitor.invite"),e.service.i18n.trans("invite.visitor.q"),a)},handleNewMessages:function(t){_.each(t,function(t){if(t!=-1){for(var i,s=this.getTalkView(t),a=this.chat.getTalk(t),n=0;n<a.length;n++){var r=a[n].extra;if(r)switch(r.type){case e.MessageModel.EXTRA_TALK_START:i=!1;break;case e.MessageModel.EXTRA_TALK_CLOSE:s&&(s.offline=!0);break;default:i=!0}else i=!0}i&&(s?s.chatView.lastMsgId>0&&(a=_.filter(a,function(e){return e.id>s.chatView.lastMsgId&&e.from_id!=this.user.get("id")},this)):(s=this.addTalkView(t),s.chatView.handleNewMessages(a)),a.length&&this.initTalkView(s,a))}},this)},handleUserTalkMapUpdate:function(){for(var e in this.tmpTalkViews){var t=parseInt(this.chat.getTalkIdForUser(e));if(t){var i=this.tmpTalkViews[e];i.chatView.talkId=t,i.$button.data("info",{talkId:t,userId:e}),this.talkViews[t]=i,delete this.tmpTalkViews[e]}}},initTalkView:function(e,t,i){if(e.chatView.silent&&(i=!0),e.chatView.handleNewMessages(t,i),!i){var s=e.$button.find(".new-msg");s.is(":hidden")&&(s.show(),this.updateUnreadCounter(1))}},handleMessageSent:function(e,t){var i=this.getTalkView(e,t),s=i.$button.find(".new-msg");s.is(":visible")&&(s.hide(),this.updateUnreadCounter(-1))},handleTalkShown:function(e){var t=this.tabsView.getButton(e).find(".new-msg");t.is(":visible")&&(t.hide(),this.updateUnreadCounter(-1));var i=this.tabsView.getButton(e).data("info"),s=i.talkId,a=i.userId,n=this.getTalkView(s,a);n&&setTimeout(function(){n.chatView.chatBox.scrollToBottom()},500)},handleChatShown:function(){this.tabsView.render()},updateUnreadCounter:function(e){var t=this.unreadTalks;this.unreadTalks=Math.max(0,this.unreadTalks+e),1===t&&0===this.unreadTalks?this.trigger("talks.read"):this.trigger("talks.unread")}})}(window.Application,jQuery,window.chatConfig),function(e,t,i,s){var a=s&&s.maps;Math.log2=Math.log2||function(e){return Math.log(e)/Math.LN2};var n=e.MapView=Backbone.View.extend({initialize:function(){return this.apiKey=e.model.uiSettings.get("gMapsKey").get("value"),this.apiKey?void(a&&(this.model=e.model.chat,this.users=[],this.markers={},this.listenTo(this.model,"users:online",this.render),this.$mapWrapper=this.$(".map-wrapper"),this.$el.one("show",i.debounce(i.bind(this.createMap,this),200)),this.listenTo(e,"show:map",i.bind(this.showUser,this)))):(this.$(".no-key-info").show(),void this.$(".map-wrapper").hide())},createMap:function(){var e=new a.StyledMapType(n.STYLES_ULTRA_LIGHT,{name:"Ultra Light"}),t=new a.StyledMapType(n.STYLES_SHADES_OF_GREY,{name:"Shades of Grey"});styledMap3=new a.StyledMapType(n.STYLES_JUST_PLACES,{name:"Just Places"}),styledMap4=new a.StyledMapType(n.STYLES_COBALT,{name:"Cobalt"}),this.map=new a.Map(this.$mapWrapper[0],{mapTypeId:a.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControl:!0,mapTypeControl:!0,scaleControl:!0,center:new a.LatLng(0,0),zoom:Math.ceil(Math.log2(this.$el.width()))-9,mapTypeControlOptions:{mapTypeIds:["style1","style2","style3","style4",a.MapTypeId.ROADMAP,a.MapTypeId.SATELLITE,a.MapTypeId.HYBRID,a.MapTypeId.TERRAIN]}}),this.map.setTilt(0),this.map.mapTypes.set("style1",e),this.map.mapTypes.set("style2",t),this.map.mapTypes.set("style3",styledMap3),this.map.mapTypes.set("style4",styledMap4),this.map.setMapTypeId("style1"),this.render()},render:function(){return!!this.map&&(this.renderUsers(),this.showUserAfterRender&&(this.showUser(this.showUserAfterRender),delete this.showUserAfterRender),this)},renderUsers:function(){var e=this.model.onlineUsers;for(var t in this.markers)i.find(e,function(e){return e.get("id")==t})||this.removeMarker(t);for(var s=e.length-1;s>=0;s--){var a=e[s];this.hasMarker(a.get("id"))||this.addMarker(a)}},showUser:function(e){if(e){if(!this.map)return void(this.showUserAfterRender=e);var t=this.getMarker(e);t&&(this.map.setCenter(t.markers[0].getPosition()),this.map.setZoom(4))}},addMarker:function(e){var t=e.get("info");if(t){var s=t.geoloc;if(s&&s.latitude&&s.longitude){var a=this.markers[e.get("id")]={userId:e.get("id"),originalPos:{lat:s.latitude,lng:s.longitude},markers:this.createMarkers(s.latitude,s.longitude,e.get("image"))};i.each(a.markers,function(e){e.addListener("click",i.bind(this.onMarkerClick,this,a));
},this)}}},createMarkers:function(e,i,s){var n,r=new a.LatLng(e,i),o=new a.Marker({map:this.map,position:r,zIndex:2});return s?(o.setIcon({url:s,anchor:new a.Point(20,63)}),n=new a.Marker({map:this.map,position:r,icon:{url:t.mapMarkerPath},zIndex:1}),[n,o]):[o]},removeMarker:function(e){var t=this.markers[e];if(t){t.markers;i.each(t.markers,function(e){e.setMap(null),a.event.clearInstanceListeners(e)},this),delete this.markers[e]}},hasMarker:function(e){return!!this.markers[e]},getMarker:function(e){return this.markers[e]},onMarkerClick:function(t){e.view.window.chatTabView.showTalk(null,t.userId),e.view.window.menuView.showChat()}},{STYLES_JUST_PLACES:[{featureType:"road",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#fffffa"}]},{featureType:"water",stylers:[{lightness:50}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"administrative",elementType:"geometry",stylers:[{lightness:40}]}],STYLES_COBALT:[{featureType:"all",elementType:"all",stylers:[{invert_lightness:!0},{saturation:10},{lightness:30},{gamma:.5},{hue:"#435158"}]}],STYLES_ULTRA_LIGHT:[{featureType:"water",elementType:"geometry",stylers:[{color:"#e9e9e9"},{lightness:17}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:20}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{lightness:17}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#ffffff"},{lightness:29},{weight:.2}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:18}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:16}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:21}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#dedede"},{lightness:21}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#ffffff"},{lightness:16}]},{elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#333333"},{lightness:40}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#f2f2f2"},{lightness:19}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#fefefe"},{lightness:20}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#fefefe"},{lightness:17},{weight:1.2}]}],STYLES_SHADES_OF_GREY:[{featureType:"all",elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#000000"},{lightness:40}]},{featureType:"all",elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#000000"},{lightness:16}]},{featureType:"all",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#000000"},{lightness:20}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#000000"},{lightness:17},{weight:1.2}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#000000"},{lightness:20}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#000000"},{lightness:21}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#000000"},{lightness:17}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#000000"},{lightness:29},{weight:.2}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#000000"},{lightness:18}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#000000"},{lightness:16}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#000000"},{lightness:19}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#000000"},{lightness:17}]}]})}(window.Application,window.chatConfig,window._,window.google),function(e,t,i){var s=Marionette.Object.extend({initialize:function(e){this.user=e.user,this.chat=e.chat,this.chatBox=e.chatBox,this.talkId=e.talkId,this.toId=e.toId,this.files=e.files,this.input=e.input},run:function(){var s,a=this.input,n=this.files,r=this._getFilesInfo(n=n||a.files||a.value),o=this.uploader=new AjaxUploader({url:t.uploadFilesPath,files:n,input:a,filesField:"files[]",onProgress:i.bind(this.onProgress,this)});this.user.hasRole&&this.user.hasRole("OPERATOR")?(s=new e.MessageModel({author:this.user.get("name"),mail:this.user.get("mail"),authorType:"operator",body:this._getMessageBody(n),time:new Date,talk_id:this.talkId,from_id:this.user.get("id"),to_id:this.toId,extra:{type:e.MessageModel.EXTRA_FILES,files:r.files},from_user_info:{image:this.user.get("image")}},{localMessage:!0}),s.fromUser=this.user.attributes):s=new e.MessageModel({author:this.user.get("name"),authorType:"guest",body:this._getMessageBody(n),time:new Date,from_id:this.user.get("id"),extra:{type:e.MessageModel.EXTRA_FILES,files:r.files},from_user_info:{image:this.user.get("image")}},{localMessage:!0}),this.message=s,s.uploader=o,this.listenTo(s.upload,"change:state",this.onStateChange);var l=this._validateFiles(r);return"undefined"!=typeof l?(s.upload.set("error",l),s.upload.set("state",e.UploadModel.STATE_ERROR)):this.chat.sendMessage(s,function(e){s.upload.set(e.upload)}),this.chatBox.addMessage(s,!0),s.upload},onStateChange:function(t,i){if(i!==e.UploadModel.STATE_PENDING){var s=t.previous("state");null!==s&&s!==e.UploadModel.STATE_PENDING||i!==e.UploadModel.STATE_UPLOADING?this.trigger("unlock"):(this.uploader.data={id:this.message.upload.get("id")},this.uploader.upload())}},onProgress:function(e){this.message.upload.save("progress",Math.floor(e*this.message.upload.get("size")))},_getFilesInfo:function(e){var t=[],i=0;if("string"==typeof e){var s=e.split("\\").pop();t.push({name:s,size:null,type:null}),i=null}else for(var a=0;a<e.length;a++){var n=e[a];t.push({name:n.name,size:n.size,type:n.type}),i+=n.size}return{totalSize:i,files:t}},_validateFiles:function(i){if(i.totalSize){var s=Math.floor(1024*parseFloat(t.ui.sharedFileMaxSize)*1024);return i.totalSize>s?e.service.i18n.trans("file.too.big",{"%max%":t.ui.sharedFileMaxSize}):void 0}},_getMessageBody:function(e){for(var t="",i=0;i<e.length;i++){var s=e[i];t+=s.name}return t}});e.UploadController=s}(window.Application,window.chatConfig,_),function(e,t,i){e.FileDropZoneView=Marionette.ItemView.extend({events:{drop:"handleDrop"},initialize:function(){_.bindAll(this,"enableEffect","disableEffect")},delegateEvents:function(){window.File&&window.FileList&&window.FileReader&&(Marionette.ItemView.prototype.delegateEvents.apply(this,arguments),this.el.addEventListener("dragover",this.enableEffect,!1),this.el.addEventListener("dragleave",this.disableEffect,!1))},undelegateEvents:function(){window.File&&window.FileList&&window.FileReader&&(this.el.removeEventListener("dragover",this.enableEffect,!1),this.el.removeEventListener("dragleave",this.disableEffect,!1),Marionette.ItemView.prototype.undelegateEvents.apply(this,arguments))},enableEffect:function(e){e.preventDefault(),e.stopPropagation(),this._isFileTransfer(e)&&(this.disableTimer&&clearTimeout(this.disableTimer),this.$el.addClass("active"))},disableEffect:function(e){this.disableTimer&&clearTimeout(this.disableTimer);var t=this;this.disableTimer=setTimeout(function(){t.$el.removeClass("active")},100)},handleDrop:function(e){e.preventDefault(),e.stopPropagation(),this.disableEffect();var t=e.originalEvent.dataTransfer.files||e.originalEvent.target.files;t&&t.length>0&&this.trigger("drop",t)},_isFileTransfer:function(e){if(e.dataTransfer.types){for(var t=0;t<e.dataTransfer.types.length;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1}return!0}})}(window.Application,window.chatConfig,jQuery),function(e,t,i,s){var a=e.ChatView=Backbone.View.extend({events:{"click .customer-chat-content-message-emots-button":"toggleEmoticons","click .customer-chat-emoticon":"addEmoticon","click .btn-canned-msg":"selectCannedMessage","click .btn-mail-transcript":"mailTalkTranscript","change .file-button input":"onFilesSelect","keydown .customer-chat-content-message-input-field":"sendMessage","click .invite":"invite","click .leave":"leave",show:"_setInputPadding"},guestUrl:"",typingInfoBlinking:!1,lastMsgId:0,participants:null,participantViews:null,initialize:function(a){s.bindAll(this,"handleSentMessage"),this.settings=e.model.settings,this.chat=e.model.chat,this.user=e.model.user,this.talkId=a.talkId,this.userId=a.userId,this.participants=[],this.participantViews=[],this.parentView=this.options.parentView,this.chatBox=new e.ChatBoxView({el:this.$(".customer-chat-content-messages")}),this.$currentUrl=this.$(".current-url"),this.$emoticons=this.$(".customer-chat-emots-menu"),this.$typingInfo=this.$(".typing-indicator"),this.$input=this.$(".customer-chat-content-message-input-field"),this.$fileInput=this.$('[type="file"]'),this.$fileBtn=this.$(".file-button"),this.$participantsScroller=this.$(".customer-chat-talk-header-users .participants-scroller"),this.$participants=this.$(".customer-chat-talk-header-users .participants-content"),this.$fileBtn.data("for",this.$fileBtn.attr("for")),"true"==i.ui.fileSharing?(this.fileDropZone=new e.FileDropZoneView({el:this.el}),this.fileDropZone.on("drop",this.onFilesDrop,this)):this.$fileBtn.hide(),this.$participantsScroller.mCustomScrollbar(),this.$currentUrl.parent().css("opacity",0),"undefined"==typeof this.model&&e.UserModel.getUser(this.userId,t.proxy(function(e){this.model=e,this.model.hasRole("OPERATOR")&&this.$el.addClass("operator"),this.listenTo(this.model,"change",this.handleModelUpdate),this.handleModelUpdate(!1)},this)),this.listenTo(this.chat,"talks:typing",this.handleRemoteTyping),this.on("participants:update",this.handleParticipantsUpdate,this),this.userId&&this.updateParticipants(this.userId)},toggleEmoticons:function(){this.$emoticons.toggle("fade","fast")},addEmoticon:function(e){var i=t(e.currentTarget);this.$input.val(this.$input.val()+" "+i.data("emot")+" "),this.$input.focus(),this.$emoticons.fadeOut("fast")},sendMessage:function(t){if(this.handleTyping(),13===t.keyCode&&!t.shiftKey){var i=this.$input.val();if(0!=i.length){var s=new e.MessageModel({author:this.user.get("name"),mail:this.user.get("mail"),authorType:"operator",body:i,time:new Date,talk_id:this.talkId,from_id:this.user.get("id"),to:this.userId},{localMessage:!0});s.fromUser=this.user.attributes,this.chat.sendMessage(s,this.handleSentMessage),this.chatBox.addMessage(s,!0),this.updateParticipants(this.user.get("id")),this.$input.val(""),this.trigger("message.sent",this.talkId,this.userId)}}},handleSentMessage:function(e){this.lastMsgId=e.message.id},handleNewMessages:function(t,i){var s=!1,a=!0;this.silent&&(i=!0,this.silent=!1);for(var n=0;n<t.length;n++){var r=t[n];this.lastMsgId<r.id&&(this.handleMessage(r),this.lastMsgId=r.id,s=!0),a=a&&r.from_id==e.MessageModel.USER_ID_SYSTEM}if(s&&!i){this.settings.get("sound")&&e.service.soundPlayer.play(a?"systemMessage":"message");var o=t[t.length-1];o.info=this.model.get("info");var l=new e.MessageModel(o),h=this;setTimeout(function(){e.service.notify.create(e.service.i18n.trans("app.name"),{body:l.getReadableName()+": "+l.get("body"),onClick:function(){h.talkId&&e.trigger("talk.show",h.talkId)}})},0)}},handleMessage:function(t){t.from_user_info&&"object"==typeof t.from_user_info.info&&(t.info=t.from_user_info.info);var i=new e.MessageModel(t),s=!1;if(!this.model){var a=i.get("to_id");if(a!=-1){var n=this;e.UserModel.getUser(a,function(e){n.model=e,n.listenTo(n.model,"change",n.handleModelUpdate),n.handleModelUpdate(!1)})}}var r=i.get("extra");if(r)switch(r.type){case e.MessageModel.EXTRA_USER_LEAVE:this.removeParticipant(r.id);break;case e.MessageModel.EXTRA_TALK_CLOSE:this.chat.leaveTalk(this.talkId,void 0,!0);break;case e.MessageModel.EXTRA_TALK_OWNER:r.id==this.user.get("id")||this.chat.isTalkOwner(this.talkId,this.user.get("id"))||this.chat.isParticipantInTalk(this.user.get("id"),this.talkId)?this.ownerId=parseInt(r.id):this.chat.leaveTalk(this.talkId,void 0,!0);break;case e.MessageModel.EXTRA_TALK_START:s=!0}return s||this.chatBox.addMessage(i),this.updateParticipants(i.get("from_id")),!s},handleTyping:function(){this.talkId&&this.chat.updateTypingStatus(this.talkId)},handleRemoteTyping:function(e){e.indexOf(parseInt(this.talkId))!==-1&&(this.startTypingInfoBlink(),this.stopTypingBlinkTimer&&clearTimeout(this.stopTypingBlinkTimer),this.stopTypingBlinkTimer=setTimeout(t.proxy(this.stopTypingInfoBlink,this),a.TYPING_STATUS_TIME))},handleModelUpdate:function(e){"undefined"==typeof e&&(e=!0);var i=this.model.get("info");if(i&&this.guestUrl!==i.referer){this.guestUrl=i.referer;var s=this,a=e?"slow":0;this.$currentUrl.parent().animate({opacity:0},{duration:a,complete:function(){s.$currentUrl.html(i.referer).attr("href",i.referer),t(this).animate({opacity:1},{duration:a})}})}},handleParticipantsUpdate:function(){var t=this;e.UserModel.getUsers(this.participants,function(e){var i;for(var s in e){var a=e[s];if(!a.hasRole("OPERATOR")){i=a;break}}i?(t.model!==i&&(t.model&&t.stopListening(t.model),t.model=i,t.listenTo(t.model,"change",t.handleModelUpdate),t.handleModelUpdate()),t.$currentUrl.parent().css("visibility","visible")):t.model&&t.model.hasRole("OPERATOR")&&t.$currentUrl.parent().css("visibility","hidden")})},startTypingInfoBlink:function(){this.typingInfoBlinking||(this.typingInfoBlinking=!0,this.blinkTypingInfo())},blinkTypingInfo:function(){if(this.typingInfoBlinking){var e=this;this.$typingInfo.fadeIn("slow",function(){e.$typingInfo.fadeOut("slow",function(){e.blinkTypingInfo()})})}},stopTypingInfoBlink:function(){this.typingInfoBlinking=!1},selectCannedMessage:function(){var i=this,s=new e.SelectCannedMessageView({model:e.model.cannedMessages}),a={};a[e.service.i18n.trans("insert")]=function(){var e=t(this),a=s.selected;if(e.dialog("close"),a){var n=i.$input.val();i.$input.val(n+(n.length>0?" ":"")+a).focus()}},e.view.dialogs.confirm(e.service.i18n.trans("select.msg"),s,a,"auto")},mailTalkTranscript:function(){e.controller.actions.run("mailTalkTranscript",[this.talkId,this.model&&this.model.get("mail")])},addParticipant:function(t){var i=new e.ParticipantView({model:t});this.$participants.append(i.el),this.participantViews.push(i)},updateParticipants:function(t){if(t=parseInt(t),t!=-2&&this.participants.indexOf(t)===-1){var i=this;e.UserModel.getUser(t,function(e){i.addParticipant(e),i.$participantsScroller.mCustomScrollbar("update")}),this.participants.push(t),this.trigger("participants:update")}},removeParticipant:function(e){for(var t=this.participantViews.length;t--;){var i=this.participantViews[t];i.model.get("id")==e&&i.remove()}},remove:function(){Backbone.View.prototype.remove.call(this);for(var e=this.participantViews.length;e--;)this.participantViews[e].remove();this.participantViews=[],this.chatBox.clear()},invite:function(){var i=this,s=new e.SelectUserView({model:this.chat,filter:function(t){return t.hasRole("OPERATOR")&&t.get("id")!==e.model.user.get("id")}});e.view.dialogs.confirm(e.service.i18n.trans("select.operator"),s,{Invite:function(){var e=t(this),a=s.selected;e.dialog("close"),a&&i._invite(a.get("id"))}},"auto")},_invite:function(e){this.chat.inviteUserToTalk(this.talkId,e,this.userId,t.proxy(this.handleInviteResult,this))},handleInviteResult:function(t){if(t.success){var i=this;e.UserModel.getUser(t.userId,function(e){i.addParticipant(e)}),t.userTalkMapping&&(this.chat.watchTalk(t.talkId,t.userTalkMapping),this.chat.trigger("usertalkmap:update")),this.chat.manageConnection()}else e.view.dialogs.message(e.service.i18n.trans("invitation"),t.errors)},leave:function(){if(this.ownerId==this.user.get("id"))this.transferAndLeave();else{var i=this,s={};s[e.service.i18n.trans("leave.talk.confirm")]=function(){i._leave(),t(this).dialog("close")},e.view.dialogs.confirm(e.service.i18n.trans("invitation"),e.service.i18n.trans("leave.talk.q"),s)}},transferAndLeave:function(){var i=this,s=new e.TransferAndLeaveView({model:this.chat}),a={};a[e.service.i18n.trans("transfer.n.leave")]=function(){var e=t(this),a=s.selectUserView.selected;e.dialog("close"),a&&(i.transfer(a.get("id")),i._leave())},a[e.service.i18n.trans("end.talk")]=function(){i.endTalk(),t(this).dialog("close")},e.view.dialogs.confirm(e.service.i18n.trans("leave.talk"),s,a,"auto")},endTalk:function(){this.chat.closeTalk(this.talkId,this.userId,t.proxy(this.handleEndTalkResult,this)),e.view.window.chatTabView.removeTalkView(this.talkId,this.userId)},handleEndTalkResult:function(t){t.success||e.view.dialogs.message(e.service.i18n.trans("transfer"),t.errors)},_leave:function(){this.chat.leaveTalk(this.talkId,this.userId,!1,t.proxy(function(t){t.success?e.view.window.chatTabView.removeTalkView(this.talkId,this.userId):e.view.dialogs.message(e.service.i18n.trans("leave"),t.errors)},this))},transfer:function(e){this.chat.transferTalk(this.talkId,e,t.proxy(this.handleTransferResult,this)),this.ownerId=e},handleTransferResult:function(t){t.success||e.view.dialogs.message(e.service.i18n.trans("transfer"),t.errors)},onFilesSelect:function(e){this.isUploadLocked()||this.sendFiles(null,e.target)},onFilesDrop:function(e){this.isUploadLocked()||this.sendFiles(e)},isUploadLocked:function(){return this.currUpload&&this.currUpload.get("state")===e.UploadModel.STATE_PENDING},sendFiles:function(t,i){var t=t||i&&i.files;if(!(i&&!i.value||t&&0===t.length)){this.lockUpload();var s=new e.UploadController({user:this.user,chat:this.chat,chatBox:this.chatBox,talkId:this.talkId,toId:this.toId,files:t,input:i});s.on("unlock",this.unlockUpload,this),this.currUpload=s.run()}},lockUpload:function(){this.$fileBtn.addClass("disabled").removeAttr("for")},unlockUpload:function(){this.$fileBtn.removeClass("disabled").attr("for",this.$fileBtn.data("for")),this.$fileInput.val(null)},_setInputPadding:function(){this._setInputPaddingDisabled||(a.inputPadding?this.$input.css("padding-left",a.inputPadding):setTimeout(t.proxy(function(){this._setInputPaddingDisabled=!0;var e=this.$el.is(":hidden");e&&this.$el.show();var t=this.$(".btn-canned-msg").outerWidth();e&&this.$el.hide(),this._setInputPaddingDisabled=!1,t>0&&(a.inputPadding=t+8,this._setInputPadding())},this),0))}},{TYPING_STATUS_TIME:2e3,inputPadding:null})}(window.Application,jQuery,window.chatConfig,_),function(e,t){e.InputView=Marionette.ItemView.extend({className:"customer-chat-content-row",modelEvents:{change:"render"}})}(Application,jQuery),function(e,t){e.TextInputView=e.InputView.extend({ui:{input:"input"},events:{"change @ui.input":"updateModel"},getTemplate:function(){return e.template.textInput},updateModel:function(){this.model.set("value",this.ui.input.val())}})}(Application,jQuery),function(e,t){var i={helpers:{isChecked:function(e){return"true"==this.value?new Handlebars.SafeString(e.fn(this)):""}}};e.CheckboxInputView=e.InputView.extend({ui:{input:"input"},events:{"change @ui.input":"updateModel"},template:function(t){return e.template.checkbox(t,i)},updateModel:function(){this.model.set("value",this.ui.input.is(":checked")?"true":"false")}})}(Application,jQuery),function(e,t){var i={helpers:{isSelected:function(e){return this.value==e.data.root.value?new Handlebars.SafeString(e.fn(this)):""}}};e.SelectInputView=e.InputView.extend({template:function(t){return e.template.select(t,i)},ui:{input:"select"},events:{"change @ui.input":"updateModel","keyup  @ui.input":"updateModel"},updateModel:function(){this.model.set("value",this.ui.input.val())}})}(Application,jQuery),function(e,t){e.SoundInputView=e.SelectInputView.extend({modelEvents:{change:"render",change:"playSound"},initialize:function(){this.soundPlayer=e.service.soundPlayer;var t=this;_.each(this.model.get("meta").options,function(e){var i={};i[e.value]=e.value,t.soundPlayer.addSounds(i)})},playSound:function(e){this.soundPlayer.play(this.model.get("value"))}})}(Application,jQuery),function(e,t,i){var s={helpers:{isSelected:function(e){return this.value==e.data.root.value?new Handlebars.SafeString(e.fn(this)):""}}};e.WidgetThemeInputView=e.SelectInputView.extend({template:function(t){return e.template.widgetTheme(t,s)},ui:_.extend({},e.SelectInputView.prototype.ui,{preview:"img"}),onRender:function(){this.$el.addClass("widget-theme-row"),this.updatePreview()},updatePreview:function(){var e=this.model.get("value");if(e){var i=t.rootPath+e+"/preview.png";this.ui.preview.attr("src",i)}}})}(Application,chatConfig,jQuery),function(e,t){e.ColorInputView=e.TextInputView.extend({onRender:function(){this.initColorPicker()},initColorPicker:function(){var e=this.$("input"),t=this;e.ColorPicker({onSubmit:function(i,s,a){var n="#"+s;e.val(n),e.ColorPickerHide(),t.model.set("value",n)},onChange:function(t,i,s){e.val("#"+i),e.blur()},onHide:function(){t.model.set("value",e.val())},onBeforeShow:function(){e.ColorPickerSetColor(this.value)}}).bind("keyup",function(){e.ColorPickerSetColor(this.value)})}})}(Application,jQuery),function(e,t,i,s){e.SettingsView=Marionette.CompositeView.extend({getTemplate:function(){return e.template.settings},getChildView:function(t){var i=t.get("meta");if(!i)return Backbone.View;switch(i.type){case"color":return e.ColorInputView;case"select":return e.SelectInputView;case"checkbox":return e.CheckboxInputView;case"sound":return e.SoundInputView;case"widgetTheme":return e.WidgetThemeInputView;default:return e.TextInputView}},filter:function(e){if(!this.options.tags)return!0;var t=e.get("meta")&&e.get("meta").tags;return t&&_.intersection(this.options.tags,t).length>0},childViewContainer:".customer-chat-content-messages-wrapper",ui:{save:"#customer-chat-ui-save",reset:"#customer-chat-ui-reset",loading:".customer-chat-content-loading-icon"},events:{"click @ui.save":"save","click @ui.reset":"reset"},collectionEvents:{update:"render",request:"disable",sync:"enable"},initialize:function(){this.syncing=!1,this.render()},onRender:function(){this.ui.loading.hide()},save:function(){this.isValid()&&!this.syncing&&this.collection.save()},isValid:function(){var t=this.collection.validate();if(this.$(".customer-chat-input-error").removeClass("customer-chat-input-error"),t){for(var i in t)this.$('[name="'+i+'"]').addClass("customer-chat-input-error");return e.view.dialogs.message("Form error","Some settings are invalid"),!1}return!0},reset:function(){var i=this,s={};s[e.service.i18n.trans("reset")]=function(){i._reset(),t(this).dialog("close")},e.view.dialogs.confirm(e.service.i18n.trans("reset.settings"),e.service.i18n.trans("reset.settings.q"),s)},_reset:function(){var e=this.collection.reduce(function(e,t){return this.filter(t)&&e.push(t.get("name")),e},[],this);this.collection.reset(e)},disable:function(){this.syncing=!0,this.ui.save.addClass("button-disabled"),this.ui.loading.fadeIn()},enable:function(){var e=this;setTimeout(function(){e.ui.save.removeClass("button-disabled"),e.ui.loading.fadeOut(),e.syncing=!1},500)}})}(Application,jQuery,Handlebars,chatConfig),function(e,t){var i=Backbone.View.extend({template:function(t){return e.template.qrCode(t)},initialize:function(e){this.render()},render:function(){var i=JSON.stringify(t.qrCode);return this.$el.html(this.template()),e.service.qrCode.display(this.$(".qr-code")[0],{data:i,width:320,height:320}),this}});e.QRCodeView=i}(window.Application,window.chatConfig),function(e,t,i){e.LogsView=Backbone.View.extend({events:{"click #customer-chat-logs-refresh":"refresh","click #customer-chat-logs-clear":"clear"},syncing:!1,initialize:function(){this.model=e.model.logs,this.$el.html(e.template.logs()),this.$scroller=this.$(".customer-chat-content-messages"),this.$wrapper=this.$(".customer-chat-content-messages-wrapper"),this.$refresh=this.$("#customer-chat-logs-refresh"),this.$clear=this.$("#customer-chat-logs-clear"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$scroller.bind("show",function(){t(window).trigger("resize")}).mCustomScrollbar();var i=this;this.$scroller.bind("show",function(){i.init()}),this.$scroller.bind("hide",function(){i.clean()}),this.model.on("change",this.render,this),this.model.on("request",this.disable,this),this.model.on("sync",this.enable,this)},render:function(){this.$wrapper.html("").append(t("<pre>").text(this.model.get("content")));var e=this;setTimeout(function(){e.$scroller.mCustomScrollbar("update"),e.$scroller.mCustomScrollbar("scrollTo","bottom")},200)},disable:function(){this.syncing=!0,this.$refresh.addClass("button-disabled"),this.$clear.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var e=this;setTimeout(function(){e.$refresh.removeClass("button-disabled"),e.$clear.removeClass("button-disabled"),e.$loading.fadeOut(),e.syncing=!1},500)},init:function(){if(this.model.has("content")){var e=this;setTimeout(function(){e.render()},200)}else this.model.fetch()},refresh:function(){this.syncing||this.model.fetch()},clean:function(){this.$wrapper.html("")},clear:function(){if(!this.syncing){var i=this,s={};s[e.service.i18n.trans("clear")]=function(){i._clear(),t(this).dialog("close")},e.view.dialogs.confirm(e.service.i18n.trans("clear.logs"),e.service.i18n.trans("clear.logs.q"),s)}},_clear:function(){this.model.clear(t.proxy(this.onClear,this.onClearError))},onClear:function(){e.view.dialogs.message(e.service.i18n.trans("clear.logs"),e.service.i18n.trans("logs.cleared"))},onClearError:function(){e.view.dialogs.message(e.service.i18n.trans("clear.logs"),e.service.i18n.trans("clear.logs.err"))}})}(window.Application,jQuery,window.chatConfig),function(e,t,i,s){e.OperatorsView=Backbone.View.extend({mailExp:new RegExp("^[-+\\.0-9=a-z_]+@([-0-9a-z]+\\.)+([0-9a-z]){2,}$","i"),events:{"click #customer-chat-operators-back":"showList","click #customer-chat-operators-add":"showAdd","click #customer-chat-operators-change-password":"showChangePassword","click #customer-chat-operators-cancel":"showEdit","click .customer-chat-operators-edit":"showEdit","click .customer-chat-operators-remove":"deleteOperator","click #avatar-from-collection":"selectAvatar","click #customer-chat-operators-save":"save"},initialize:function(){this.model=e.model.chat,this.user=e.model.user,this.$el.html(e.template.operators()),this.$list=this.$("#customer-chat-operators-list"),this.$operators=this.$list.find(".customer-chat-content-messages-wrapper"),this.$edit=this.$("#customer-chat-operators-edit"),this.$save=this.$("#customer-chat-operators-save"),this.$back=this.$("#customer-chat-operators-back"),this.$editInputs=this.$edit.find("input"),this.$avatarInput=this.$edit.find("#avatarUploadField"),this.$loading=this.$(".customer-chat-content-loading-icon").hide();var i=this.user.hasRole("OPERATOR")&&!this.user.hasRole("ADMIN");this.departmentsList=new e.SelectListView({el:this.$(".select-list"),model:e.model.departments,renderEvent:"change:departments",readOnly:i,selectedOnly:i,noScroll:!0,dataProvider:function(){return e.model.departments.get("departments")},getLabel:function(e){return"<b>"+e.name+"</b>"+(e.description?" (<i>"+e.description+"</i>)":"")}}),i&&(this.departmentsList.select(this.user.get("departments")||[]),this.$back.remove(),this.listenToOnce(this.model,"change:operators",function(){this.showEdit(null,this.user.get("id"))}),this.$(".select-list").html(e.service.i18n.trans("no.entries"))),this.$editInputs.blur(t.proxy(this.validateEdit,this)),this.model.on("change:operators",this.render,this),this.showList(),this.render(),this.model.loadOperators()},render:function(){this.$operators.html("").append(i.map(this.model.getOperators(),function(t){return t.roles.indexOf("ADMIN")<0&&(t=i.extend({},t,{removeVisible:!0})),e.template.operatorItem(t)}))},setEditAvatarIcon:function(e,t){e.find(".avatar").css("background-image",'url("'+t+'")')},showList:function(){this.state="list",this.$edit.hide(),this.$list.show(),this.enable()},showEdit:function(i,a){var n=this,r=this.state;this.state="edit",this.$edit.find(".add-only, .pass-only").hide(),this.$edit.find(".edit-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error");var o,l,h=i?t(i.currentTarget):null;"pass"!==r?(o=h?h.data("id"):a,l=e.model.selectedOperator=e.model.chat.getOperator(o)):(l=e.model.selectedOperator,o=l.id),this.$edit.find(".customer-chat-tabs-header").html(this.user.get("id")===a?e.service.i18n.trans("edit.profile"):e.service.i18n.trans("edit.operator")),l&&(this.$edit.find("#usernameField").val(l.name),this.$edit.find("#mailField").val(l.mail),l.image&&n.setEditAvatarIcon(this.$edit,l.image));var d=e.view.dialogs;this.$avatarInput.unbind("change").change(function(){var t=new AjaxUploader({url:s.uploadAvatarPath,input:n.$avatarInput[0],filesField:"avatar",data:{userId:o}});t.on("load",function(t){d.message(e.service.i18n.trans("avatar.uploaded"),e.service.i18n.trans("uploaded.success")),l.image=JSON.parse(t).image,n.model.saveOperator(l),n.setEditAvatarIcon(n.$edit,l.image)}),t.upload(),d.message(e.service.i18n.trans("uploading"),e.service.i18n.trans("uploading.image"))}),this.$list.hide(),this.$edit.show(),this.updateDepartments()},deleteOperator:function(i){var s=t(i.currentTarget),a=e.model.chat.getOperator(s.data("id")),n=this,r={};r[e.service.i18n.trans("remove.user").replace("%user%",a.name)]=function(){n.model.deleteOperator(a),t(this).dialog("close"),t(window).trigger("resize")},e.view.dialogs.confirm((e.service.i18n.trans("remove.user")+"?").replace("%user%",a.name),e.service.i18n.trans("remove.user.q"),r)},showAdd:function(){this.state="add",this.$edit.find(".customer-chat-tabs-header").html(e.service.i18n.trans("add.new.operator")),this.$edit.find(".edit-only, .pass-only").hide(),this.$edit.find(".add-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error"),e.model.selectedOperator={roles:["OPERATOR"]},this.$edit.find("#usernameField").val(""),this.$edit.find("#mailField").val(""),this.$edit.find("#passField").val(""),this.$edit.find("#rePassField").val(""),this.$list.hide(),this.$edit.show(),this.updateDepartments()},showChangePassword:function(){this.state="pass",this.$edit.find(".customer-chat-tabs-header").html("Change password"),this.$edit.find(".edit-only, .add-only").hide(),this.$edit.find(".pass-only").show(),this.user.hasRole("ADMIN")&&this.$edit.find(".current-pass").hide(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error"),this.$edit.find("#changePassCurrentField").val(""),this.$edit.find("#changePassField").val(""),this.$edit.find("#changePassRetypeField").val(""),this.$list.hide(),this.$edit.show()},selectAvatar:function(){var i=this,a=new e.SelectAvatarView({model:s.defaultAvatars});e.view.dialogs.confirm(e.service.i18n.trans("select.avatar"),a,{OK:function(){var s=t(this),n=a.selected;if(s.dialog("close"),n){var r=e.model.selectedOperator;r.image=n,i.model.saveOperator(r),i.setEditAvatarIcon(i.$edit,r.image)}}})},save:function(){if(this.isEditValid()&&!this.syncing){this.disable();var t=e.model.selectedOperator;if(t){"edit"==this.state||"add"==this.state?(t.name=this.$edit.find("#usernameField").val(),t.mail=this.$edit.find("#mailField").val(),t.password=this.$edit.find("#passField").val(),this.departmentsList&&(t.departments=this.departmentsList.selected)):"pass"==this.state&&(t.currPassword=this.$edit.find("#changePassCurrentField").val(),t.password=this.$edit.find("#changePassField").val());var s=this;e.model.chat.once("operator:saved",function(e){s.enable(),s.user.hasRole("ADMIN")?s.showList():s.showEdit()}),e.model.chat.once("operator:saveError",function(t){s.enable(),e.view.dialogs.formError(e.service.i18n.trans("form.error"),i.values(t))}),this.model.saveOperator(t),e.model.departments.fetch()}else this.enable()}},disable:function(){this.syncing=!0,this.$save.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var e=this;setTimeout(function(){e.$save.removeClass("button-disabled"),e.$loading.fadeOut(),e.syncing=!1,"add"==e.state&&e.showList()},500);
},validateEdit:function(i,s){function a(e,t){if(e.addClass("customer-chat-input-error"),e.data("validator-msg")!==!1){var i=e.data("validator-label");i&&(t=i+": "+t),n.errors.push(t)}else n.errors.push(!1)}this.errors=!1;var n=this,r=s?this.$editInputs:t(i.target);if(!s){var o=t(i.target).data("validator-match");o&&(r=r.add(n.$el.find("#"+o)))}n.errors=[],r.each(function(){var i=t(this),s=i.data("validator-state"),r=i.data("validator-state-ex");if(!(s&&s!==n.state||r&&r===n.state)){switch(i.removeClass("customer-chat-input-error"),i.data("validator")){case"mail":0!=i.val().length&&n.mailExp.test(i.val())||a(i,e.service.i18n.trans("enter.valid.mail"));break;case"notEmpty":0==i.val().length&&a(i,e.service.i18n.trans("v.cant.be.empty"));break;case"password":i.val().length<6&&a(i,e.service.i18n.trans("pass.need.6.chars"))}var o=i.data("validator-match");if(o){var l=n.$el.find("#"+o);i.val()!==l.val()&&a(i,e.service.i18n.trans("pass.have.to.match"))}}}),s&&this.errors.length>0&&e.view.dialogs.formError(e.service.i18n.trans("form.error"),this.errors)},isEditValid:function(){return this.validateEdit(null,!0),0===this.errors.length},updateDepartments:function(){this.departmentsList&&("add"===this.state?this.departmentsList.selectNone():"edit"===this.state&&this.departmentsList.select(e.model.selectedOperator.departments))}})}(window.Application,jQuery,_,window.chatConfig),function(e,t,i,s){e.CannedMessagesView=Backbone.View.extend({events:{"click #customer-chat-canned-messages-back":"showList","click #customer-chat-canned-messages-add":"showAdd","click .customer-chat-canned-messages-edit":"showEdit","click .customer-chat-canned-messages-remove":"deleteMessage","click #customer-chat-canned-messages-save":"save"},initialize:function(){this.model=e.model.cannedMessages,this.user=e.model.user,this.$el.html(e.template.cannedMessages()),this.$list=this.$("#customer-chat-canned-messages-list"),this.$messages=this.$list.find(".customer-chat-content-messages-wrapper"),this.$edit=this.$("#customer-chat-canned-messages-edit"),this.$save=this.$("#customer-chat-canned-messages-save"),this.$back=this.$("#customer-chat-canned-messages-back"),this.$editInputs=this.$edit.find("input"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$editInputs.blur(t.proxy(this.validateEdit,this)),this.model.on("change:messages",this.render,this),this.showList(),this.render()},render:function(){this.$messages.html("").append(i.map(this.model.get("messages"),function(t){return e.template.cannedMessageItem(t)}))},showList:function(){this.state="list",this.$edit.hide(),this.$list.show(),this.enable()},showEdit:function(i,s){this.state;this.state="edit",this.$edit.find(".add-only").hide(),this.$edit.find(".edit-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error");var a,n,r=i?t(i.currentTarget):null;a=r?r.data("id"):s,n=e.model.selectedMessage=this.model.getById(a),n&&(this.$edit.find("#messageNameField").val(n.name),this.$edit.find("#messageBodyField").val(n.body)),this.$list.hide(),this.$edit.show()},deleteMessage:function(i){var s=t(i.currentTarget),a=this.model.getById(s.data("id")),n=this,r={};r[e.service.i18n.trans("remove.msg").replace("%message%",a.name)]=function(){n.model.deleteMessage(a.id),t(this).dialog("close"),t(window).trigger("resize")},e.view.dialogs.confirm((e.service.i18n.trans("remove.msg")+"?").replace("%message%",a.name),e.service.i18n.trans("remove.msg.q"),r)},showAdd:function(){this.state="add",this.$edit.find(".customer-chat-tabs-header").html(e.service.i18n.trans("add.new.msg")),this.$edit.find(".edit-only, .pass-only").hide(),this.$edit.find(".add-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error"),e.model.selectedMessage={},this.$edit.find("#messageNameField").val(""),this.$edit.find("#messageBodyField").val(""),this.$list.hide(),this.$edit.show()},save:function(){if(this.isEditValid()&&!this.syncing){this.disable();var t=e.model.selectedMessage;if(t){t.name=this.$edit.find("#messageNameField").val(),t.body=this.$edit.find("#messageBodyField").val();var s=this;this.model.once("message:saved",function(e){s.enable(),s.showList()}),this.model.once("message:saveError",function(t){s.enable(),e.view.dialogs.formError(e.service.i18n.trans("form.error"),i.values(t))}),this.model.saveMessage(t)}else this.enable()}},disable:function(){this.syncing=!0,this.$save.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var e=this;setTimeout(function(){e.$save.removeClass("button-disabled"),e.$loading.fadeOut(),e.syncing=!1,"add"==e.state&&e.showList()},500)},validateEdit:function(i,s){function a(e,t){if(e.addClass("customer-chat-input-error"),e.data("validator-msg")!==!1){var i=e.data("validator-label");i&&(t=i+": "+t),n.errors.push(t)}else n.errors.push(!1)}this.errors=!1;var n=this,r=s?this.$editInputs:t(i.target);if(!s){var o=t(i.target).data("validator-match");o&&(r=r.add(n.$el.find("#"+o)))}n.errors=[],r.each(function(){var i=t(this),s=i.data("validator-state"),r=i.data("validator-state-ex");if(!(s&&s!==n.state||r&&r===n.state)){switch(i.removeClass("customer-chat-input-error"),i.data("validator")){case"notEmpty":0==i.val().length&&a(i,e.service.i18n.trans("v.cant.be.empty"))}var o=i.data("validator-match");if(o){var l=n.$el.find("#"+o);i.val()!==l.val()&&a(i,e.service.i18n.trans("pass.have.to.match"))}}}),s&&this.errors.length>0&&e.view.dialogs.formError(e.service.i18n.trans("form.error"),this.errors)},isEditValid:function(){return this.validateEdit(null,!0),0===this.errors.length}})}(window.Application,jQuery,_,window.chatConfig),function(e,t,i){e.BlacklistView=Backbone.View.extend({events:{"click .save":"save"},syncing:!1,initialize:function(){this.$el.html(e.template.blacklist()),this.$input=this.$("textarea"),this.$save=this.$(".save"),this.$loading=this.$(".customer-chat-content-loading-icon").hide()},disable:function(){this.syncing=!0,this.$save.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var e=this;setTimeout(function(){e.$save.removeClass("button-disabled"),e.$loading.fadeOut(),e.syncing=!1},500)},save:function(){this.disable(),i.post(t.updateBlacklistPath,{contents:this.$input.val()},i.proxy(function(t){t.success||e.view.dialogs.message(e.service.i18n.trans("error"),e.service.i18n.trans("error.saving.file")),this.enable()},this))}})}(window.Application,window.chatConfig,jQuery),function(e,t,i){e.WidgetCodeView=Backbone.View.extend({render:function(){this.$el.html(e.template.widgetCodeContent({src:t.widgetInitPath,srcInline:t.widgetInitInlinePath}));var i=new e.TabsView({el:this.$(".widget-code")});return i.$el.show(),this}})}(window.Application,chatConfig,jQuery),function(e,t,i){e.SelectAvatarView=Backbone.View.extend({events:{"mousedown .customer-chat-content-message-avatar":"selectAvatar"},render:function(){return this.$el.html(e.template.selectAvatarContent({urls:this.model})),this.$avatars=this.$(".avatars"),this.$el.find(".avatars-wrapper").mCustomScrollbar(),i(window).resize(),this},selectAvatar:function(e){var t=i(e.currentTarget),s=t.data("image");this.$avatars.children().removeClass("selected"),t.addClass("selected"),this.selected=s}})}(window.Application,chatConfig,jQuery),function(e,t,i){var s=e.SelectCannedMessageView=Backbone.View.extend({events:{"mousedown .customer-chat-content-canned-message":"selectMessage"},templateHelpers:{displayBody:function(e){return e.length>s.DISPLAY_BODY_MAX_LENGTH&&(e=e.slice(0,s.DISPLAY_BODY_MAX_LENGTH)+"..."),e},displayName:function(e){return e.length>s.DISPLAY_NAME_MAX_LENGTH&&(e=e.slice(0,s.DISPLAY_NAME_MAX_LENGTH)+"..."),e}},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){for(var t=JSON.parse(JSON.stringify(this.model.get("messages"))),s=0;s<t.length;s++)t[s].body=this.model.getParametrizedMessage(t[s].body);return this.$el.html(e.template.selectCannedMessageContent({messages:t},{helpers:this.templateHelpers})),this.$messages=this.$(".messages"),this.$el.find(".canned-messages-wrapper").mCustomScrollbar(),i(window).resize(),this},selectMessage:function(e){var t=i(e.currentTarget),s=t.data("message");this.$messages.children().removeClass("selected"),t.addClass("selected"),this.selected=s}},{DISPLAY_NAME_MAX_LENGTH:50,DISPLAY_BODY_MAX_LENGTH:100})}(window.Application,chatConfig,jQuery),function(e,t,i){var s=e.SelectUserView=Backbone.View.extend({events:{"mousedown .user-item":"selectUser"},templateHelpers:{displayName:function(){var e=this.get("name");return e.length>s.DISPLAY_NAME_MAX_LENGTH&&(e=e.slice(0,s.DISPLAY_NAME_MAX_LENGTH)+"..."),e},displayMail:function(){var e=this.get("mail");return e.length>s.DISPLAY_MAIL_MAX_LENGTH&&(e=e.slice(0,s.DISPLAY_MAIL_MAX_LENGTH)+"..."),e},isSelected:function(e){var t=e.data.root.selected,i=t&&t.get("id");return this.get("id")==i?new Handlebars.SafeString(e.fn(this)):""}},initialize:function(){this.filter=this.options.filter,this.listenTo(this.model,"users:online",this.render)},render:function(){return this.users=this.model.onlineUsers,this.filter&&(this.users=_.filter(this.users,this.filter)),this.$el.html(e.template.selectUserContent({users:this.users,selected:this.selected},{helpers:this.templateHelpers})),this.$users=this.$(".users"),this.$el.find(".canned-messages-wrapper").mCustomScrollbar(),i(window).resize(),this},selectUser:function(e){var t=i(e.currentTarget),s=this.users[t.index()];this.$users.children().removeClass("selected"),t.addClass("selected"),this.selected=s}},{DISPLAY_NAME_MAX_LENGTH:32,DISPLAY_MAIL_MAX_LENGTH:64})}(window.Application,chatConfig,jQuery),function(e,t,i){e.SelectListView=Backbone.View.extend({events:{"click .entry-item":"toggleEntry","click .select-all":"selectAll","click .select-none":"selectNone"},initialize:function(){if(this.selected=[],this.dataProvider=this.options.dataProvider,this.getLabel=this.options.getLabel,this.options.iconActive=this.options.iconActive||"check-square-o",this.options.iconInactive=this.options.iconInactive||"square-o",this.options.styleItem){var e=i.proxy(this.styleItem,this),t=i.proxy(this.options.styleItem,this);this.styleItem=function(i,s,a){e(i,s,a),t(i,s,a)}}this.listenTo(this.model,this.options.renderEvent,this.render),this.options.readOnly&&(this.$el.addClass("read-only"),setTimeout(i.proxy(this.undelegateEvents,this),0));var s=this;this.options.noScroll||setInterval(function(){s.$el.find(".entries").mCustomScrollbar("update")},500),this.render()},render:function(){var t=this.dataProvider();this.$el.html(e.template.selectListContent({actions:!(this.options.readOnly||this.options.single)})),0===t.length?this.$el.addClass("empty"):this.$el.removeClass("empty"),this.$entries=this.$(".entries");for(var s=0;s<t.length;s++){var a=t[s],n=parseInt(a.id),r=i('<a class="entry-item"></a>'),o=(a.name,a.mail,i("<i>").addClass("fa"));this.options.readOnly||r.append(o),r.append(this.getLabel(a)).data("entryId",n).data("entry",a),this.styleItem(r,o,this.isSelected(n)),this.$entries.append(r)}return this.options.noScroll||this.$el.find(".entries").mCustomScrollbar(),this},toggleEntry:function(e){var t=i(e.currentTarget);if(!t.hasClass("disabled")){var s=t.data("entryId"),a=this.selected.indexOf(s),n=t.find(".fa");this.options.single?(this.selectNone(!0),this.selected=[s],this.styleItem(t,n,!0)):a!==-1?(this.selected.splice(a,1),this.styleItem(t,n,!1)):(this.selected.push(s),this.styleItem(t,n,!0)),this.trigger("updateSelection")}},select:function(e){0===e.length&&this.options.selectedOnly&&this.$el.addClass("empty"),this.selected=[];var t=this;this.$entries.find("a").each(function(){var s=i(this),a=s.data("entryId"),n=s.find(".fa");e.indexOf(a)!==-1?(t.selected.push(a),t.styleItem(s,n,!0),t.options.selectedOnly&&s.show()):(t.styleItem(s,n,!1),t.options.selectedOnly&&s.hide())}),this.trigger("updateSelection")},selectAll:function(e){this.selected=[];var t=this;this.$entries.find("a").each(function(){var e=i(this),s=e.data("entryId"),a=e.find(".fa");t.selected.push(s),t.styleItem(e,a,!0)}),e||this.trigger("updateSelection")},selectNone:function(e){this.selected=[];var t=this;this.$entries.find("a").each(function(){var e=i(this),s=e.find(".fa");t.styleItem(e,s,!1)}),e||this.trigger("updateSelection")},isSelected:function(e){return this.selected.indexOf(e)!==-1},styleItem:function(e,t,i){i?(e.addClass("active"),t.removeClass("fa-"+this.options.iconInactive).addClass("fa-"+this.options.iconActive)):(e.removeClass("active"),t.removeClass("fa-"+this.options.iconActive).addClass("fa-"+this.options.iconInactive))},clearItemStyle:function(e,t){t.removeClass("fa-"+this.options.iconActive).removeClass("fa-"+this.options.iconInactive)}})}(window.Application,chatConfig,jQuery),function(e,t,i,s){e.DepartmentsView=Backbone.View.extend({events:{"click #customer-chat-departments-back":"showList","click #customer-chat-departments-add":"showAdd","click .customer-chat-departments-edit":"showEdit","click .customer-chat-departments-remove":"deleteDepartment","click #customer-chat-departments-save":"save"},initialize:function(){this.model=e.model.departments,this.user=e.model.user,this.chat=e.model.chat,this.chat.loadOperators(),this.$el.html(e.template.departments()),this.$list=this.$("#customer-chat-departments-list"),this.$departments=this.$list.find(".customer-chat-content-departments-wrapper"),this.$edit=this.$("#customer-chat-departments-edit"),this.$save=this.$("#customer-chat-departments-save"),this.$back=this.$("#customer-chat-departments-back"),this.$editInputs=this.$edit.find("input"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$editInputs.blur(t.proxy(this.validateEdit,this)),this.operatorsList=new e.SelectListView({el:this.$(".select-list"),model:this.chat,renderEvent:"change:operators",noScroll:!0,dataProvider:function(){return e.model.chat.getOperators()},getLabel:function(e){return"<b>"+e.name+"</b> (<i>"+e.mail+"</i>)"}}),this.model.on("change:departments",this.render,this),this.showList(),this.render()},render:function(){this.$departments.html("").append(i.map(this.model.get("departments"),function(t){return e.template.departmentItem(t)}))},showList:function(){this.state="list",this.$edit.hide(),this.$list.show(),this.enable()},showEdit:function(i,s){this.state;this.state="edit",this.$edit.find(".add-only").hide(),this.$edit.find(".edit-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error");var a,n,r=i?t(i.currentTarget):null;a=r?r.data("id"):s,n=e.model.selectedDepartment=this.model.getById(a),n&&(this.$edit.find("#departmentNameField").val(n.name),this.$edit.find("#departmentDescriptionField").val(n.description)),this.$list.hide(),this.$edit.show(),this.updateOperators()},deleteDepartment:function(i){var s=t(i.currentTarget),a=this.model.getById(s.data("id")),n=this,r={};r[e.service.i18n.trans("remove.dep").replace("%department%",a.name)]=function(){n.model.deleteDepartment(a.id),t(this).dialog("close"),t(window).trigger("resize")},e.view.dialogs.confirm((e.service.i18n.trans("remove.dep")+"?").replace("%department%",a.name),e.service.i18n.trans("remove.dep.q"),r)},showAdd:function(){this.state="add",this.$edit.find(".customer-chat-tabs-header").html(e.service.i18n.trans("add.new.dep")),this.$edit.find(".edit-only, .pass-only").hide(),this.$edit.find(".add-only").show(),this.$edit.find(".customer-chat-input-error").removeClass("customer-chat-input-error"),e.model.selectedDepartment={},this.$edit.find("#departmentNameField").val(""),this.$edit.find("#departmentDescriptionField").val(""),this.$list.hide(),this.$edit.show(),this.updateOperators()},save:function(){if(this.isEditValid()&&!this.syncing){this.disable();var t=e.model.selectedDepartment;if(t){t.name=this.$edit.find("#departmentNameField").val(),t.description=this.$edit.find("#departmentDescriptionField").val(),t.operators=this.operatorsList.selected;var s=this;this.model.once("department:saved",function(e){s.enable(),s.showList()}),this.model.once("department:saveError",function(t){s.enable(),e.view.dialogs.formError(e.service.i18n.trans("form.error"),i.values(t))}),this.model.saveDepartment(t),this.chat.loadOperators()}else this.enable()}},disable:function(){this.syncing=!0,this.$save.addClass("button-disabled"),this.$loading.fadeIn()},enable:function(){var e=this;setTimeout(function(){e.$save.removeClass("button-disabled"),e.$loading.fadeOut(),e.syncing=!1,"add"==e.state&&e.showList()},500)},validateEdit:function(i,s){function a(e,t){if(e.addClass("customer-chat-input-error"),e.data("validator-msg")!==!1){var i=e.data("validator-label");i&&(t=i+": "+t),n.errors.push(t)}else n.errors.push(!1)}this.errors=!1;var n=this,r=s?this.$editInputs:t(i.target);if(!s){var o=t(i.target).data("validator-match");o&&(r=r.add(n.$el.find("#"+o)))}n.errors=[],r.each(function(){var i=t(this),s=i.data("validator-state"),r=i.data("validator-state-ex");if(!(s&&s!==n.state||r&&r===n.state)){switch(i.removeClass("customer-chat-input-error"),i.data("validator")){case"notEmpty":0==i.val().length&&a(i,e.service.i18n.trans("v.cant.be.empty"))}var o=i.data("validator-match");if(o){var l=n.$el.find("#"+o);i.val()!==l.val()&&a(i,e.service.i18n.trans("pass.have.to.match"))}}}),s&&this.errors.length>0&&e.view.dialogs.formError(e.service.i18n.trans("form.error"),this.errors)},isEditValid:function(){return this.validateEdit(null,!0),0===this.errors.length},updateOperators:function(){"add"===this.state?this.operatorsList.selectNone():"edit"===this.state&&this.operatorsList.select(e.model.selectedDepartment.operators)}})}(window.Application,jQuery,_,window.chatConfig),function(e,t,i){e.TransferAndLeaveView=Backbone.View.extend({render:function(){return this.$el.html(e.template.transferAndLeaveContent()),this.selectUserView=new e.SelectUserView({el:this.$(".users"),model:this.model,filter:this.userFilter}).render(),this},userFilter:function(t){return t.hasRole("OPERATOR")&&t.get("id")!==e.model.user.get("id")}})}(window.Application,chatConfig,jQuery),function(e,t,i,s){var a=e.HistoryView=Backbone.View.extend({events:{"click #customer-chat-history-search":"search","click #customer-chat-history-clear":"clear","keydown input":"searchOnEnter","click .customer-chat-history-item":"showConversation","click .btn-mail-transcript":"mailTalkTranscript","click #history-list-display-more":"displayMoreResults"},templateHelpers:{displayDate:function(){var e=new Date(this.datetime.replace(/-/g,"/")),t=e.getDate()<10?"0"+e.getDate():e.getDate(),i=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,s=isNaN(e.getDay())?"":t+"."+i+"."+e.getFullYear();return s}},searching:!1,lastSearch:{items:[],displayed:0,query:{}},participantViews:null,initialize:function(){this.model=e.model.chat,this.$el.html(e.template.history()),this.$results=this.$("#customer-chat-history-search-results"),this.$inputs=this.$("*[name]"),this.$search=this.$("#customer-chat-history-search"),this.$clear=this.$("#customer-chat-history-clear"),this.$loading=this.$(".customer-chat-content-loading-icon").hide(),this.$resultItems=this.$("#customer-chat-history-search-results .customer-chat-content-messages-wrapper"),this.$displayMore=t(e.template.historyListDisplayMore()),this.$historyTalk=this.$(".customer-chat-history-chat"),this.$participantsScroller=this.$(".participants-scroller"),this.$participants=this.$(".customer-chat-talk-header-users .participants-content"),this.$headerDate=this.$("#customer-chat-talk-header .date-info"),this.participantViews=[],this.$(".date-input").datepicker(),this.$results.mCustomScrollbar(),this.$participantsScroller.mCustomScrollbar();var i=this.user=e.model.user;i.hasRole("ADMIN")||this.$clear.hide(),this.chatBoxView=new e.ChatBoxView({el:this.$("#history-results-chat"),model:new e.ChatViewModel,fullDate:!0}),this.model.on("change",this.render,this),this.model.on("request",this.disable,this),this.model.on("sync",this.enable,this),this.listenTo(e,"history.search",this.autoSearch),this.render()},search:function(){if(!this.searching){this.searching=!0,this.clearSearchResults();var e={offset:this.lastSearch.displayed,limit:a.RESULTS_DISPLAY_COUNT+1};this.$inputs.each(function(){var i=t(this);i.val()&&("checkbox"==i.attr("type")?e[i.attr("name")]=i.is(":checked")?"true":"false":e[i.attr("name")]=i.val())}),this.lastSearch.query=e,this.model.queryHistory(e,t.proxy(this.onQueryResults,this),t.proxy(this.onQueryError,this))}},searchOnEnter:function(e){13===e.which&&this.search()},clear:function(){var i=this,s={};s[e.service.i18n.trans("clear.messages")]=function(){i._clear(),t(this).dialog("close")},e.view.dialogs.confirm(e.service.i18n.trans("clear.history"),e.service.i18n.trans("clear.history.q"),s)},_clear:function(){this.chatBoxView.clear(),this.$historyTalk.hide(),this.clearSearchResults(),this.model.clearHistory(t.proxy(this.onClear,this),t.proxy(this.onClearError))},autoSearch:function(e){this.$inputs.each(function(){var i=t(this),s=i.attr("name");void 0!==typeof e[s]&&i.val(e[s])}),this.search()},onQueryError:function(){this.searching=!1},onQueryResults:function(e){this.searching=!1,this.prepareResults(e),this.lastSearch.items=this.lastSearch.items.concat(e),this.displayResults()},onClearError:function(){e.view.dialogs.message(e.service.i18n.trans("clear.history"),e.service.i18n.trans("clear.history.err"))},onClear:function(){e.view.dialogs.message(e.service.i18n.trans("clear.history"),e.service.i18n.trans("history.cleared"))},displayResults:function(){var e=this.lastSearch.items,i=this.lastSearch.displayed;if(i<e.length){var s=Math.max(0,Math.min(e.length,i+a.RESULTS_DISPLAY_COUNT));this.addSearchResults(e.slice(i,s),t.proxy(function(){e.length>s?this.$resultItems.append(this.$displayMore.show()):this.$displayMore.remove(),this.$results.mCustomScrollbar("update"),this.lastSearch.displayed=s},this))}},displayMoreResults:function(){this.lastSearch.query.offset=this.lastSearch.displayed,this.model.queryHistory(this.lastSearch.query,t.proxy(this.onQueryResults,this),t.proxy(this.onQueryError,this))},render:function(){return this},setSearchResults:function(e){this.clearSearchResults(),this.addSearchResults(e)},addSearchResults:function(t,i){for(var s=[],a=0;a<t.length;a++)for(var n=0;n<t[a].length;n++)s.indexOf(t[a][n].from_id)===-1&&s.push(t[a][n].from_id),s.indexOf(t[a][n].to_id)===-1&&s.push(t[a][n].to_id);var r=this;e.UserModel.getUsers(s,function(){for(var e=0;e<t.length;e++)r.addSearchResult(t[e]);i()})},clearSearchResults:function(){this.$resultItems.html(""),this.$results.mCustomScrollbar("update"),this.lastSearch.items=[],this.lastSearch.displayed=0,this.lastSearch.query={}},addSearchResult:function(s){this.model.addUserInfoToMessages(s,t.proxy(function(){var a=s[0],n=t(e.template.historyListItem(a,{helpers:this.templateHelpers}));this.model.getTalkParticipants(s,function(e){var t=i.map(e,function(e){return e.getReadableName()});t.length>0&&n.find(".customer-chat-history-item-username").html(t.join(", "))});var r=i.clone(new e.MessageModel(a).attributes);r.author=r.author+" ("+r.authorMail+")",n.data("info",s),this.$resultItems.append(n),this.$results.mCustomScrollbar("update")},this))},showConversation:function(i){this.chatBoxView.clear();var s=t(i.currentTarget),a=s.data("info");this.talkId=a[0].talk_id,a.sort(function(e,t){return e.datetime>t.datetime?1:-1});var n=new e.MessageModel(a[0]),r=new e.MessageModel(a[a.length-1]);this.model.getTalkParticipants(a,t.proxy(function(t){for(var i=this.participantViews.length;i--;)this.participantViews[i].remove();this.participantViews=[];for(var i=0;i<t.length;i++){var s=t[i],a=new e.ParticipantView({model:s});this.$participants.append(a.el),this.participantViews.push(a)}this.$headerDate.html(n.get("datetime")+" — "+r.get("datetime")),this.$historyTalk.show(),this.$participantsScroller.mCustomScrollbar("update")},this));for(var o=0;o<a.length;o++){var l=a[o],h=!1;l.info=l.from_user_info.info;var d=l.extra;if(d)switch(d.type){case e.MessageModel.EXTRA_TALK_START:h=!0}h||this.chatBoxView.addMessage(new e.MessageModel(l),!1,!0)}},mailTalkTranscript:function(){e.controller.actions.run("mailTalkTranscript",[this.talkId])},prepareResults:function(e){for(var t=0;t<e.length;t++){var i=e[t];i.roles&&i.roles.toLowerCase().indexOf("guest")!==-1&&(i.name=i.name.lastIndexOf("-")!==-1?i.name.slice(0,i.name.lastIndexOf("-")):i.name)}}},{RESULTS_DISPLAY_COUNT:20})}(window.Application,jQuery,_,window.chatConfig),function(e,t,i){var s=e.WindowView=Backbone.View.extend({initialize:function(){this.settings=e.model.settings;var i=this.user=e.model.user;i.hasRole("ADMIN")&&(this.settingsView=new e.SettingsView({el:this.$(".customer-chat-tab-content-settings-ui"),collection:e.model.uiSettings,tags:["general"]}),this.settingsView=new e.SettingsView({el:this.$(".customer-chat-tab-content-widget-theme"),collection:e.model.uiSettings,tags:["widget"]}),this.logsView=new e.LogsView({el:this.$("#customer-chat-admin-logs")}),this.blacklistView=new e.BlacklistView({el:this.$("#customer-chat-pages-list")}),this.DepartmentsView=new e.DepartmentsView({el:this.$("#customer-chat-departments-tab")}),this.cannedMessagesView=new e.CannedMessagesView({el:this.$("#customer-chat-canned-messages-tab")})),this.chatTabView=new e.ChatTabView({el:this.$("#customer-chat-admin-chat")}),this.mapView=new e.MapView({el:this.$("#customer-chat-admin-map")}),this.qrCodeView=new e.QRCodeView({el:this.$("#customer-chat-admin-qr")}),this.operatorsView=new e.OperatorsView({el:this.$("#customer-chat-operators-tab")}),this.historyView=new e.HistoryView({el:this.$("#customer-chat-history")}),this.tabsView=new e.TabsView({el:this.$("#customer-chat-admin-settings")}),this.menuView=new e.MenuView({el:this.el,windowView:this}),i.hasRole("ADMIN")||(this.tabsView.removeTabByTag("departments"),this.tabsView.removeTabByTag("settings"),this.tabsView.removeTabByTag("widget-theme"),this.tabsView.removeTabByTag("canned-messages"),this.tabsView.removeTabByTag("blacklist"),this.$(".customer-chat-tab-button.operators span").html(e.service.i18n.trans("edit.profile"))),this.user.hasRole("OPERATOR")&&(this.titleText=document.title,this.listenTo(this.chatTabView,"talks.read",this.stopMsgIndicator),this.listenTo(this.chatTabView,"talks.unread",this.startMsgIndicator)),this.$("#customer-chat-admin-settings .customer-chat-content-messages").bind("show",function(){t(window).trigger("resize")}).not("#customer-chat-history .customer-chat-content-messages").mCustomScrollbar(),window.alert=function(t){e.view.dialogs.message(e.service.i18n.trans("alert"),t)},setTimeout(t.proxy(this.checkInstall,this),0),this.listenTo(e,"history.search",this.showHistory)},showHistory:function(){this.menuView.showSettings(),this.tabsView.showTab(this.user.hasRole("OPERATOR")?2:4)},startMsgIndicator:function(){this.msgIndicatorTimer||(this.msgIndicatorTimer=setInterval(t.proxy(this.indicateMsg,this),s.MSG_INDICATOR_INTERVAL))},stopMsgIndicator:function(){this.msgIndicatorTimer&&(clearInterval(this.msgIndicatorTimer),document.title=this.titleText,delete this.msgIndicatorTimer),e.service.notify.closeAll()},indicateMsg:function(){document.title="!"!==document.title?"!":this.titleText},checkInstall:function(){if(!i.installStatus.validConfig||!i.installStatus.validDb)if(e.model.user.hasRole("ADMIN")){var t={};t[e.service.i18n.trans("edit.config")]=function(){(document.location||window.location).href=i.installWizardPath},e.view.dialogs.confirm(e.service.i18n.trans("incorrect.install"),e.template.invalidInstallDialogContent(),t)}else e.view.dialogs.message(e.service.i18n.trans("please.install"),e.service.i18n.trans("not.installed.msg"));if(!i.ui.installed)if(e.model.user.hasRole("ADMIN")){var t={};t[e.service.i18n.trans("install")]=function(){(document.location||window.location).href=i.installPath},e.view.dialogs.confirm(e.service.i18n.trans("install"),e.template.installDialogContent(),t)}else e.view.dialogs.message(e.service.i18n.trans("please.install"),e.service.i18n.trans("not.installed.msg"))}},{MSG_INDICATOR_INTERVAL:1e3})}(window.Application,jQuery,window.chatConfig),function(e,t,i){e.DialogsView=Backbone.View.extend({initialize:function(){this.$confirm=t(e.template.confirmDialog()),this.$formError=t(e.template.formErrorDialog())},confirm:function(i,s,a,n){this._createBody(this.$confirm,s),a[e.service.i18n.trans("cancel")]||(a[e.service.i18n.trans("cancel")]=function(){t(this).dialog("close")}),this.$confirm.dialog({title:i,resizable:!1,modal:!0,width:n?n:400,maxWidth:900,height:"auto",buttons:a,show:"fade",position:{of:e.view.window.$el}})},formError:function(i,s){this.$formError.html("");for(var a=0;a<s.length;a++){var n=t("<p>"),r=s[a];r&&r.length>0&&n.html(s[a]),this.$formError.append(n)}var o={};o[e.service.i18n.trans("close")]=function(){t(this).dialog("close")},this.$formError.dialog({title:i,resizable:!1,modal:!0,width:400,height:"auto",buttons:o,show:"fade",position:{of:e.view.window.$el}})},message:function(i,s,a,n){this._createBody(this.$formError,s);var r={};r[e.service.i18n.trans("close")]=function(){t(this).dialog("close")},this.$formError.dialog({title:i,resizable:!1,modal:!0,width:a?a:400,height:n?n:"auto",buttons:r,show:"fade",position:{of:e.view.window.$el}})},_createBody:function(e,t){t&&(t instanceof Backbone.View?e.html("").append(t.render().el):e.html("<p>"+t+"</p>"))}})}(window.Application,jQuery,window.chatConfig),function(e,t,i){e.UserInfoPopoverView=Backbone.View.extend({initialize:function(t){var s=i(t.button);s.popover({placement:"right",trigger:"manual",container:"body",title:e.service.i18n.trans("user.info"),html:!0,content:this.render().$el}).mouseenter(function(){var e=i(this);i("body > .popover").remove(),e.popover("show");var t=i("body > .popover");e.add(t).bind("mouseleave",function(){setTimeout(function(){t.underMouse()||t.remove()},250)})})},render:function(){var t=this.model.has("info")?this.model.get("info"):{};return this.$el.html(e.template.userInfoPopoverContent({name:this.model.getReadableName(),id:this.model.get("author")||this.model.get("name"),mail:this.model.get("authorMail")||this.model.get("mail"),image:this.model.fromUser&&this.model.fromUser.image||this.model.get("image"),ip:t.ip,referer:t.referer})),this}})}(window.Application,chatConfig,jQuery),jQuery(function(e){var t=window.Application;t.config(window.chatConfig),t.on("start",function(){this.service.soundPlayer=new this.SoundPlayer,this.service.notify=new this.Notify,this.service.qrCode=new this.QR,this.service.notify.requestPermission(),this.model.watchedUploads=new this.WatchedUploadsCollection,this.model.user=new this.UserModel(window.userData),this.model.uiSettings=new this.UISettingsModel,this.model.logs=new this.LogsModel,this.model.departments=new this.DepartmentsModel,this.model.cannedMessages=new this.CannedMessagesModel,this.model.settings=new this.AdminSettingsModel,this.model.chat=new this.AdminChatModel,this.model.chat.on("users:online",e.proxy(this.UserModel.updateUsersCache,this.UserModel)),this.model.user.listenTo(this.model.chat,"operator:saved",function(e){e.id===this.get("id")&&this.set(e)}),this.controller.actions=new this.ActionController,this.view.dialogs=new this.DialogsView,this.view.window=new this.WindowView({el:"#customer-chat",model:this.model.chat})}),t.start()});